import { gettext } from '@c8y/ngx-components';
import { getStatus } from './map.model';
export class ClusterMap {
    constructor(iterable, addAssetCallback, translateService) {
        this.iterable = iterable;
        this.addAssetCallback = addAssetCallback;
        this.translateService = translateService;
        this.markers = [];
        this.positions = [];
        this.iterableDiffer = this.iterable.find(this.positions).create(this.trackBy);
    }
    set clusterMarker(item) {
        this.removeClusterToBigMarker();
        this._clusterMarker = item;
    }
    get clusterMarker() {
        return this._clusterMarker;
    }
    set rect(item) {
        if (this._rect) {
            this._rect.remove();
        }
        this._rect = item;
    }
    get rect() {
        return this._rect;
    }
    render(map) {
        if (this._rect) {
            this._rect.addTo(map);
        }
        this.updateChanges(map);
        if (this._clusterMarker) {
            this._clusterMarker.addTo(map);
        }
    }
    clear(map) {
        this.removeClusterToBigMarker();
        this._rect.remove();
        this.positions = [];
        this.updateChanges(map);
    }
    removeClusterToBigMarker() {
        if (this._clusterMarker) {
            this._clusterMarker.remove();
            this._clusterMarker = null;
        }
    }
    addMarkerToMap(device, map) {
        const marker = this.addAssetCallback(device);
        this.markers.push(marker);
        marker.addTo(map);
    }
    setClusterToBigMarker(map, count, leaflet) {
        const bound = this.rect.getBounds();
        const text = this.translateService.instant(gettext('Zoom in'));
        const divMarker = leaflet.divIcon({
            html: `<div class="c8y-map-marker-count" data-count="${count}" title="${text}"></div>`
        });
        const labelIcon = leaflet.marker(bound.getCenter(), {
            icon: divMarker
        });
        labelIcon.addTo(map);
        labelIcon.on('click', () => {
            map.fitBounds(bound);
        });
        this.clusterMarker = labelIcon;
    }
    updateChanges(map) {
        const changes = this.iterableDiffer.diff(this.positions);
        if (changes) {
            changes.forEachRemovedItem((record) => {
                this.removeMarkerFromMap(record.item);
            });
            changes.forEachAddedItem((record) => {
                this.addMarkerToMap(record.item, map);
            });
        }
    }
    trackBy(index, item) {
        const trackItems = [item.id, item.c8y_Position.lat, item.c8y_Position.lng, getStatus(item)];
        return trackItems.join('');
    }
    removeMarkerFromMap(device) {
        const markers = this.markers.filter((marker) => marker.asset?.id === device.id);
        markers.forEach(marker => marker.remove());
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2x1c3Rlci1tYXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9tYXAvY2x1c3Rlci1tYXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0EsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzlDLE9BQU8sRUFBYSxTQUFTLEVBQXlCLE1BQU0sYUFBYSxDQUFDO0FBRTFFLE1BQU0sT0FBTyxVQUFVO0lBNEJyQixZQUNVLFFBQXlCLEVBQ3pCLGdCQUE2RCxFQUM3RCxnQkFBa0M7UUFGbEMsYUFBUSxHQUFSLFFBQVEsQ0FBaUI7UUFDekIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUE2QztRQUM3RCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBOUI1QyxZQUFPLEdBQWdCLEVBQUUsQ0FBQztRQUMxQixjQUFTLEdBQTRCLEVBQUUsQ0FBQztRQStCdEMsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNoRixDQUFDO0lBOUJELElBQUksYUFBYSxDQUFDLElBQWE7UUFDN0IsSUFBSSxDQUFDLHdCQUF3QixFQUFFLENBQUM7UUFDaEMsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7SUFDN0IsQ0FBQztJQUVELElBQUksYUFBYTtRQUNmLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUM3QixDQUFDO0lBRUQsSUFBSSxJQUFJLENBQUMsSUFBaUI7UUFDeEIsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2QsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUNyQjtRQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxJQUFJLElBQUk7UUFDTixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFD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RSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM1RixPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVPLG1CQUFtQixDQUFDLE1BQTZCO1FBQ3ZELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBaUIsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxFQUFFLEtBQUssTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzNGLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUM3QyxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJdGVyYWJsZUNoYW5nZVJlY29yZCwgSXRlcmFibGVEaWZmZXIsIEl0ZXJhYmxlRGlmZmVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHR5cGUgKiBhcyBMIGZyb20gJ2xlYWZsZXQnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgQzh5TWFya2VyLCBnZXRTdGF0dXMsIFBvc2l0aW9uTWFuYWdlZE9iamVjdCB9IGZyb20gJy4vbWFwLm1vZGVsJztcblxuZXhwb3J0IGNsYXNzIENsdXN0ZXJNYXAge1xuICBtYXJrZXJzOiBDOHlNYXJrZXJbXSA9IFtdO1xuICBwb3NpdGlvbnM6IFBvc2l0aW9uTWFuYWdlZE9iamVjdFtdID0gW107XG5cbiAgc2V0IGNsdXN0ZXJNYXJrZXIoaXRlbTogTC5MYXllcikge1xuICAgIHRoaXMucmVtb3ZlQ2x1c3RlclRvQmlnTWFya2VyKCk7XG4gICAgdGhpcy5fY2x1c3Rlck1hcmtlciA9IGl0ZW07XG4gIH1cblxuICBnZXQgY2x1c3Rlck1hcmtlcigpIHtcbiAgICByZXR1cm4gdGhpcy5fY2x1c3Rlck1hcmtlcjtcbiAgfVxuXG4gIHNldCByZWN0KGl0ZW06IEwuUmVjdGFuZ2xlKSB7XG4gICAgaWYgKHRoaXMuX3JlY3QpIHtcbiAgICAgIHRoaXMuX3JlY3QucmVtb3ZlKCk7XG4gICAgfVxuICAgIHRoaXMuX3JlY3QgPSBpdGVtO1xuICB9XG5cbiAgZ2V0IHJlY3QoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY3Q7XG4gIH1cblxuICBwcml2YXRlIF9jbHVzdGVyTWFya2VyOiBMLkxheWVyO1xuICBwcml2YXRlIF9yZWN0OiBMLlJlY3RhbmdsZTtcbiAgcHJpdmF0ZSBpdGVyYWJsZURpZmZlcjogSXRlcmFibGVEaWZmZXI8UG9zaXRpb25NYW5hZ2VkT2JqZWN0PiB8IG51bGw7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpdGVyYWJsZTogSXRlcmFibGVEaWZmZXJzLFxuICAgIHByaXZhdGUgYWRkQXNzZXRDYWxsYmFjazogKGFzc2V0OiBQb3NpdGlvbk1hbmFnZWRPYmplY3QpID0+IEM4eU1hcmtlcixcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5pdGVyYWJsZURpZmZlciA9IHRoaXMuaXRlcmFibGUuZmluZCh0aGlzLnBvc2l0aW9ucykuY3JlYXRlKHRoaXMudHJhY2tCeSk7XG4gIH1cblxuICByZW5kZXIobWFwOiBMLk1hcCkge1xuICAgIGlmICh0aGlzLl9yZWN0KSB7XG4gICAgICB0aGlzLl9yZWN0LmFkZFRvKG1hcCk7XG4gICAgfVxuICAgIHRoaXMudXBkYXRlQ2hhbmdlcyhtYXApO1xuICAgIGlmICh0aGlzLl9jbHVzdGVyTWFya2VyKSB7XG4gICAgICB0aGlzLl9jbHVzdGVyTWFya2VyLmFkZFRvKG1hcCk7XG4gICAgfVxuICB9XG5cbiAgY2xlYXIobWFwOiBMLk1hcCkge1xuICAgIHRoaXMucmVtb3ZlQ2x1c3RlclRvQmlnTWFya2VyKCk7XG4gICAgdGhpcy5fcmVjdC5yZW1vdmUoKTtcbiAgICB0aGlzLnBvc2l0aW9ucyA9IFtdO1xuICAgIHRoaXMudXBkYXRlQ2hhbmdlcyhtYXApO1xuICB9XG5cbiAgcmVtb3ZlQ2x1c3RlclRvQmlnTWFya2VyKCkge1xuICAgIGlmICh0aGlzLl9jbHVzdGVyTWFya2VyKSB7XG4gICAgICB0aGlzLl9jbHVzdGVyTWFya2VyLnJlbW92ZSgpO1xuICAgICAgdGhpcy5fY2x1c3Rlck1hcmtlciA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgYWRkTWFya2VyVG9NYXAoZGV2aWNlOiBQb3NpdGlvbk1hbmFnZWRPYmplY3QsIG1hcDogTC5NYXApIHtcbiAgICBjb25zdCBtYXJrZXIgPSB0aGlzLmFkZEFzc2V0Q2FsbGJhY2soZGV2aWNlKTtcbiAgICB0aGlzLm1hcmtlcnMucHVzaChtYXJrZXIpO1xuICAgIG1hcmtlci5hZGRUbyhtYXApO1xuICB9XG5cbiAgc2V0Q2x1c3RlclRvQmlnTWFya2VyKG1hcDogTC5NYXAsIGNvdW50LCBsZWFmbGV0OiB0eXBlb2YgTCkge1xuICAgIGNvbnN0IGJvdW5kID0gdGhpcy5yZWN0LmdldEJvdW5kcygpO1xuICAgIGNvbnN0IHRleHQgPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudChnZXR0ZXh0KCdab29tIGluJykpO1xuICAgIGNvbnN0IGRpdk1hcmtlciA9IGxlYWZsZXQuZGl2SWNvbih7XG4gICAgICBodG1sOiBgPGRpdiBjbGFzcz1cImM4eS1tYXAtbWFya2VyLWNvdW50XCIgZGF0YS1jb3VudD1cIiR7Y291bnR9XCIgdGl0bGU9XCIke3RleHR9XCI+PC9kaXY+YFxuICAgIH0pO1xuICAgIGNvbnN0IGxhYmVsSWNvbiA9IGxlYWZsZXQubWFya2VyKGJvdW5kLmdldENlbnRlcigpLCB7XG4gICAgICBpY29uOiBkaXZNYXJrZXJcbiAgICB9KTtcbiAgICBsYWJlbEljb24uYWRkVG8obWFwKTtcbiAgICBsYWJlbEljb24ub24oJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgbWFwLmZpdEJvdW5kcyhib3VuZCk7XG4gICAgfSk7XG4gICAgdGhpcy5jbHVzdGVyTWFya2VyID0gbGFiZWxJY29uO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVDaGFuZ2VzKG1hcDogTC5NYXApIHtcbiAgICBjb25zdCBjaGFuZ2VzID0gdGhpcy5pdGVyYWJsZURpZmZlci5kaWZmKHRoaXMucG9zaXRpb25zKTtcbiAgICBpZiAoY2hhbmdlcykge1xuICAgICAgY2hhbmdlcy5mb3JFYWNoUmVtb3ZlZEl0ZW0oKHJlY29yZDogSXRlcmFibGVDaGFuZ2VSZWNvcmQ8UG9zaXRpb25NYW5hZ2VkT2JqZWN0PikgPT4ge1xuICAgICAgICB0aGlzLnJlbW92ZU1hcmtlckZyb21NYXAocmVjb3JkLml0ZW0pO1xuICAgICAgfSk7XG5cbiAgICAgIGNoYW5nZXMuZm9yRWFjaEFkZGVkSXRlbSgocmVjb3JkOiBJdGVyYWJsZUNoYW5nZVJlY29yZDxQb3NpdGlvbk1hbmFnZWRPYmplY3Q+KSA9PiB7XG4gICAgICAgIHRoaXMuYWRkTWFya2VyVG9NYXAocmVjb3JkLml0ZW0sIG1hcCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHRyYWNrQnkoaW5kZXg6IG51bWJlciwgaXRlbTogUG9zaXRpb25NYW5hZ2VkT2JqZWN0KSB7XG4gICAgY29uc3QgdHJhY2tJdGVtcyA9IFtpdGVtLmlkLCBpdGVtLmM4eV9Qb3NpdGlvbi5sYXQsIGl0ZW0uYzh5X1Bvc2l0aW9uLmxuZywgZ2V0U3RhdHVzKGl0ZW0pXTtcbiAgICByZXR1cm4gdHJhY2tJdGVtcy5qb2luKCcnKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlTWFya2VyRnJvbU1hcChkZXZpY2U6IFBvc2l0aW9uTWFuYWdlZE9iamVjdCkge1xuICAgIGNvbnN0IG1hcmtlcnMgPSB0aGlzLm1hcmtlcnMuZmlsdGVyKChtYXJrZXI6IEM4eU1hcmtlcikgPT4gbWFya2VyLmFzc2V0Py5pZCA9PT0gZGV2aWNlLmlkKTtcbiAgICBtYXJrZXJzLmZvckVhY2gobWFya2VyID0+IG1hcmtlci5yZW1vdmUoKSk7XG4gIH1cbn1cbiJdfQ==