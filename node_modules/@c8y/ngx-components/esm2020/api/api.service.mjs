import { Injectable } from '@angular/core';
import { FetchClient } from '@c8y/client';
import { Subject } from 'rxjs';
import { filter } from 'rxjs/operators';
import { HttpInterceptHandler, HttpRequestHandler } from './http-handler.model';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client";
export class ApiService {
    constructor(client) {
        this.client = client;
        this.callsSubject = new Subject();
        this.interceptors = new Map();
        this.interceptorCounter = 0;
        this.calls = this.callsSubject.asObservable();
        this.hookIntoClientFetch();
    }
    /**
     * Allows to hook into the responses received by the FetchClient.
     * This is meant to be used to react on the responses, not for manipulation of the responses.
     * @param hookFilter A filter function to filter for specific responses.
     * @returns An Observable of the filtered responses.
     */
    hookResponse(hookFilter) {
        return this.callsSubject.pipe(filter(({ phase }) => phase === 'finish'), filter(hookFilter));
    }
    /**
     * Allows to hook into the requests performed by the FetchClient.
     * This is meant to be used to react on the requests, not for manipulation of the requests.
     * @param hookFilter A filter function to filter for specific requests.
     * @returns An Observable of the filtered requests.
     */
    hookRequest(hookFilter) {
        return this.callsSubject.pipe(filter(({ phase }) => phase === 'start'), filter(hookFilter));
    }
    async onFinish(call) {
        this.callsSubject.next({ phase: 'finish', ...call });
    }
    onStart(call) {
        this.callsSubject.next({ phase: 'start', ...call });
    }
    resolveData(call) {
        const { response, method, url } = call;
        if ('data' in response) {
            return Promise.resolve({ data: response.data, method, url });
        }
        else {
            // No Content success status, for example DELETE request.
            if (response?.status === 204) {
                return Promise.resolve({ data: null, method, url });
            }
            const cb = data => ({ data, method, url });
            return response.clone().json().then(cb, cb);
        }
    }
    /**
     * Allows to intercept requests performed via the FetchClient requests.
     * @param interceptor The interceptor to be added.
     * @param id An optional unique identifier for the interceptor. The chain of interceptors is ordered by this id. And it can be used to remove the interceptor later on.
     * @returns The id of the interceptor (same as provided id if one was provided, otherwise an id will be generated).
     */
    addInterceptor(interceptor, id) {
        if (!id) {
            id = `${++this.interceptorCounter}`;
        }
        this.interceptors.set(id, interceptor);
        return id;
    }
    /**
     * Allows to remove a previously added interceptor by it's id.
     * @param id The id of the interceptor that should be removed.
     * @returns true if an interceptor existed and has been removed, or false if id does not exist.
     */
    removeInterceptor(id) {
        return this.interceptors.delete(id);
    }
    hookIntoClientFetch() {
        const fetch = this.client.fetch.bind(this.client);
        const requestHandler = new HttpRequestHandler(fetch, this);
        this.client.fetch = async (url, options = { method: 'GET' }) => {
            const { method } = options;
            return this.createInterceptorChain({ url, options, method }, requestHandler).toPromise();
        };
    }
    createInterceptorChain(call, requestHandler) {
        let handler = requestHandler;
        // Do some sorting to always apply the interceptors in the specific order
        const sortedInterceptorIds = Array.from(this.interceptors.keys()).sort((a, b) => b.localeCompare(a));
        for (const interceptorId of sortedInterceptorIds) {
            handler = new HttpInterceptHandler(this.interceptors.get(interceptorId), handler);
        }
        return handler.handle(call);
    }
}
ApiService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: ApiService, deps: [{ token: i1.FetchClient }], target: i0.ɵɵFactoryTarget.Injectable });
ApiService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: ApiService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: ApiService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.FetchClient }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9hcGkvYXBpLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsV0FBVyxFQUFpQyxNQUFNLGFBQWEsQ0FBQztBQUN6RSxPQUFPLEVBQUUsT0FBTyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4QyxPQUFPLEVBQ0wsb0JBQW9CLEVBQ3BCLGtCQUFrQixFQUVuQixNQUFNLHNCQUFzQixDQUFDOzs7QUFLOUIsTUFBTSxPQUFPLFVBQVU7SUFNckIsWUFBb0IsTUFBbUI7UUFBbkIsV0FBTSxHQUFOLE1BQU0sQ0FBYTtRQUovQixpQkFBWSxHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7UUFDdEMsaUJBQVksR0FBRyxJQUFJLEdBQUcsRUFBMkIsQ0FBQztRQUNsRCx1QkFBa0IsR0FBRyxDQUFDLENBQUM7UUFHN0IsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzlDLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILFlBQVksQ0FBQyxVQUFzQztRQUNqRCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUMzQixNQUFNLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsQ0FBQyxLQUFLLEtBQUssUUFBUSxDQUFDLEVBQ3pDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FDbkIsQ0FBQztJQUNKLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILFdBQVcsQ0FBQyxVQUFzQztRQUNoRCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUMzQixNQUFNLENBQUMsQ0FBQyxF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QUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUM5RSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUNuQixDQUFDO1FBQ0YsS0FBSyxNQUFNLGFBQWEsSUFBSSxvQkFBb0IsRUFBRTtZQUNoRCxPQUFPLEdBQUcsSUFBSSxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUNuRjtRQUNELE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM5QixDQUFDOzt1R0EzR1UsVUFBVTsyR0FBVixVQUFVLGNBRlQsTUFBTTsyRkFFUCxVQUFVO2tCQUh0QixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZldGNoQ2xpZW50LCBJRmV0Y2hPcHRpb25zLCBJRmV0Y2hSZXNwb25zZSB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEFwaUNhbGwsIEFwaUNhbGxPcHRpb25zIH0gZnJvbSAnLi9hcGkubW9kZWwnO1xuaW1wb3J0IHsgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSHR0cEludGVyY2VwdG9yLCBIdHRwSGFuZGxlciB9IGZyb20gJy4vaW50ZXJjZXB0b3IubW9kZWwnO1xuaW1wb3J0IHtcbiAgSHR0cEludGVyY2VwdEhhbmRsZXIsXG4gIEh0dHBSZXF1ZXN0SGFuZGxlcixcbiAgUmVxdWVzdFN0YXJ0QW5kRmluaXNoXG59IGZyb20gJy4vaHR0cC1oYW5kbGVyLm1vZGVsJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQXBpU2VydmljZSBpbXBsZW1lbnRzIFJlcXVlc3RTdGFydEFuZEZpbmlzaCB7XG4gIGNhbGxzOiBPYnNlcnZhYmxlPEFwaUNhbGw+O1xuICBwcml2YXRlIGNhbGxzU3ViamVjdCA9IG5ldyBTdWJqZWN0PEFwaUNhbGw+KCk7XG4gIHByaXZhdGUgaW50ZXJjZXB0b3JzID0gbmV3IE1hcDxzdHJpbmcsIEh0dHBJbnRlcmNlcHRvcj4oKTtcbiAgcHJpdmF0ZSBpbnRlcmNlcHRvckNvdW50ZXIgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY2xpZW50OiBGZXRjaENsaWVudCkge1xuICAgIHRoaXMuY2FsbHMgPSB0aGlzLmNhbGxzU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgICB0aGlzLmhvb2tJbnRvQ2xpZW50RmV0Y2goKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBbGxvd3MgdG8gaG9vayBpbnRvIHRoZSByZXNwb25zZXMgcmVjZWl2ZWQgYnkgdGhlIEZldGNoQ2xpZW50LlxuICAgKiBUaGlzIGlzIG1lYW50IHRvIGJlIHVzZWQgdG8gcmVhY3Qgb24gdGhlIHJlc3BvbnNlcywgbm90IGZvciBtYW5pcHVsYXRpb24gb2YgdGhlIHJlc3BvbnNlcy5cbiAgICogQHBhcmFtIGhvb2tGaWx0ZXIgQSBmaWx0ZXIgZnVuY3Rpb24gdG8gZmlsdGVyIGZvciBzcGVjaWZpYyByZXNwb25zZXMuXG4gICAqIEByZXR1cm5zIEFuIE9ic2VydmFibGUgb2YgdGhlIGZpbHRlcmVkIHJlc3BvbnNlcy5cbiAgICovXG4gIGhvb2tSZXNwb25zZShob29rRmlsdGVyOiAoY2FsbDogQXBpQ2FsbCkgPT4gYm9vbGVhbikge1xuICAgIHJldHVybiB0aGlzLmNhbGxzU3ViamVjdC5waXBlKFxuICAgICAgZmlsdGVyKCh7IHBoYXNlIH0pID0+IHBoYXNlID09PSAnZmluaXNoJyksXG4gICAgICBmaWx0ZXIoaG9va0ZpbHRlcilcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEFsbG93cyB0byBob29rIGludG8gdGhlIHJlcXVlc3RzIHBlcmZvcm1lZCBieSB0aGUgRmV0Y2hDbGllbnQuXG4gICAqIFRoaXMgaXMgbWVhbnQgdG8gYmUgdXNlZCB0byByZWFjdCBvbiB0aGUgcmVxdWVzdHMsIG5vdCBmb3IgbWFuaXB1bGF0aW9uIG9mIHRoZSByZXF1ZXN0cy5cbiAgICogQHBhcmFtIGhvb2tGaWx0ZXIgQSBmaWx0ZXIgZnVuY3Rpb24gdG8gZmlsdGVyIGZvciBzcGVjaWZpYyByZXF1ZXN0cy5cbiAgICogQHJldHVybnMgQW4gT2JzZXJ2YWJsZSBvZiB0aGUgZmlsdGVyZWQgcmVxdWVzdHMuXG4gICAqL1xuICBob29rUmVxdWVzdChob29rRmlsdGVyOiAoY2FsbDogQXBpQ2FsbCkgPT4gYm9vbGVhbikge1xuICAgIHJldHVybiB0aGlzLmNhbGxzU3ViamVjdC5waXBlKFxuICAgICAgZmlsdGVyKCh7IHBoYXNlIH0pID0+IHBoYXNlID09PSAnc3RhcnQnKSxcbiAgICAgIGZpbHRlcihob29rRmlsdGVyKVxuICAgICk7XG4gIH1cblxuICBhc3luYyBvbkZpbmlzaChjYWxsOiBBcGlDYWxsKSB7XG4gICAgdGhpcy5jYWxsc1N1YmplY3QubmV4dCh7IHBoYXNlOiAnZmluaXNoJywgLi4uY2FsbCB9KTtcbiAgfVxuXG4gIG9uU3RhcnQoY2FsbDogQXBpQ2FsbCkge1xuICAgIHRoaXMuY2FsbHNTdWJqZWN0Lm5leHQoeyBwaGFzZTogJ3N0YXJ0JywgLi4uY2FsbCB9KTtcbiAgfVxuXG4gIHJlc29sdmVEYXRhPFQgPSB1bmtub3duPihjYWxsOiBBcGlDYWxsKTogUHJvbWlzZTx7IGRhdGE6IFQ7IG1ldGhvZDogc3RyaW5nOyB1cmw6IHN0cmluZyB9PiB7XG4gICAgY29uc3QgeyByZXNwb25zZSwgbWV0aG9kLCB1cmwgfSA9IGNhbGw7XG4gICAgaWYgKCdkYXRhJyBpbiByZXNwb25zZSkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGRhdGE6IHJlc3BvbnNlLmRhdGEsIG1ldGhvZCwgdXJsIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBObyBDb250ZW50IHN1Y2Nlc3Mgc3RhdHVzLCBmb3IgZXhhbXBsZSBERUxFVEUgcmVxdWVzdC5cbiAgICAgIGlmICgocmVzcG9uc2UgYXMgUmVzcG9uc2UpPy5zdGF0dXMgPT09IDIwNCkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgZGF0YTogbnVsbCwgbWV0aG9kLCB1cmwgfSk7XG4gICAgICB9XG4gICAgICBjb25zdCBjYiA9IGRhdGEgPT4gKHsgZGF0YSwgbWV0aG9kLCB1cmwgfSk7XG4gICAgICByZXR1cm4gKHJlc3BvbnNlIGFzIFJlc3BvbnNlKS5jbG9uZSgpLmpzb24oKS50aGVuKGNiLCBjYik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEFsbG93cyB0byBpbnRlcmNlcHQgcmVxdWVzdHMgcGVyZm9ybWVkIHZpYSB0aGUgRmV0Y2hDbGllbnQgcmVxdWVzdHMuXG4gICAqIEBwYXJhbSBpbnRlcmNlcHRvciBUaGUgaW50ZXJjZXB0b3IgdG8gYmUgYWRkZWQuXG4gICAqIEBwYXJhbSBpZCBBbiBvcHRpb25hbCB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIGludGVyY2VwdG9yLiBUaGUgY2hhaW4gb2YgaW50ZXJjZXB0b3JzIGlzIG9yZGVyZWQgYnkgdGhpcyBpZC4gQW5kIGl0IGNhbiBiZSB1c2VkIHRvIHJlbW92ZSB0aGUgaW50ZXJjZXB0b3IgbGF0ZXIgb24uXG4gICAqIEByZXR1cm5zIFRoZSBpZCBvZiB0aGUgaW50ZXJjZXB0b3IgKHNhbWUgYXMgcHJvdmlkZWQgaWQgaWYgb25lIHdhcyBwcm92aWRlZCwgb3RoZXJ3aXNlIGFuIGlkIHdpbGwgYmUgZ2VuZXJhdGVkKS5cbiAgICovXG4gIGFkZEludGVyY2VwdG9yKGludGVyY2VwdG9yOiBIdHRwSW50ZXJjZXB0b3IsIGlkPzogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAoIWlkKSB7XG4gICAgICBpZCA9IGAkeysrdGhpcy5pbnRlcmNlcHRvckNvdW50ZXJ9YDtcbiAgICB9XG4gICAgdGhpcy5pbnRlcmNlcHRvcnMuc2V0KGlkLCBpbnRlcmNlcHRvcik7XG4gICAgcmV0dXJuIGlkO1xuICB9XG5cbiAgLyoqXG4gICAqIEFsbG93cyB0byByZW1vdmUgYSBwcmV2aW91c2x5IGFkZGVkIGludGVyY2VwdG9yIGJ5IGl0J3MgaWQuXG4gICAqIEBwYXJhbSBpZCBUaGUgaWQgb2YgdGhlIGludGVyY2VwdG9yIHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQuXG4gICAqIEByZXR1cm5zIHRydWUgaWYgYW4gaW50ZXJjZXB0b3IgZXhpc3RlZCBhbmQgaGFzIGJlZW4gcmVtb3ZlZCwgb3IgZmFsc2UgaWYgaWQgZG9lcyBub3QgZXhpc3QuXG4gICAqL1xuICByZW1vdmVJbnRlcmNlcHRvcihpZDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaW50ZXJjZXB0b3JzLmRlbGV0ZShpZCk7XG4gIH1cblxuICBwcml2YXRlIGhvb2tJbnRvQ2xpZW50RmV0Y2goKSB7XG4gICAgY29uc3QgZmV0Y2g6IEZldGNoQ2xpZW50WydmZXRjaCddID0gdGhpcy5jbGllbnQuZmV0Y2guYmluZCh0aGlzLmNsaWVudCk7XG4gICAgY29uc3QgcmVxdWVzdEhhbmRsZXIgPSBuZXcgSHR0cFJlcXVlc3RIYW5kbGVyKGZldGNoLCB0aGlzKTtcbiAgICB0aGlzLmNsaWVudC5mZXRjaCA9IGFzeW5jIChcbiAgICAgIHVybCxcbiAgICAgIG9wdGlvbnM6IEFwaUNhbGxPcHRpb25zICYgSUZldGNoT3B0aW9ucyA9IHsgbWV0aG9kOiAnR0VUJyB9XG4gICAgKSA9PiB7XG4gICAgICBjb25zdCB7IG1ldGhvZCB9ID0gb3B0aW9ucztcbiAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUludGVyY2VwdG9yQ2hhaW4oeyB1cmwsIG9wdGlvbnMsIG1ldGhvZCB9LCByZXF1ZXN0SGFuZGxlcikudG9Qcm9taXNlKCk7XG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlSW50ZXJjZXB0b3JDaGFpbihcbiAgICBjYWxsOiBBcGlDYWxsLFxuICAgIHJlcXVlc3RIYW5kbGVyOiBIdHRwUmVxdWVzdEhhbmRsZXJcbiAgKTogT2JzZXJ2YWJsZTxJRmV0Y2hSZXNwb25zZT4ge1xuICAgIGxldCBoYW5kbGVyOiBIdHRwSGFuZGxlciA9IHJlcXVlc3RIYW5kbGVyO1xuICAgIC8vIERvIHNvbWUgc29ydGluZyB0byBhbHdheXMgYXBwbHkgdGhlIGludGVyY2VwdG9ycyBpbiB0aGUgc3BlY2lmaWMgb3JkZXJcbiAgICBjb25zdCBzb3J0ZWRJbnRlcmNlcHRvcklkcyA9IEFycmF5LmZyb20odGhpcy5pbnRlcmNlcHRvcnMua2V5cygpKS5zb3J0KChhLCBiKSA9PlxuICAgICAgYi5sb2NhbGVDb21wYXJlKGEpXG4gICAgKTtcbiAgICBmb3IgKGNvbnN0IGludGVyY2VwdG9ySWQgb2Ygc29ydGVkSW50ZXJjZXB0b3JJZHMpIHtcbiAgICAgIGhhbmRsZXIgPSBuZXcgSHR0cEludGVyY2VwdEhhbmRsZXIodGhpcy5pbnRlcmNlcHRvcnMuZ2V0KGludGVyY2VwdG9ySWQpLCBoYW5kbGVyKTtcbiAgICB9XG4gICAgcmV0dXJuIGhhbmRsZXIuaGFuZGxlKGNhbGwpO1xuICB9XG59XG4iXX0=