import { InjectFlags } from '@angular/core';
import { NavigationEnd } from '@angular/router';
import { castArray, flatten, groupBy, sortBy, uniq } from 'lodash-es';
import { combineLatest, defer, from, isObservable, merge, of, race, Subject, BehaviorSubject } from 'rxjs';
import { filter, map, startWith, switchMap } from 'rxjs/operators';
import { StateService } from './state-service.abstract';
export function fromTrigger(router, refresh, factories) {
    return merge(router.events.pipe(filter(evt => evt instanceof NavigationEnd)), ...castArray(refresh)).pipe(startWith(1), switchMap(() => fromFactories(factories, router)));
}
export function fromTriggerOnce(router, refresh, factories) {
    return merge(...castArray(refresh)).pipe(startWith(1), switchMap(() => fromFactories(factories, router)));
}
export var InjectionType;
(function (InjectionType) {
    InjectionType[InjectionType["COMPONENT"] = 0] = "COMPONENT";
    InjectionType[InjectionType["ROUTE"] = 1] = "ROUTE";
})(InjectionType || (InjectionType = {}));
export function getInjectedHooks(token, injectors, type = InjectionType.COMPONENT) {
    return () => flatten(injectors.map(injector => {
        const factoryOrFactories = injector.get(token, [], InjectFlags.Self);
        const factories = Array.isArray(factoryOrFactories)
            ? flatten(factoryOrFactories)
            : [factoryOrFactories];
        if (injector.scopes?.has('root')) {
            return factories;
        }
        factories.forEach((factory) => {
            if (!factory.get) {
                if (type === InjectionType.ROUTE) {
                    factory._injector = injector;
                }
                else {
                    factory.injector = injector;
                }
            }
        });
        return factories;
    }));
}
export function fromFactories(factories, router, withFirstEmpty = true) {
    return !Array.isArray(factories) || factories.length < 1
        ? of([])
        : defer(() => {
            const factoryObservables = resolveInjectedFactories(factories).map(f => {
                if (Array.isArray(f)) {
                    return toObservableOfArrays(f, withFirstEmpty);
                }
                if (isExtensionFactory(f)) {
                    return toObservableOfArrays(f.get(getActivatedRoute(router)), withFirstEmpty);
                }
                return toObservableOfArrays([f], withFirstEmpty);
            });
            return combineLatest(factoryObservables);
        }).pipe(map(results => sortByPriority([].concat(...results))), map(value => uniq(value)));
}
export function resolveInjectedFactories(factories) {
    return flatten(factories.map(f => {
        if (typeof f === 'function') {
            const func = f;
            return func();
        }
        return [f];
    }));
}
export function stateToFactory(componentsState) {
    const components$ = componentsState.pipe(map((componentSet) => [...componentSet]));
    return { get: () => components$ };
}
export function sortByPriority(items) {
    return sortBy(items, item => -(item?.priority || 0));
}
export function removeDuplicatesIds(items) {
    const grouped = groupBy(items, 'id');
    const itemsWithoutDuplicates = new Array();
    for (const key of Object.keys(grouped)) {
        if (key && key !== 'undefined') {
            const sortedByPrio = sortByPriority(grouped[key]);
            itemsWithoutDuplicates.push(sortedByPrio[0]);
        }
        else {
            itemsWithoutDuplicates.push(...grouped[key]);
        }
    }
    return sortByPriority(itemsWithoutDuplicates);
}
export function toObservableOfArrays(factoryResult, withFirstEmpty) {
    let observable;
    if (!factoryResult) {
        return of([]);
    }
    else {
        observable = toObservable(factoryResult);
        if (withFirstEmpty) {
            const withEmptyFirst = observable.pipe(startWith([]));
            observable = race(observable, withEmptyFirst);
        }
    }
    return observable.pipe(map(result => (Array.isArray(result) ? result : [result]).filter(item => !!item)));
}
export function isPromise(obj) {
    return !!obj && typeof obj.then === 'function';
}
export function isExtensionFactory(obj) {
    return !!obj && typeof obj.get === 'function';
}
/**
 * Converts any value provided to an Observable that emits this value once and then completes.
 * A convenience method to represent all the data as Observables rather than
 * a mixture of Observables and other types.
 *
 * @param value The value the resulting Observable will emit.
 */
export function toObservable(value) {
    if (isObservable(value)) {
        return value;
    }
    if (isPromise(value)) {
        return from(value);
    }
    return of(value);
}
export class ExtensionPointWithoutStateForPlugins {
    constructor(rootInjector, pluginService) {
        this.factories = [];
        this.refreshTrigger = new Subject();
        this.injectors = [rootInjector];
        pluginService.injectors$.subscribe(injector => {
            this.injectors.push(injector);
        });
        this.refresh$ = merge(this.refreshTrigger, pluginService.refresh$);
    }
    /**
     * Refresh the extension factories
     */
    refresh() {
        this.refreshTrigger.next();
    }
}
export class ExtensionPointForPlugins extends StateService {
    constructor(rootInjector, pluginService) {
        super();
        this.factories = [];
        this.state$ = new BehaviorSubject(new Set());
        this.refreshTrigger = new Subject();
        this.injectors = [rootInjector];
        pluginService.injectors$.subscribe(injector => {
            this.injectors.push(injector);
        });
        this.refresh$ = merge(this.refreshTrigger, pluginService.refresh$);
    }
    /**
     * Refresh the extension factories
     */
    refresh() {
        this.refreshTrigger.next();
    }
}
/**
 * Helper function to get the activated route in
 * a service (as ActivatedRoute injection only
 * works in components). Works as long as we only use
 * a tree and no child is active at the same time.
 *
 * @param router The current router
 */
export function getActivatedRoute(router) {
    if (router && router.routerState && router.routerState.root) {
        let route = router.routerState.root;
        while (route.firstChild) {
            route = route.firstChild;
        }
        return route;
    }
}
/**
 * A generic function to be used by specific implementations of the HOOK concept.
 * @param items The items that should be provided under the `useValue` or `useClass` attribute.
 * @param token The InjectionToken/HOOK to be provided.
 * @param multi If this is a multi provider or not (defaults to true).
 * @returns A `Provider` (either `ValueProvider` or `ClassProvider`) to be provided in a module.
 */
export function hookGeneric(items, token, options) {
    const finalOptions = Object.assign({ multi: true, providerType: HookProviderTypes.ClassProvider }, options);
    const { multi, providerType } = finalOptions;
    if (typeof items !== 'function') {
        return {
            provide: token,
            useValue: items,
            multi
        };
    }
    if (providerType === HookProviderTypes.ExistingProvider) {
        return {
            provide: token,
            useExisting: items,
            multi
        };
    }
    return {
        provide: token,
        useClass: items,
        multi
    };
}
export var HookProviderTypes;
(function (HookProviderTypes) {
    HookProviderTypes["ExistingProvider"] = "ExistingProvider";
    HookProviderTypes["ClassProvider"] = "ClassProvider";
})(HookProviderTypes || (HookProviderTypes = {}));
export function allEntriesAreEqual(previous, next) {
    if (previous === next)
        return true;
    if (previous == null || next == null)
        return false;
    if (previous.length !== next.length)
        return false;
    for (let i = 0; i < previous.length; ++i) {
        if (previous[i] !== next[i])
            return false;
    }
    return true;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaW9uLWhvb2tzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9jb21tb24vZXh0ZW5zaW9uLWhvb2tzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFHTCxXQUFXLEVBS1osTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFrQixhQUFhLEVBQVUsTUFBTSxpQkFBaUIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN0RSxPQUFPLEVBQ0wsYUFBYSxFQUNiLEtBQUssRUFDTCxJQUFJLEVBQ0osWUFBWSxFQUNaLEtBQUssRUFFTCxFQUFFLEVBQ0YsSUFBSSxFQUNKLE9BQU8sRUFDUCxlQUFlLEVBQ2hCLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRW5FLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUV4RCxNQUFNLFVBQVUsV0FBVyxDQUN6QixNQUFjLEVBQ2QsT0FBNEMsRUFDNUMsU0FNQztJQUVELE9BQU8sS0FBSyxDQUNWLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsWUFBWSxhQUFhLENBQUMsQ0FBQyxFQUMvRCxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FDdEIsQ0FBQyxJQUFJLENBQ0osU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUNaLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxhQUFhLENBQUksU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQ3JELENBQUM7QUFDSixDQUFDO0FBRUQsTUFBTSxVQUFVLGVBQWUsQ0FDN0IsTUFBYyxFQUNkLE9BQTRDLEVB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SyxDQUFDO0tBQzNDO0lBQ0QsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ2xhc3NQcm92aWRlcixcbiAgRXhpc3RpbmdQcm92aWRlcixcbiAgSW5qZWN0RmxhZ3MsXG4gIEluamVjdGlvblRva2VuLFxuICBJbmplY3RvcixcbiAgVHlwZSxcbiAgVmFsdWVQcm92aWRlclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCBOYXZpZ2F0aW9uRW5kLCBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgY2FzdEFycmF5LCBmbGF0dGVuLCBncm91cEJ5LCBzb3J0QnksIHVuaXEgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHtcbiAgY29tYmluZUxhdGVzdCxcbiAgZGVmZXIsXG4gIGZyb20sXG4gIGlzT2JzZXJ2YWJsZSxcbiAgbWVyZ2UsXG4gIE9ic2VydmFibGUsXG4gIG9mLFxuICByYWNlLFxuICBTdWJqZWN0LFxuICBCZWhhdmlvclN1YmplY3Rcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCwgc3RhcnRXaXRoLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQbHVnaW5zUmVzb2x2ZVNlcnZpY2UgfSBmcm9tICcuLi9wbHVnaW5zJztcbmltcG9ydCB7IFN0YXRlU2VydmljZSB9IGZyb20gJy4vc3RhdGUtc2VydmljZS5hYnN0cmFjdCc7XG5cbmV4cG9ydCBmdW5jdGlvbiBmcm9tVHJpZ2dlcjxUPihcbiAgcm91dGVyOiBSb3V0ZXIsXG4gIHJlZnJlc2g6IE9ic2VydmFibGU8YW55PiB8IE9ic2VydmFibGU8YW55PltdLFxuICBmYWN0b3JpZXM6IEFycmF5PFxuICAgIHwgVFxuICAgIHwgVFtdXG4gICAgfCBFeHRlbnNpb25GYWN0b3J5PFQ+XG4gICAgfCBFeHRlbnNpb25GYWN0b3J5PFQ+W11cbiAgICB8ICgoKSA9PiBUIHwgRXh0ZW5zaW9uRmFjdG9yeTxUPiB8IEFycmF5PFQgfCBFeHRlbnNpb25GYWN0b3J5PFQ+PilcbiAgPlxuKTogT2JzZXJ2YWJsZTxUW10+IHtcbiAgcmV0dXJuIG1lcmdlKFxuICAgIHJvdXRlci5ldmVudHMucGlwZShmaWx0ZXIoZXZ0ID0+IGV2dCBpbnN0YW5jZW9mIE5hdmlnYXRpb25FbmQpKSxcbiAgICAuLi5jYXN0QXJyYXkocmVmcmVzaClcbiAgKS5waXBlKFxuICAgIHN0YXJ0V2l0aCgxKSxcbiAgICBzd2l0Y2hNYXAoKCkgPT4gZnJvbUZhY3RvcmllczxUPihmYWN0b3JpZXMsIHJvdXRlcikpXG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmcm9tVHJpZ2dlck9uY2U8VD4oXG4gIHJvdXRlcjogUm91dGVyLFxuICByZWZyZXNoOiBPYnNlcnZhYmxlPGFueT4gfCBPYnNlcnZhYmxlPGFueT5bXSxcbiAgZmFjdG9yaWVzOiBBcnJheTxcbiAgICB8IFRcbiAgICB8IFRbXVxuICAgIHwgRXh0ZW5zaW9uRmFjdG9yeTxUPlxuICAgIHwgRXh0ZW5zaW9uRmFjdG9yeTxUPltdXG4gICAgfCAoKCkgPT4gVCB8IEV4dGVuc2lvbkZhY3Rvcnk8VD4gfCBBcnJheTxUIHwgRXh0ZW5zaW9uRmFjdG9yeTxUPj4pXG4gID5cbik6IE9ic2VydmFibGU8VFtdPiB7XG4gIHJldHVybiBtZXJnZSguLi5jYXN0QXJyYXkocmVmcmVzaCkpLnBpcGUoXG4gICAgc3RhcnRXaXRoKDEpLFxuICAgIHN3aXRjaE1hcCgoKSA9PiBmcm9tRmFjdG9yaWVzPFQ+KGZhY3Rvcmllcywgcm91dGVyKSlcbiAgKTtcbn1cblxuZXhwb3J0IGVudW0gSW5qZWN0aW9uVHlwZSB7XG4gIENPTVBPTkVOVCxcbiAgUk9VVEVcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEluamVjdGVkSG9va3M8VD4oXG4gIHRva2VuOiBJbmplY3Rpb25Ub2tlbjxUW10+LFxuICBpbmplY3RvcnM6IEluamVjdG9yW10sXG4gIHR5cGUgPSBJbmplY3Rpb25UeXBlLkNPTVBPTkVOVFxuKTogKCkgPT4gVFtdIHtcbiAgcmV0dXJuICgpID0+XG4gICAgZmxhdHRlbihcbiAgICAgIGluamVjdG9ycy5tYXAoaW5qZWN0b3IgPT4ge1xuICAgICAgICBjb25zdCBmYWN0b3J5T3JGYWN0b3JpZXMgPSBpbmplY3Rvci5nZXQ8VCB8IFRbXT4odG9rZW4sIFtdLCBJbmplY3RGbGFncy5TZWxmKTtcbiAgICAgICAgY29uc3QgZmFjdG9yaWVzOiBUW10gPSBBcnJheS5pc0FycmF5KGZhY3RvcnlPckZhY3RvcmllcylcbiAgICAgICAgICA/IGZsYXR0ZW4oZmFjdG9yeU9yRmFjdG9yaWVzKVxuICAgICAgICAgIDogW2ZhY3RvcnlPckZhY3Rvcmllc107XG4gICAgICAgIGlmICgoaW5qZWN0b3IgYXMgYW55KS5zY29wZXM/Lmhhcygncm9vdCcpKSB7XG4gICAgICAgICAgcmV0dXJuIGZhY3RvcmllcztcbiAgICAgICAgfVxuICAgICAgICBmYWN0b3JpZXMuZm9yRWFjaCgoZmFjdG9yeTogVCB8IEV4dGVuc2lvbkZhY3Rvcnk8VD4pID0+IHtcbiAgICAgICAgICBpZiAoIShmYWN0b3J5IGFzIEV4dGVuc2lvbkZhY3Rvcnk8VD4pLmdldCkge1xuICAgICAgICAgICAgaWYgKHR5cGUgPT09IEluamVjdGlvblR5cGUuUk9VVEUpIHtcbiAgICAgICAgICAgICAgKGZhY3RvcnkgYXMgYW55KS5faW5qZWN0b3IgPSBpbmplY3RvcjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIChmYWN0b3J5IGFzIGFueSkuaW5qZWN0b3IgPSBpbmplY3RvcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZmFjdG9yaWVzO1xuICAgICAgfSlcbiAgICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZnJvbUZhY3RvcmllczxUPihcbiAgZmFjdG9yaWVzPzogQXJyYXk8XG4gICAgfCBUXG4gICAgfCBUW11cbiAgICB8IEV4dGVuc2lvbkZhY3Rvcnk8VD5cbiAgICB8IEV4dGVuc2lvbkZhY3Rvcnk8VD5bXVxuICAgIHwgKCgpID0+IFQgfCBFeHRlbnNpb25GYWN0b3J5PFQ+IHwgQXJyYXk8VCB8IEV4dGVuc2lvbkZhY3Rvcnk8VD4+KVxuICA+LFxuICByb3V0ZXI/OiBSb3V0ZXIsXG4gIHdpdGhGaXJzdEVtcHR5ID0gdHJ1ZVxuKTogT2JzZXJ2YWJsZTxUW10+IHtcbiAgcmV0dXJuICFBcnJheS5pc0FycmF5KGZhY3RvcmllcykgfHwgZmFjdG9yaWVzLmxlbmd0aCA8IDFcbiAgICA/IG9mKFtdKVxuICAgIDogZGVmZXIoKCkgPT4ge1xuICAgICAgICBjb25zdCBmYWN0b3J5T2JzZXJ2YWJsZXM6IE9ic2VydmFibGU8VFtdPltdID0gcmVzb2x2ZUluamVjdGVkRmFjdG9yaWVzKGZhY3RvcmllcykubWFwKGYgPT4ge1xuICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGYpKSB7XG4gICAgICAgICAgICByZXR1cm4gdG9PYnNlcnZhYmxlT2ZBcnJheXMoZiwgd2l0aEZpcnN0RW1wdHkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoaXNFeHRlbnNpb25GYWN0b3J5KGYpKSB7XG4gICAgICAgICAgICByZXR1cm4gdG9PYnNlcnZhYmxlT2ZBcnJheXMoZi5nZXQoZ2V0QWN0aXZhdGVkUm91dGUocm91dGVyKSksIHdpdGhGaXJzdEVtcHR5KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gdG9PYnNlcnZhYmxlT2ZBcnJheXMoW2ZdLCB3aXRoRmlyc3RFbXB0eSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gY29tYmluZUxhdGVzdChmYWN0b3J5T2JzZXJ2YWJsZXMpO1xuICAgICAgfSkucGlwZShcbiAgICAgICAgbWFwKHJlc3VsdHMgPT4gc29ydEJ5UHJpb3JpdHkoW10uY29uY2F0KC4uLnJlc3VsdHMpKSksXG4gICAgICAgIG1hcCh2YWx1ZSA9PiB1bmlxKHZhbHVlKSlcbiAgICAgICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXNvbHZlSW5qZWN0ZWRGYWN0b3JpZXM8VD4oXG4gIGZhY3RvcmllczogQXJyYXk8XG4gICAgfCBUXG4gICAgfCBUW11cbiAgICB8IEV4dGVuc2lvbkZhY3Rvcnk8VD5cbiAgICB8IEV4dGVuc2lvbkZhY3Rvcnk8VD5bXVxuICAgIHwgKCgpID0+IFQgfCBFeHRlbnNpb25GYWN0b3J5PFQ+IHwgQXJyYXk8VCB8IEV4dGVuc2lvbkZhY3Rvcnk8VD4+KVxuICA+XG4pOiBBcnJheTxUIHwgVFtdIHwgRXh0ZW5zaW9uRmFjdG9yeTxUPj4ge1xuICByZXR1cm4gZmxhdHRlbihcbiAgICBmYWN0b3JpZXMubWFwKGYgPT4ge1xuICAgICAgaWYgKHR5cGVvZiBmID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGNvbnN0IGZ1bmMgPSBmIGFzICgpID0+IFQgfCBUW10gfCBFeHRlbnNpb25GYWN0b3J5PFQ+O1xuICAgICAgICByZXR1cm4gZnVuYygpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFtmXTtcbiAgICB9KVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3RhdGVUb0ZhY3Rvcnk8VD4oY29tcG9uZW50c1N0YXRlKTogRXh0ZW5zaW9uRmFjdG9yeTxUPiB7XG4gIGNvbnN0IGNvbXBvbmVudHMkID0gY29tcG9uZW50c1N0YXRlLnBpcGUobWFwKChjb21wb25lbnRTZXQ6IFNldDxUPikgPT4gWy4uLmNvbXBvbmVudFNldF0pKTtcbiAgcmV0dXJuIHsgZ2V0OiAoKSA9PiBjb21wb25lbnRzJCB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc29ydEJ5UHJpb3JpdHk8VD4oaXRlbXM6IFRbXSk6IFRbXSB7XG4gIHJldHVybiBzb3J0QnkoaXRlbXMsIGl0ZW0gPT4gLShpdGVtPy5wcmlvcml0eSB8fCAwKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW1vdmVEdXBsaWNhdGVzSWRzPFQgZXh0ZW5kcyB7IGlkPzogc3RyaW5nOyBwcmlvcml0eT86IG51bWJlciB9PihpdGVtczogVFtdKTogVFtdIHtcbiAgY29uc3QgZ3JvdXBlZDogeyBba2V5OiBzdHJpbmddOiBUW10gfSA9IGdyb3VwQnkoaXRlbXMsICdpZCcpO1xuICBjb25zdCBpdGVtc1dpdGhvdXREdXBsaWNhdGVzID0gbmV3IEFycmF5PFQ+KCk7XG4gIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKGdyb3VwZWQpKSB7XG4gICAgaWYgKGtleSAmJiBrZXkgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBjb25zdCBzb3J0ZWRCeVByaW8gPSBzb3J0QnlQcmlvcml0eShncm91cGVkW2tleV0pO1xuICAgICAgaXRlbXNXaXRob3V0RHVwbGljYXRlcy5wdXNoKHNvcnRlZEJ5UHJpb1swXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGl0ZW1zV2l0aG91dER1cGxpY2F0ZXMucHVzaCguLi5ncm91cGVkW2tleV0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gc29ydEJ5UHJpb3JpdHkoaXRlbXNXaXRob3V0RHVwbGljYXRlcyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0b09ic2VydmFibGVPZkFycmF5czxUPihcbiAgZmFjdG9yeVJlc3VsdDogVCB8IFRbXSB8IFByb21pc2U8VCB8IFRbXT4gfCBPYnNlcnZhYmxlPFQgfCBUW10+LFxuICB3aXRoRmlyc3RFbXB0eTogYm9vbGVhblxuKTogT2JzZXJ2YWJsZTxUW10+IHtcbiAgbGV0IG9ic2VydmFibGU6IE9ic2VydmFibGU8VCB8IFRbXT47XG4gIGlmICghZmFjdG9yeVJlc3VsdCkge1xuICAgIHJldHVybiBvZihbXSk7XG4gIH0gZWxzZSB7XG4gICAgb2JzZXJ2YWJsZSA9IHRvT2JzZXJ2YWJsZShmYWN0b3J5UmVzdWx0KTtcbiAgICBpZiAod2l0aEZpcnN0RW1wdHkpIHtcbiAgICAgIGNvbnN0IHdpdGhFbXB0eUZpcnN0ID0gb2JzZXJ2YWJsZS5waXBlKHN0YXJ0V2l0aChbXSkpO1xuICAgICAgb2JzZXJ2YWJsZSA9IHJhY2Uob2JzZXJ2YWJsZSwgd2l0aEVtcHR5Rmlyc3QpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gb2JzZXJ2YWJsZS5waXBlKFxuICAgIG1hcChyZXN1bHQgPT4gKEFycmF5LmlzQXJyYXkocmVzdWx0KSA/IHJlc3VsdCA6IFtyZXN1bHRdKS5maWx0ZXIoaXRlbSA9PiAhIWl0ZW0pKVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNQcm9taXNlPFQgPSBhbnk+KG9iajogYW55KTogb2JqIGlzIFByb21pc2U8VD4ge1xuICByZXR1cm4gISFvYmogJiYgdHlwZW9mIG9iai50aGVuID09PSAnZnVuY3Rpb24nO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNFeHRlbnNpb25GYWN0b3J5PFQgPSBhbnk+KG9iajogYW55KTogb2JqIGlzIEV4dGVuc2lvbkZhY3Rvcnk8VD4ge1xuICByZXR1cm4gISFvYmogJiYgdHlwZW9mIG9iai5nZXQgPT09ICdmdW5jdGlvbic7XG59XG5cbi8qKlxuICogQ29udmVydHMgYW55IHZhbHVlIHByb3ZpZGVkIHRvIGFuIE9ic2VydmFibGUgdGhhdCBlbWl0cyB0aGlzIHZhbHVlIG9uY2UgYW5kIHRoZW4gY29tcGxldGVzLlxuICogQSBjb252ZW5pZW5jZSBtZXRob2QgdG8gcmVwcmVzZW50IGFsbCB0aGUgZGF0YSBhcyBPYnNlcnZhYmxlcyByYXRoZXIgdGhhblxuICogYSBtaXh0dXJlIG9mIE9ic2VydmFibGVzIGFuZCBvdGhlciB0eXBlcy5cbiAqXG4gKiBAcGFyYW0gdmFsdWUgVGhlIHZhbHVlIHRoZSByZXN1bHRpbmcgT2JzZXJ2YWJsZSB3aWxsIGVtaXQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0b09ic2VydmFibGU8VD4odmFsdWU6IFQgfCBQcm9taXNlPFQ+IHwgT2JzZXJ2YWJsZTxUPik6IE9ic2VydmFibGU8VD4ge1xuICBpZiAoaXNPYnNlcnZhYmxlKHZhbHVlKSkge1xuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIGlmIChpc1Byb21pc2UodmFsdWUpKSB7XG4gICAgcmV0dXJuIGZyb20odmFsdWUgYXMgUHJvbWlzZTxUPik7XG4gIH1cblxuICByZXR1cm4gb2YodmFsdWUgYXMgVCk7XG59XG5cbi8qKlxuICogQWxsb3dzIHRvIGV4dGVuZCB0aGUgZXhpc3RpbmcgYXBwbGljYXRpb25zIGZyb20gYSBtb2R1bGUuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRXh0ZW5zaW9uRmFjdG9yeTxUPiB7XG4gIC8qKlxuICAgKiBBbGxvd3MgdG8gcmVzb2x2ZSB0aGUgZGF0YSBvZiBhbiBleHRlbnNpb24gcG9pbnQuXG4gICAqIFRoZSByZXR1cm4gdmFsdWUgY2FuIGJlIGEgUHJvbWlzZSBvciBPYnNlcnZhYmxlXG4gICAqIChhbGxvd2luZyBmb3IgYXN5bmNocm9ub3VzIGRhdGEgcmVzb2x1dGlvbikuXG4gICAqXG4gICAqIEBwYXJhbSBhY3RpdmF0ZWRSb3V0ZSBUaGUgY3VycmVudCBhY3RpdmF0ZWQgcm91dGUgKGlmIHBvc3NpYmxlIHRvIHJlc29sdmUpLlxuICAgKi9cbiAgZ2V0KGFjdGl2YXRlZFJvdXRlPzogQWN0aXZhdGVkUm91dGUpOiBPYnNlcnZhYmxlPFRbXSB8IFQ+IHwgUHJvbWlzZTxUW10gfCBUPiB8IFRbXSB8IFQ7XG59XG5cbi8qKlxuICogRXh0ZW5zaW9uIHBvaW50cyBhbGxvdyB0byBleHRlbmQgdGhlIGFwcGxpY2F0aW9uIGZyb21cbiAqIGFueSBtb2R1bGVcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFeHRlbnNpb25Qb2ludDxUPiB7XG4gIC8qKlxuICAgKiBPYnNlcnZhYmxlIHRoYXQgZW1pdHMgb2YgYXJyYXkgb2YgZXh0ZW5zaW9ucyBhY3RpdmUgYXQgYW55IGdpdmUgdGltZVxuICAgKi9cbiAgcmVhZG9ubHkgaXRlbXMkOiBPYnNlcnZhYmxlPFRbXT47XG4gIC8qKlxuICAgKiBBZGRpdGlvbmFsIGZhY3RvcmllcyB0aGF0IGNhbiBiZSBhZGRlZCBkeW5hbWljYWxseS4gKHdpdGhvdXQgaG9vaylcbiAgICovXG4gIGZhY3RvcmllczogRXh0ZW5zaW9uRmFjdG9yeTxUPltdO1xuICAvKipcbiAgICogQ2FsbCB0aGUgZXh0ZW5zaW9uIGZhY3RvcmllcyB0byByZWZyZXNoIHRoZW0uXG4gICAqL1xuICByZWZyZXNoKCk7XG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBFeHRlbnNpb25Qb2ludFdpdGhvdXRTdGF0ZUZvclBsdWdpbnM8VD4gaW1wbGVtZW50cyBFeHRlbnNpb25Qb2ludDxUPiB7XG4gIGl0ZW1zJDogT2JzZXJ2YWJsZTxUW10+O1xuICBmYWN0b3JpZXM6IEV4dGVuc2lvbkZhY3Rvcnk8VD5bXSA9IFtdO1xuICByZWFkb25seSByZWZyZXNoJDogT2JzZXJ2YWJsZTx2b2lkPjtcbiAgLyoqXG4gICAqIEFsbCBpbmplY3RvcnMgdG8gc2VhcmNoIGZvciBhbiBleHRlbnNpb24uXG4gICAqL1xuICBwcm90ZWN0ZWQgaW5qZWN0b3JzOiBJbmplY3RvcltdO1xuICBwcml2YXRlIHJlYWRvbmx5IHJlZnJlc2hUcmlnZ2VyID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICBjb25zdHJ1Y3Rvcihyb290SW5qZWN0b3I6IEluamVjdG9yLCBwbHVnaW5TZXJ2aWNlOiBQbHVnaW5zUmVzb2x2ZVNlcnZpY2UpIHtcbiAgICB0aGlzLmluamVjdG9ycyA9IFtyb290SW5qZWN0b3JdO1xuICAgIHBsdWdpblNlcnZpY2UuaW5qZWN0b3JzJC5zdWJzY3JpYmUoaW5qZWN0b3IgPT4ge1xuICAgICAgdGhpcy5pbmplY3RvcnMucHVzaChpbmplY3Rvcik7XG4gICAgfSk7XG4gICAgdGhpcy5yZWZyZXNoJCA9IG1lcmdlKHRoaXMucmVmcmVzaFRyaWdnZXIsIHBsdWdpblNlcnZpY2UucmVmcmVzaCQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZnJlc2ggdGhlIGV4dGVuc2lvbiBmYWN0b3JpZXNcbiAgICovXG4gIHJlZnJlc2goKTogdm9pZCB7XG4gICAgdGhpcy5yZWZyZXNoVHJpZ2dlci5uZXh0KCk7XG4gIH1cblxuICAvKipcbiAgICogU2hvdWxkIGJlIGNhbGxlZCB3aXRoaW4gdGhlIGNvbnN0cnVjdG9yIG9mIHRoZSBleHRlbmRpbmcgY2xhc3MgYW5kIHNldCB0aGUgaXRlbXMkIGF0dHJpYnV0ZS5cbiAgICovXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBzZXR1cEl0ZW1zT2JzZXJ2YWJsZSgpOiBPYnNlcnZhYmxlPFRbXT47XG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBFeHRlbnNpb25Qb2ludEZvclBsdWdpbnM8VD5cbiAgZXh0ZW5kcyBTdGF0ZVNlcnZpY2VcbiAgaW1wbGVtZW50cyBFeHRlbnNpb25Qb2ludDxUPlxue1xuICBpdGVtcyQ6IE9ic2VydmFibGU8VFtdPjtcbiAgZmFjdG9yaWVzOiBFeHRlbnNpb25GYWN0b3J5PFQ+W10gPSBbXTtcbiAgcmVhZG9ubHkgcmVmcmVzaCQ6IE9ic2VydmFibGU8dm9pZD47XG4gIHJlYWRvbmx5IHN0YXRlJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8U2V0PFQ+PihuZXcgU2V0PFQ+KCkpO1xuICAvKipcbiAgICogQWxsIGluamVjdG9ycyB0byBzZWFyY2ggZm9yIGFuIGV4dGVuc2lvbi5cbiAgICovXG4gIHByb3RlY3RlZCBpbmplY3RvcnM6IEluamVjdG9yW107XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVmcmVzaFRyaWdnZXIgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIGNvbnN0cnVjdG9yKHJvb3RJbmplY3RvcjogSW5qZWN0b3IsIHBsdWdpblNlcnZpY2U6IFBsdWdpbnNSZXNvbHZlU2VydmljZSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5pbmplY3RvcnMgPSBbcm9vdEluamVjdG9yXTtcbiAgICBwbHVnaW5TZXJ2aWNlLmluamVjdG9ycyQuc3Vic2NyaWJlKGluamVjdG9yID0+IHtcbiAgICAgIHRoaXMuaW5qZWN0b3JzLnB1c2goaW5qZWN0b3IpO1xuICAgIH0pO1xuICAgIHRoaXMucmVmcmVzaCQgPSBtZXJnZSh0aGlzLnJlZnJlc2hUcmlnZ2VyLCBwbHVnaW5TZXJ2aWNlLnJlZnJlc2gkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWZyZXNoIHRoZSBleHRlbnNpb24gZmFjdG9yaWVzXG4gICAqL1xuICByZWZyZXNoKCk6IHZvaWQge1xuICAgIHRoaXMucmVmcmVzaFRyaWdnZXIubmV4dCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNob3VsZCBiZSBjYWxsZWQgd2l0aGluIHRoZSBjb25zdHJ1Y3RvciBvZiB0aGUgZXh0ZW5kaW5nIGNsYXNzIGFuZCBzZXQgdGhlIGl0ZW1zJCBhdHRyaWJ1dGUuXG4gICAqL1xuICBwcm90ZWN0ZWQgYWJzdHJhY3Qgc2V0dXBJdGVtc09ic2VydmFibGUoKTogT2JzZXJ2YWJsZTxUW10+O1xufVxuXG4vKipcbiAqIEhlbHBlciBmdW5jdGlvbiB0byBnZXQgdGhlIGFjdGl2YXRlZCByb3V0ZSBpblxuICogYSBzZXJ2aWNlIChhcyBBY3RpdmF0ZWRSb3V0ZSBpbmplY3Rpb24gb25seVxuICogd29ya3MgaW4gY29tcG9uZW50cykuIFdvcmtzIGFzIGxvbmcgYXMgd2Ugb25seSB1c2VcbiAqIGEgdHJlZSBhbmQgbm8gY2hpbGQgaXMgYWN0aXZlIGF0IHRoZSBzYW1lIHRpbWUuXG4gKlxuICogQHBhcmFtIHJvdXRlciBUaGUgY3VycmVudCByb3V0ZXJcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEFjdGl2YXRlZFJvdXRlKHJvdXRlcjogUm91dGVyKTogQWN0aXZhdGVkUm91dGUge1xuICBpZiAocm91dGVyICYmIHJvdXRlci5yb3V0ZXJTdGF0ZSAmJiByb3V0ZXIucm91dGVyU3RhdGUucm9vdCkge1xuICAgIGxldCByb3V0ZSA9IHJvdXRlci5yb3V0ZXJTdGF0ZS5yb290O1xuICAgIHdoaWxlIChyb3V0ZS5maXJzdENoaWxkKSB7XG4gICAgICByb3V0ZSA9IHJvdXRlLmZpcnN0Q2hpbGQ7XG4gICAgfVxuICAgIHJldHVybiByb3V0ZTtcbiAgfVxufVxuXG5leHBvcnQgdHlwZSBHZW5lcmljSG9va1R5cGU8VD4gPSBUIHwgVFtdIHwgVHlwZTxFeHRlbnNpb25GYWN0b3J5PFQ+PjtcblxuLyoqXG4gKiBBIGdlbmVyaWMgZnVuY3Rpb24gdG8gYmUgdXNlZCBieSBzcGVjaWZpYyBpbXBsZW1lbnRhdGlvbnMgb2YgdGhlIEhPT0sgY29uY2VwdC5cbiAqIEBwYXJhbSBpdGVtcyBUaGUgaXRlbXMgdGhhdCBzaG91bGQgYmUgcHJvdmlkZWQgdW5kZXIgdGhlIGB1c2VWYWx1ZWAgb3IgYHVzZUNsYXNzYCBhdHRyaWJ1dGUuXG4gKiBAcGFyYW0gdG9rZW4gVGhlIEluamVjdGlvblRva2VuL0hPT0sgdG8gYmUgcHJvdmlkZWQuXG4gKiBAcGFyYW0gbXVsdGkgSWYgdGhpcyBpcyBhIG11bHRpIHByb3ZpZGVyIG9yIG5vdCAoZGVmYXVsdHMgdG8gdHJ1ZSkuXG4gKiBAcmV0dXJucyBBIGBQcm92aWRlcmAgKGVpdGhlciBgVmFsdWVQcm92aWRlcmAgb3IgYENsYXNzUHJvdmlkZXJgKSB0byBiZSBwcm92aWRlZCBpbiBhIG1vZHVsZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGhvb2tHZW5lcmljPFQ+KFxuICBpdGVtczogR2VuZXJpY0hvb2tUeXBlPFQ+LFxuICB0b2tlbjogSW5qZWN0aW9uVG9rZW48VD4sXG4gIG9wdGlvbnM/OiBQYXJ0aWFsPEhvb2tPcHRpb25zPlxuKTogVmFsdWVQcm92aWRlciB8IENsYXNzUHJvdmlkZXIgfCBFeGlzdGluZ1Byb3ZpZGVyIHtcbiAgY29uc3QgZmluYWxPcHRpb25zOiBIb29rT3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oXG4gICAgeyBtdWx0aTogdHJ1ZSwgcHJvdmlkZXJUeXBlOiBIb29rUHJvdmlkZXJUeXBlcy5DbGFzc1Byb3ZpZGVyIH0sXG4gICAgb3B0aW9uc1xuICApO1xuICBjb25zdCB7IG11bHRpLCBwcm92aWRlclR5cGUgfSA9IGZpbmFsT3B0aW9ucztcbiAgaWYgKHR5cGVvZiBpdGVtcyAhPT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiB7XG4gICAgICBwcm92aWRlOiB0b2tlbixcbiAgICAgIHVzZVZhbHVlOiBpdGVtcyxcbiAgICAgIG11bHRpXG4gICAgfSBhcyBWYWx1ZVByb3ZpZGVyO1xuICB9XG5cbiAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gSG9va1Byb3ZpZGVyVHlwZXMuRXhpc3RpbmdQcm92aWRlcikge1xuICAgIHJldHVybiB7XG4gICAgICBwcm92aWRlOiB0b2tlbixcbiAgICAgIHVzZUV4aXN0aW5nOiBpdGVtcyBhcyBUeXBlPEV4dGVuc2lvbkZhY3Rvcnk8VD4+LFxuICAgICAgbXVsdGlcbiAgICB9IGFzIEV4aXN0aW5nUHJvdmlkZXI7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHByb3ZpZGU6IHRva2VuLFxuICAgIHVzZUNsYXNzOiBpdGVtcyBhcyBUeXBlPEV4dGVuc2lvbkZhY3Rvcnk8VD4+LFxuICAgIG11bHRpXG4gIH0gYXMgQ2xhc3NQcm92aWRlcjtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgSG9va09wdGlvbnMge1xuICBtdWx0aTogYm9vbGVhbjtcbiAgcHJvdmlkZXJUeXBlOiBIb29rUHJvdmlkZXJUeXBlcztcbn1cblxuZXhwb3J0IGVudW0gSG9va1Byb3ZpZGVyVHlwZXMge1xuICBFeGlzdGluZ1Byb3ZpZGVyID0gJ0V4aXN0aW5nUHJvdmlkZXInLFxuICBDbGFzc1Byb3ZpZGVyID0gJ0NsYXNzUHJvdmlkZXInXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhbGxFbnRyaWVzQXJlRXF1YWwocHJldmlvdXM6IEFycmF5PHVua25vd24+LCBuZXh0OiBBcnJheTx1bmtub3duPik6IGJvb2xlYW4ge1xuICBpZiAocHJldmlvdXMgPT09IG5leHQpIHJldHVybiB0cnVlO1xuICBpZiAocHJldmlvdXMgPT0gbnVsbCB8fCBuZXh0ID09IG51bGwpIHJldHVybiBmYWxzZTtcbiAgaWYgKHByZXZpb3VzLmxlbmd0aCAhPT0gbmV4dC5sZW5ndGgpIHJldHVybiBmYWxzZTtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IHByZXZpb3VzLmxlbmd0aDsgKytpKSB7XG4gICAgaWYgKHByZXZpb3VzW2ldICE9PSBuZXh0W2ldKSByZXR1cm4gZmFsc2U7XG4gIH1cbiAgcmV0dXJuIHRydWU7XG59XG4iXX0=