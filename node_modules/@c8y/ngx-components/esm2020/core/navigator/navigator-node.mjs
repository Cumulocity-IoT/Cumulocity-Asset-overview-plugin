import { matches, snakeCase } from 'lodash-es';
/**
 * Base navigator node. Represents a single entry in the navigator menu.
 * Is considered to be the basic building block of the navigator.
 */
export class NavigatorNode {
    /**
     * @ignore
     */
    constructor(data) {
        /**
         * Navigator node children (subentries).
         */
        this.children = [];
        /**
         * Navigator node parent nodes.
         */
        this.parents = [];
        /**
         * Indicates whether the navigator node should be active based on matching the node path and the URL path.
         * To match the URL exactly, set this option to true.
         *
         * routerLinkExact set to true:
         * When the URL path is set to /a/b/c and the node path to /a/b then the node will not be set active.
         *
         * routerLinkExact set to false:
         * When the URL path is set to /a/b/c and the node path to /a/b then the node will be set active.
         */
        this.routerLinkExact = true;
        /**
         * Indicates that the navigator node is expanded/collapsed.
         */
        this.open = false;
        /**
         * Indicates that the navigator node is visible/hidden.
         */
        this.hidden = false;
        /**
         * Indicates that the navigator node is draggable.
         */
        this.draggable = false;
        /**
         * Indicates that the navigator node is droppable.
         */
        this.droppable = false;
        /**
         * Indicates that the navigator node is dragged.
         */
        this.dragged = false;
        /**
         * Indicates that currently something is dragged over the node.
         */
        this.draggedHover = false;
        /**
         * Confirmation popover displayed at the end of the process of moving the navigator menu item.
         */
        this.confirm = undefined;
        this._priority = 0;
        this.update(data);
    }
    /**
     * Returns information whether a navigator node has children.
     * @readonly
     */
    get hasChildren() {
        return this.children.length > 0;
    }
    /**
     * Returns the ID of the navigator node.
     * @readonly
     */
    get id() {
        return 'navigator_node_' + snakeCase(this.label);
    }
    /**
     * Returns the priority value of the navigator node.
     * @readonly
     */
    get priority() {
        if (this._priority) {
            return this._priority;
        }
        else {
            const childrenPriorities = this.children.map(({ priority }) => priority || 0);
            if (childrenPriorities.length) {
                return childrenPriorities.length ? Math.max(...childrenPriorities) : 0;
            }
            return 0;
        }
    }
    /**
     * Sets the priority value of the navigator node.
     *
     * @param {number} priority Priority value.
     */
    set priority(priority) {
        this._priority = priority;
    }
    /**
     * @ignore
     */
    openOnStart(_url) {
        return false;
    }
    /**
     * Adds a child navigator node to the node.
     *
     * @param {NavigatorNode} node Child node.
     */
    add(node) {
        if (node === this) {
            throw new Error('Adding node to itself');
        }
        if (this.children.indexOf(node) === -1) {
            this.children.push(node);
        }
        if (node.parents.indexOf(this) === -1) {
            node.parents.push(this);
        }
        this.updateChildren();
    }
    /**
     * Removes the child navigator node from the node.
     *
     * @param {NavigatorNode} node Child node.
     */
    remove(node) {
        const ix = this.children.indexOf(node);
        const pix = node.parents.indexOf(this);
        if (ix > -1) {
            this.children.splice(ix, 1);
        }
        if (pix > -1) {
            node.parents.splice(pix, 1);
        }
        this.updateChildren();
    }
    /**
     * Updates the navigator node.
     *
     * @param {NavigatorNodeData} data Data to be updated.
     */
    update(data) {
        if (data) {
            Object.assign(this, data);
            if (data.hidden !== undefined) {
                this.parents.forEach(p => {
                    p.updateHidden();
                });
            }
        }
    }
    /**
     * Returns a child navigator node based on the predicate.
     *
     * @param {string|object} predicate Filter criteria.
     * @param {string} findBy NavigatorNode field name to compare.
     *
     * @example
     * ```ts
     * // The function will compare the labels to the string and return a matching result.
     * // The capitalization of the characters does not matter (case insensitive).
     * const predicate = 'group1';
     * const childNode = parentNode.find(predicate);
     *
     * // Check: [lodash matches](https://lodash.com/docs/4.17.15#matches)
     * const predicate = { label: 'group2' };
     * const childNode = parentNode.find(predicate);
     * ```
     */
    find(predicate, findBy = 'label') {
        if (typeof predicate === 'string') {
            if (findBy === 'label') {
                const compareLabel = predicate.toLocaleLowerCase();
                predicate = ({ label }) => compareLabel === label.toLowerCase();
            }
            else {
                const compareId = predicate;
                predicate = ({ featureId }) => compareId === featureId;
            }
        }
        if (typeof predicate === 'object') {
            predicate = matches(predicate);
        }
        if (typeof predicate !== 'function') {
            throw new Error('Invalid search predicate');
        }
        return this.children.reduce((found, child) => found || child.find(predicate), this.children.find(predicate));
    }
    /**
     * Removes children nodes.
     */
    empty() {
        this.children.length = 0;
    }
    /**
     * @ignore
     */
    click(_options = {}) {
        // do nothing
    }
    /**
     * This event is fired when an element is dropped on a valid drop target.
     * @param $event DOM event.
     */
    drop($event) {
        $event.stopPropagation();
        clearTimeout(this.expandDragTimeout);
    }
    /**
     * This event is fired when the user starts dragging an element.
     * @param $event DOM event.
     */
    dragStart($event) {
        $event.stopPropagation();
        // we can't pass a object to setData, so we do it via service
        // set data is still needed, to make the drag&drop work
        $event.dataTransfer?.setData('node', 'node');
        this.dragged = true;
    }
    /**
     * This event is fired when a drag operation has ended.
     * @param $event DOM event.
     */
    dragEnd($event) {
        $event.stopPropagation();
        this.dragged = false;
    }
    /**
     * Returns information whether the navigator node is droppable.
     * @readonly
     */
    get canDrop() {
        return this.droppable;
    }
    /**
     * Returns information whether navigation is possible.
     * @readonly
     */
    get canNavigate() {
        return typeof this.path !== 'undefined';
    }
    /**
     * This event is fired when a dragged element enters a valid drop target.
     * @param $event DOM event.
     */
    dragEnter($event) {
        $event.preventDefault();
        $event.stopPropagation();
        this.draggedHover = true;
        if (!this.open) {
            this.expandDragTimeout = setTimeout(() => this.expand(), 1000);
        }
    }
    /**
     * This event is fired when a dragged element leaves a valid drop target.
     * @param $event DOM event.
     */
    dragLeave($event) {
        $event.preventDefault();
        $event.stopPropagation();
        this.draggedHover = false;
        clearTimeout(this.expandDragTimeout);
    }
    /**
     * Expands the navigator node if it is collapsed.
     */
    expand() {
        if (!this.open) {
            this.open = true;
            this.click({ open: true, expander: true });
        }
    }
    /**
     * Performs a callback function recursively on each of the navigator node's children down the hierarchy.
     * @param {function} callback Function to be called.
     *
     * @example
     * ```ts
     * const expandChild = (childNode) => childNode.expand();
     * parentNode.traverse(expandChild);
     * ```
     */
    traverse(callback) {
        if (this.children) {
            this.children.forEach(child => {
                callback(child);
                child.traverse(callback);
            });
        }
    }
    /**
     * @ignore
     */
    destroy() {
        // nothing todo here
    }
    /**
     * Counts the amount of children nodes.
     */
    countChildren() {
        return this.children.length;
    }
    /**
     * Identifies itself.
     */
    toString() {
        return NavigatorNode.NAME;
    }
    hasChildDevices() {
        return false;
    }
    /**
     * Updates the navigator node by sorting its children and also checking their visibility.
     */
    updateChildren() {
        this.sort();
        this.updateHidden();
    }
    /**
     * Sorts the children of the navigator node, by priority and name (ASC).
     * The higher the priority, the higher the position in the hierarchy.
     * For the same priority values, the alphabetical order will take precedence.
     */
    sort() {
        this.children.sort((a, b) => {
            if (a.priority > b.priority) {
                return -1;
            }
            else if (a.priority < b.priority) {
                return 1;
            }
            else if ((a.label || '').toLowerCase() < (b.label || '').toLowerCase()) {
                return -1;
            }
            else if ((a.label || '').toLowerCase() > (b.label || '').toLowerCase()) {
                return 1;
            }
            else {
                return 0;
            }
        });
    }
    /**
     * Checks if the navigator node should be hidden based on the visibility of its child nodes.
     */
    updateHidden() {
        if (typeof this.path === 'undefined') {
            this.hidden = !this.children.some(({ hidden }) => !hidden);
        }
    }
}
NavigatorNode.NAME = 'NavigatorNode';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdG9yLW5vZGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9jb3JlL25hdmlnYXRvci9uYXZpZ2F0b3Itbm9kZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQTZCL0M7OztHQUdHO0FBQ0gsTUFBTSxPQUFPLGFBQWE7SUErSnhCOztPQUVHO0lBQ0gsWUFBWSxJQUF3QjtRQTVJcEM7O1dBRUc7UUFDSCxhQUFRLEdBQW9CLEVBQUUsQ0FBQztRQVkvQjs7V0FFRztRQUNILFlBQU8sR0FBb0IsRUFBRSxDQUFDO1FBaUI5Qjs7Ozs7Ozs7O1dBU0c7UUFDSCxvQkFBZSxHQUFHLElBQUksQ0FBQztRQUV2Qjs7V0FFRztRQUNILFNBQUksR0FBRyxLQUFLLENBQUM7UUFFYjs7V0FFRztRQUNILFdBQU0sR0FBRyxLQUFLLENBQUM7UUFFZjs7V0FFRztRQUNILGNBQVMsR0FBRyxLQUFLLENBQUM7UUFFbEI7O1dBRUc7UUFDSCxjQUFTLEdBQUcsS0FBSyxDQUFDO1FBRWxCOztXQUVHO1FBQ0gsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUVoQjs7V0FFRztRQUNILGlCQUFZLEdBQUcsS0FBSyxDQUFDO1FBRXJCOztXQUVHO1FBQ0gsWUFBTyxHQUE0QixTQUFTLENBQUM7UUFhckMsY0FBUyxHQUFHLENBQUMsQ0FBQztRQWdEcEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBOUNEOzs7T0FHRztJQUNILElBQUksV0FBVztRQUNiLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFRDs7O09BR0c7SUFDSCxJQUFJLEVBQUU7UUFDSixPQUFPLGlCQUFpQixHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVE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QUFDO2FBQ1Y7aUJBQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFO2dCQUN4RSxPQUFPLENBQUMsQ0FBQyxDQUFDO2FBQ1g7aUJBQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFO2dCQUN4RSxPQUFPLENBQUMsQ0FBQzthQUNWO2lCQUFNO2dCQUNMLE9BQU8sQ0FBQyxDQUFDO2FBQ1Y7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNPLFlBQVk7UUFDcEIsSUFBSSxPQUFPLElBQUksQ0FBQyxJQUFJLEtBQUssV0FBVyxFQUFFO1lBQ3BDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDNUQ7SUFDSCxDQUFDOztBQXJiTSxrQkFBSSxHQUFHLGVBQWUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdG9yLCBUZW1wbGF0ZVJlZiwgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgbWF0Y2hlcywgc25ha2VDYXNlIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IE5hdmlnYXRvck5vZGVEYXRhIH0gZnJvbSAnLi9uYXZpZ2F0b3Itbm9kZS1kYXRhJztcbmltcG9ydCB7IFBvcG92ZXJDb25maXJtQ29tcG9uZW50IH0gZnJvbSAnLi4vbW9kYWwvcG9wb3Zlci1jb25maXJtLmNvbXBvbmVudCc7XG5cbi8qKlxuICogSW50ZXJmYWNlIHRoYXQgZGV0ZXJtaW5lcyB0aGUgYXZhaWxhYmxlIGNsaWNrIG9wdGlvbnMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ2xpY2tPcHRpb25zIHtcbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IHRoZSBzb3VyY2Ugb2YgdGhlIGV2ZW50IGlzIGEgY2xpY2sgb24gdGhlIG5vZGUgaWNvbi5cbiAgICovXG4gIGljb24/OiBib29sZWFuO1xuICAvKipcbiAgICogSW5kaWNhdGVzIHRoYXQgdGhlIHNvdXJjZSBvZiB0aGUgZXZlbnQgaXMgYSBjbGljayBvbiB0aGUgbm9kZSBleHBhbmRlci5cbiAgICovXG4gIGV4cGFuZGVyPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IHRoZSBuYXZpZ2F0b3Igbm9kZSBpcyBleHBhbmRlZC9jb2xsYXBzZWQuXG4gICAqL1xuICBvcGVuPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBuZXcgZ3JvdXAgbm9kZSB3aGljaCB3aWxsIGNvbnRhaW4gYWxsIHVuYXNzaWduZWQgZGV2aWNlcy5cbiAgICovXG4gIHNob3dVbmFzc2lnbmVkRGV2aWNlcz86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBET00gZXZlbnQuXG4gICAqL1xuICAkZXZlbnQ/OiBhbnk7IC8vIFRPRE86IGFkZCBwcm9wZXIgdHlwZVxufVxuLyoqXG4gKiBCYXNlIG5hdmlnYXRvciBub2RlLiBSZXByZXNlbnRzIGEgc2luZ2xlIGVudHJ5IGluIHRoZSBuYXZpZ2F0b3IgbWVudS5cbiAqIElzIGNvbnNpZGVyZWQgdG8gYmUgdGhlIGJhc2ljIGJ1aWxkaW5nIGJsb2NrIG9mIHRoZSBuYXZpZ2F0b3IuXG4gKi9cbmV4cG9ydCBjbGFzcyBOYXZpZ2F0b3JOb2RlIHtcbiAgc3RhdGljIE5BTUUgPSAnTmF2aWdhdG9yTm9kZSc7XG4gIC8qKlxuICAgKiBOYXZpZ2F0b3Igbm9kZSBpY29uLlxuICAgKi9cbiAgaWNvbjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBOYXZpZ2F0b3Igbm9kZSBpY29uIHdoZW4gZXhwYW5kZWQuXG4gICAqL1xuICBpY29uT3Blbjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBDdXN0b20gaWNvbiB0ZW1wbGF0ZS5cbiAgICovXG4gIGljb25UZW1wbGF0ZT86IFRlbXBsYXRlUmVmPGFueT47XG5cbiAgLyoqXG4gICAqIEN1c3RvbSBpY29uIGNvbXBvbmVudC5cbiAgICovXG4gIGljb25Db21wb25lbnQ/OiBUeXBlPGFueT47XG5cbiAgLyoqXG4gICAqIE5hdmlnYXRvciBub2RlIGNoaWxkcmVuIChzdWJlbnRyaWVzKS5cbiAgICovXG4gIGNoaWxkcmVuOiBOYXZpZ2F0b3JOb2RlW10gPSBbXTtcblxuICAvKipcbiAgICogTGFiZWwgdG8gYmUgZGlzcGxheWVkIGluIHRoZSBuYXZpZ2F0b3Igbm9kZS5cbiAgICovXG4gIGxhYmVsO1xuXG4gIC8qKlxuICAgKiBUaGUgcGF0aCB0byB3aGljaCB0aGUgVUkgd2lsbCBiZSByZWRpcmVjdGVkIGFmdGVyIGNsaWNraW5nIHRoZSBuYXZpZ2F0b3Igbm9kZS5cbiAgICovXG4gIHBhdGg6IHN0cmluZztcblxuICAvKipcbiAgICogTmF2aWdhdG9yIG5vZGUgcGFyZW50IG5vZGVzLlxuICAgKi9cbiAgcGFyZW50czogTmF2aWdhdG9yTm9kZVtdID0gW107XG5cbiAgLyoqXG4gICAqIExvYWRpbmcgc3RhdGUgaW5kaWNhdG9yLlxuICAgKi9cbiAgbG9hZGluZz86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIFVzZWQgdG8gbG9hZCB0aGUgcHJvdmlkZXJzIGZvciB0aGUgY29tcG9uZW50cy4gSWYgbm90IHByb3ZpZGVkLCBkZWZhdWx0IGluamVjdG9yIHVzIHVzZWQuXG4gICAqL1xuICBpbmplY3Rvcj86IEluamVjdG9yO1xuXG4gIC8qKlxuICAgKiBDdXN0b20gY29tcG9uZW50IHRvIHVzZS5cbiAgICovXG4gIGNvbXBvbmVudD86IFR5cGU8YW55PjtcblxuICAvKipcbiAgICogSW5kaWNhdGVzIHdoZXRoZXIgdGhlIG5hdmlnYXRvciBub2RlIHNob3VsZCBiZSBhY3RpdmUgYmFzZWQgb24gbWF0Y2hpbmcgdGhlIG5vZGUgcGF0aCBhbmQgdGhlIFVSTCBwYXRoLlxuICAgKiBUbyBtYXRjaCB0aGUgVVJMIGV4YWN0bHksIHNldCB0aGlzIG9wdGlvbiB0byB0cnVlLlxuICAgKlxuICAgKiByb3V0ZXJMaW5rRXhhY3Qgc2V0IHRvIHRydWU6XG4gICAqIFdoZW4gdGhlIFVSTCBwYXRoIGlzIHNldCB0byAvYS9iL2MgYW5kIHRoZSBub2RlIHBhdGggdG8gL2EvYiB0aGVuIHRoZSBub2RlIHdpbGwgbm90IGJlIHNldCBhY3RpdmUuXG4gICAqXG4gICAqIHJvdXRlckxpbmtFeGFjdCBzZXQgdG8gZmFsc2U6XG4gICAqIFdoZW4gdGhlIFVSTCBwYXRoIGlzIHNldCB0byAvYS9iL2MgYW5kIHRoZSBub2RlIHBhdGggdG8gL2EvYiB0aGVuIHRoZSBub2RlIHdpbGwgYmUgc2V0IGFjdGl2ZS5cbiAgICovXG4gIHJvdXRlckxpbmtFeGFjdCA9IHRydWU7XG5cbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IHRoZSBuYXZpZ2F0b3Igbm9kZSBpcyBleHBhbmRlZC9jb2xsYXBzZWQuXG4gICAqL1xuICBvcGVuID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IHRoZSBuYXZpZ2F0b3Igbm9kZSBpcyB2aXNpYmxlL2hpZGRlbi5cbiAgICovXG4gIGhpZGRlbiA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBJbmRpY2F0ZXMgdGhhdCB0aGUgbmF2aWdhdG9yIG5vZGUgaXMgZHJhZ2dhYmxlLlxuICAgKi9cbiAgZHJhZ2dhYmxlID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IHRoZSBuYXZpZ2F0b3Igbm9kZSBpcyBkcm9wcGFibGUuXG4gICAqL1xuICBkcm9wcGFibGUgPSBmYWxzZTtcblxuICAvKipcbiAgICogSW5kaWNhdGVzIHRoYXQgdGhlIG5hdmlnYXRvciBub2RlIGlzIGRyYWdnZWQuXG4gICAqL1xuICBkcmFnZ2VkID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IGN1cnJlbnRseSBzb21ldGhpbmcgaXMgZHJhZ2dlZCBvdmVyIHRoZSBub2RlLlxuICAgKi9cbiAgZHJhZ2dlZEhvdmVyID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIENvbmZpcm1hdGlvbiBwb3BvdmVyIGRpc3BsYXllZCBhdCB0aGUgZW5kIG9mIHRoZSBwcm9jZXNzIG9mIG1vdmluZyB0aGUgbmF2aWdhdG9yIG1lbnUgaXRlbS5cbiAgICovXG4gIGNvbmZpcm06IFBvcG92ZXJDb25maXJtQ29tcG9uZW50ID0gdW5kZWZpbmVkO1xuXG4gIC8qKlxuICAgKiBUaGUgYnJlYWRjcnVtYiBvZiB0aGUgbm9kZSwgZGlzcGxheWluZyB0aGUgXCJwYXRoXCIsIGJ1dCBzdXBwb3J0cyBtdWx0aXBsZSBsZXZlbHMuXG4gICAqIGUuZy4gKEdyb3VwcyA+IExldmVsIDEgPiBMZXZlbCAyKVxuICAgKi9cbiAgYnJlYWRjcnVtYj86IHN0cmluZztcblxuICAvKipcbiAgICogSWQgdG8gaWRlbnRpZnkgc3BlY2lmaWMgZmVhdHVyZSBub2RlLlxuICAgKi9cbiAgZmVhdHVyZUlkPzogc3RyaW5nO1xuXG4gIHByaXZhdGUgX3ByaW9yaXR5ID0gMDtcbiAgcHJpdmF0ZSBleHBhbmREcmFnVGltZW91dDtcblxuICAvKipcbiAgICogUmV0dXJucyBpbmZvcm1hdGlvbiB3aGV0aGVyIGEgbmF2aWdhdG9yIG5vZGUgaGFzIGNoaWxkcmVuLlxuICAgKiBAcmVhZG9ubHlcbiAgICovXG4gIGdldCBoYXNDaGlsZHJlbigpIHtcbiAgICByZXR1cm4gdGhpcy5jaGlsZHJlbi5sZW5ndGggPiAwO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIElEIG9mIHRoZSBuYXZpZ2F0b3Igbm9kZS5cbiAgICogQHJlYWRvbmx5XG4gICAqL1xuICBnZXQgaWQoKSB7XG4gICAgcmV0dXJuICduYXZpZ2F0b3Jfbm9kZV8nICsgc25ha2VDYXNlKHRoaXMubGFiZWwpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHByaW9yaXR5IHZhbHVlIG9mIHRoZSBuYXZpZ2F0b3Igbm9kZS5cbiAgICogQHJlYWRvbmx5XG4gICAqL1xuICBnZXQgcHJpb3JpdHkoKSB7XG4gICAgaWYgKHRoaXMuX3ByaW9yaXR5KSB7XG4gICAgICByZXR1cm4gdGhpcy5fcHJpb3JpdHk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGNoaWxkcmVuUHJpb3JpdGllcyA9IHRoaXMuY2hpbGRyZW4ubWFwKCh7IHByaW9yaXR5IH0pID0+IHByaW9yaXR5IHx8IDApO1xuICAgICAgaWYgKGNoaWxkcmVuUHJpb3JpdGllcy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIGNoaWxkcmVuUHJpb3JpdGllcy5sZW5ndGggPyBNYXRoLm1heCguLi5jaGlsZHJlblByaW9yaXRpZXMpIDogMDtcbiAgICAgIH1cbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSBwcmlvcml0eSB2YWx1ZSBvZiB0aGUgbmF2aWdhdG9yIG5vZGUuXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBwcmlvcml0eSBQcmlvcml0eSB2YWx1ZS5cbiAgICovXG4gIHNldCBwcmlvcml0eShwcmlvcml0eSkge1xuICAgIHRoaXMuX3ByaW9yaXR5ID0gcHJpb3JpdHk7XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgY29uc3RydWN0b3IoZGF0YT86IE5hdmlnYXRvck5vZGVEYXRhKSB7XG4gICAgdGhpcy51cGRhdGUoZGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgb3Blbk9uU3RhcnQoX3VybDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBjaGlsZCBuYXZpZ2F0b3Igbm9kZSB0byB0aGUgbm9kZS5cbiAgICpcbiAgICogQHBhcmFtIHtOYXZpZ2F0b3JOb2RlfSBub2RlIENoaWxkIG5vZGUuXG4gICAqL1xuICBhZGQobm9kZTogTmF2aWdhdG9yTm9kZSkge1xuICAgIGlmIChub2RlID09PSB0aGlzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FkZGluZyBub2RlIHRvIGl0c2VsZicpO1xuICAgIH1cbiAgICBpZiAodGhpcy5jaGlsZHJlbi5pbmRleE9mKG5vZGUpID09PSAtMSkge1xuICAgICAgdGhpcy5jaGlsZHJlbi5wdXNoKG5vZGUpO1xuICAgIH1cbiAgICBpZiAobm9kZS5wYXJlbnRzLmluZGV4T2YodGhpcykgPT09IC0xKSB7XG4gICAgICBub2RlLnBhcmVudHMucHVzaCh0aGlzKTtcbiAgICB9XG4gICAgdGhpcy51cGRhdGVDaGlsZHJlbigpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgdGhlIGNoaWxkIG5hdmlnYXRvciBub2RlIGZyb20gdGhlIG5vZGUuXG4gICAqXG4gICAqIEBwYXJhbSB7TmF2aWdhdG9yTm9kZX0gbm9kZSBDaGlsZCBub2RlLlxuICAgKi9cbiAgcmVtb3ZlKG5vZGU6IE5hdmlnYXRvck5vZGUpIHtcbiAgICBjb25zdCBpeCA9IHRoaXMuY2hpbGRyZW4uaW5kZXhPZihub2RlKTtcbiAgICBjb25zdCBwaXggPSBub2RlLnBhcmVudHMuaW5kZXhPZih0aGlzKTtcbiAgICBpZiAoaXggPiAtMSkge1xuICAgICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaXgsIDEpO1xuICAgIH1cbiAgICBpZiAocGl4ID4gLTEpIHtcbiAgICAgIG5vZGUucGFyZW50cy5zcGxpY2UocGl4LCAxKTtcbiAgICB9XG4gICAgdGhpcy51cGRhdGVDaGlsZHJlbigpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgdGhlIG5hdmlnYXRvciBub2RlLlxuICAgKlxuICAgKiBAcGFyYW0ge05hdmlnYXRvck5vZGVEYXRhfSBkYXRhIERhdGEgdG8gYmUgdXBkYXRlZC5cbiAgICovXG4gIHVwZGF0ZShkYXRhPzogTmF2aWdhdG9yTm9kZURhdGEpIHtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLCBkYXRhKTtcbiAgICAgIGlmIChkYXRhLmhpZGRlbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMucGFyZW50cy5mb3JFYWNoKHAgPT4ge1xuICAgICAgICAgIHAudXBkYXRlSGlkZGVuKCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGEgY2hpbGQgbmF2aWdhdG9yIG5vZGUgYmFzZWQgb24gdGhlIHByZWRpY2F0ZS5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSBwcmVkaWNhdGUgRmlsdGVyIGNyaXRlcmlhLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gZmluZEJ5IE5hdmlnYXRvck5vZGUgZmllbGQgbmFtZSB0byBjb21wYXJlLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGB0c1xuICAgKiAvLyBUaGUgZnVuY3Rpb24gd2lsbCBjb21wYXJlIHRoZSBsYWJlbHMgdG8gdGhlIHN0cmluZyBhbmQgcmV0dXJuIGEgbWF0Y2hpbmcgcmVzdWx0LlxuICAgKiAvLyBUaGUgY2FwaXRhbGl6YXRpb24gb2YgdGhlIGNoYXJhY3RlcnMgZG9lcyBub3QgbWF0dGVyIChjYXNlIGluc2Vuc2l0aXZlKS5cbiAgICogY29uc3QgcHJlZGljYXRlID0gJ2dyb3VwMSc7XG4gICAqIGNvbnN0IGNoaWxkTm9kZSA9IHBhcmVudE5vZGUuZmluZChwcmVkaWNhdGUpO1xuICAgKlxuICAgKiAvLyBDaGVjazogW2xvZGFzaCBtYXRjaGVzXShodHRwczovL2xvZGFzaC5jb20vZG9jcy80LjE3LjE1I21hdGNoZXMpXG4gICAqIGNvbnN0IHByZWRpY2F0ZSA9IHsgbGFiZWw6ICdncm91cDInIH07XG4gICAqIGNvbnN0IGNoaWxkTm9kZSA9IHBhcmVudE5vZGUuZmluZChwcmVkaWNhdGUpO1xuICAgKiBgYGBcbiAgICovXG4gIGZpbmQocHJlZGljYXRlLCBmaW5kQnk6IGtleW9mIFBpY2s8TmF2aWdhdG9yTm9kZSwgJ2xhYmVsJyB8ICdmZWF0dXJlSWQnPiA9ICdsYWJlbCcpIHtcbiAgICBpZiAodHlwZW9mIHByZWRpY2F0ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGlmIChmaW5kQnkgPT09ICdsYWJlbCcpIHtcbiAgICAgICAgY29uc3QgY29tcGFyZUxhYmVsID0gcHJlZGljYXRlLnRvTG9jYWxlTG93ZXJDYXNlKCk7XG4gICAgICAgIHByZWRpY2F0ZSA9ICh7IGxhYmVsIH0pID0+IGNvbXBhcmVMYWJlbCA9PT0gbGFiZWwudG9Mb3dlckNhc2UoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGNvbXBhcmVJZCA9IHByZWRpY2F0ZTtcbiAgICAgICAgcHJlZGljYXRlID0gKHsgZmVhdHVyZUlkIH0pID0+IGNvbXBhcmVJZCA9PT0gZmVhdHVyZUlkO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodHlwZW9mIHByZWRpY2F0ZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIHByZWRpY2F0ZSA9IG1hdGNoZXMocHJlZGljYXRlKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBwcmVkaWNhdGUgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzZWFyY2ggcHJlZGljYXRlJyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmNoaWxkcmVuLnJlZHVjZShcbiAgICAgIChmb3VuZCwgY2hpbGQpID0+IGZvdW5kIHx8IGNoaWxkLmZpbmQocHJlZGljYXRlKSxcbiAgICAgIHRoaXMuY2hpbGRyZW4uZmluZChwcmVkaWNhdGUpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIGNoaWxkcmVuIG5vZGVzLlxuICAgKi9cbiAgZW1wdHkoKSB7XG4gICAgdGhpcy5jaGlsZHJlbi5sZW5ndGggPSAwO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGNsaWNrKF9vcHRpb25zOiBDbGlja09wdGlvbnMgPSB7fSkge1xuICAgIC8vIGRvIG5vdGhpbmdcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gYW4gZWxlbWVudCBpcyBkcm9wcGVkIG9uIGEgdmFsaWQgZHJvcCB0YXJnZXQuXG4gICAqIEBwYXJhbSAkZXZlbnQgRE9NIGV2ZW50LlxuICAgKi9cbiAgZHJvcCgkZXZlbnQpIHtcbiAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgY2xlYXJUaW1lb3V0KHRoaXMuZXhwYW5kRHJhZ1RpbWVvdXQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiB0aGUgdXNlciBzdGFydHMgZHJhZ2dpbmcgYW4gZWxlbWVudC5cbiAgICogQHBhcmFtICRldmVudCBET00gZXZlbnQuXG4gICAqL1xuICBkcmFnU3RhcnQoJGV2ZW50KSB7XG4gICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIC8vIHdlIGNhbid0IHBhc3MgYSBvYmplY3QgdG8gc2V0RGF0YSwgc28gd2UgZG8gaXQgdmlhIHNlcnZpY2VcbiAgICAvLyBzZXQgZGF0YSBpcyBzdGlsbCBuZWVkZWQsIHRvIG1ha2UgdGhlIGRyYWcmZHJvcCB3b3JrXG4gICAgJGV2ZW50LmRhdGFUcmFuc2Zlcj8uc2V0RGF0YSgnbm9kZScsICdub2RlJyk7XG4gICAgdGhpcy5kcmFnZ2VkID0gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gYSBkcmFnIG9wZXJhdGlvbiBoYXMgZW5kZWQuXG4gICAqIEBwYXJhbSAkZXZlbnQgRE9NIGV2ZW50LlxuICAgKi9cbiAgZHJhZ0VuZCgkZXZlbnQpIHtcbiAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5kcmFnZ2VkID0gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBpbmZvcm1hdGlvbiB3aGV0aGVyIHRoZSBuYXZpZ2F0b3Igbm9kZSBpcyBkcm9wcGFibGUuXG4gICAqIEByZWFkb25seVxuICAgKi9cbiAgZ2V0IGNhbkRyb3AoKSB7XG4gICAgcmV0dXJuIHRoaXMuZHJvcHBhYmxlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgaW5mb3JtYXRpb24gd2hldGhlciBuYXZpZ2F0aW9uIGlzIHBvc3NpYmxlLlxuICAgKiBAcmVhZG9ubHlcbiAgICovXG4gIGdldCBjYW5OYXZpZ2F0ZSgpIHtcbiAgICByZXR1cm4gdHlwZW9mIHRoaXMucGF0aCAhPT0gJ3VuZGVmaW5lZCc7XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBldmVudCBpcyBmaXJlZCB3aGVuIGEgZHJhZ2dlZCBlbGVtZW50IGVudGVycyBhIHZhbGlkIGRyb3AgdGFyZ2V0LlxuICAgKiBAcGFyYW0gJGV2ZW50IERPTSBldmVudC5cbiAgICovXG4gIGRyYWdFbnRlcigkZXZlbnQpIHtcbiAgICAkZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5kcmFnZ2VkSG92ZXIgPSB0cnVlO1xuICAgIGlmICghdGhpcy5vcGVuKSB7XG4gICAgICB0aGlzLmV4cGFuZERyYWdUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLmV4cGFuZCgpLCAxMDAwKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBldmVudCBpcyBmaXJlZCB3aGVuIGEgZHJhZ2dlZCBlbGVtZW50IGxlYXZlcyBhIHZhbGlkIGRyb3AgdGFyZ2V0LlxuICAgKiBAcGFyYW0gJGV2ZW50IERPTSBldmVudC5cbiAgICovXG4gIGRyYWdMZWF2ZSgkZXZlbnQpIHtcbiAgICAkZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5kcmFnZ2VkSG92ZXIgPSBmYWxzZTtcbiAgICBjbGVhclRpbWVvdXQodGhpcy5leHBhbmREcmFnVGltZW91dCk7XG4gIH1cblxuICAvKipcbiAgICogRXhwYW5kcyB0aGUgbmF2aWdhdG9yIG5vZGUgaWYgaXQgaXMgY29sbGFwc2VkLlxuICAgKi9cbiAgZXhwYW5kKCkge1xuICAgIGlmICghdGhpcy5vcGVuKSB7XG4gICAgICB0aGlzLm9wZW4gPSB0cnVlO1xuICAgICAgdGhpcy5jbGljayh7IG9wZW46IHRydWUsIGV4cGFuZGVyOiB0cnVlIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtcyBhIGNhbGxiYWNrIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5IG9uIGVhY2ggb2YgdGhlIG5hdmlnYXRvciBub2RlJ3MgY2hpbGRyZW4gZG93biB0aGUgaGllcmFyY2h5LlxuICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayBGdW5jdGlvbiB0byBiZSBjYWxsZWQuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYHRzXG4gICAqIGNvbnN0IGV4cGFuZENoaWxkID0gKGNoaWxkTm9kZSkgPT4gY2hpbGROb2RlLmV4cGFuZCgpO1xuICAgKiBwYXJlbnROb2RlLnRyYXZlcnNlKGV4cGFuZENoaWxkKTtcbiAgICogYGBgXG4gICAqL1xuICB0cmF2ZXJzZShjYWxsYmFjaykge1xuICAgIGlmICh0aGlzLmNoaWxkcmVuKSB7XG4gICAgICB0aGlzLmNoaWxkcmVuLmZvckVhY2goY2hpbGQgPT4ge1xuICAgICAgICBjYWxsYmFjayhjaGlsZCk7XG4gICAgICAgIGNoaWxkLnRyYXZlcnNlKGNhbGxiYWNrKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBkZXN0cm95KCkge1xuICAgIC8vIG5vdGhpbmcgdG9kbyBoZXJlXG4gIH1cblxuICAvKipcbiAgICogQ291bnRzIHRoZSBhbW91bnQgb2YgY2hpbGRyZW4gbm9kZXMuXG4gICAqL1xuICBwcm90ZWN0ZWQgY291bnRDaGlsZHJlbigpIHtcbiAgICByZXR1cm4gdGhpcy5jaGlsZHJlbi5sZW5ndGg7XG4gIH1cblxuICAvKipcbiAgICogSWRlbnRpZmllcyBpdHNlbGYuXG4gICAqL1xuICBwcm90ZWN0ZWQgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuIE5hdmlnYXRvck5vZGUuTkFNRTtcbiAgfVxuXG4gIHByb3RlY3RlZCBoYXNDaGlsZERldmljZXMoKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgdGhlIG5hdmlnYXRvciBub2RlIGJ5IHNvcnRpbmcgaXRzIGNoaWxkcmVuIGFuZCBhbHNvIGNoZWNraW5nIHRoZWlyIHZpc2liaWxpdHkuXG4gICAqL1xuICBwcm90ZWN0ZWQgdXBkYXRlQ2hpbGRyZW4oKSB7XG4gICAgdGhpcy5zb3J0KCk7XG4gICAgdGhpcy51cGRhdGVIaWRkZW4oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTb3J0cyB0aGUgY2hpbGRyZW4gb2YgdGhlIG5hdmlnYXRvciBub2RlLCBieSBwcmlvcml0eSBhbmQgbmFtZSAoQVNDKS5cbiAgICogVGhlIGhpZ2hlciB0aGUgcHJpb3JpdHksIHRoZSBoaWdoZXIgdGhlIHBvc2l0aW9uIGluIHRoZSBoaWVyYXJjaHkuXG4gICAqIEZvciB0aGUgc2FtZSBwcmlvcml0eSB2YWx1ZXMsIHRoZSBhbHBoYWJldGljYWwgb3JkZXIgd2lsbCB0YWtlIHByZWNlZGVuY2UuXG4gICAqL1xuICBwcm90ZWN0ZWQgc29ydCgpIHtcbiAgICB0aGlzLmNoaWxkcmVuLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgIGlmIChhLnByaW9yaXR5ID4gYi5wcmlvcml0eSkge1xuICAgICAgICByZXR1cm4gLTE7XG4gICAgICB9IGVsc2UgaWYgKGEucHJpb3JpdHkgPCBiLnByaW9yaXR5KSB7XG4gICAgICAgIHJldHVybiAxO1xuICAgICAgfSBlbHNlIGlmICgoYS5sYWJlbCB8fCAnJykudG9Mb3dlckNhc2UoKSA8IChiLmxhYmVsIHx8ICcnKS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgIHJldHVybiAtMTtcbiAgICAgIH0gZWxzZSBpZiAoKGEubGFiZWwgfHwgJycpLnRvTG93ZXJDYXNlKCkgPiAoYi5sYWJlbCB8fCAnJykudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICByZXR1cm4gMTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiB0aGUgbmF2aWdhdG9yIG5vZGUgc2hvdWxkIGJlIGhpZGRlbiBiYXNlZCBvbiB0aGUgdmlzaWJpbGl0eSBvZiBpdHMgY2hpbGQgbm9kZXMuXG4gICAqL1xuICBwcm90ZWN0ZWQgdXBkYXRlSGlkZGVuKCkge1xuICAgIGlmICh0eXBlb2YgdGhpcy5wYXRoID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhpcy5oaWRkZW4gPSAhdGhpcy5jaGlsZHJlbi5zb21lKCh7IGhpZGRlbiB9KSA9PiAhaGlkZGVuKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==