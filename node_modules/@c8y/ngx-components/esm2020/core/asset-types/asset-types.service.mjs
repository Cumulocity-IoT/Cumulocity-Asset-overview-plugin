import { Injectable } from '@angular/core';
import { InventoryService } from '@c8y/client';
import { ApiService } from '@c8y/ngx-components/api';
import { NEVER, of } from 'rxjs';
import { distinctUntilChanged, filter, map, mergeMap, switchMap, tap } from 'rxjs/operators';
import { AppStateService } from '../common/ui-state.service';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client";
import * as i2 from "@c8y/ngx-components/api";
import * as i3 from "../common/ui-state.service";
/**
 * AssetTypesService is being used to manage a cache of all existing asset types.
 * This service is injected in the AssetOverviewNavigationFactory class, which will trigger
 * the initialization of the cache as the constructor is called.
 */
export class AssetTypesService {
    constructor(inventory, apiService, appStateService) {
        this.inventory = inventory;
        this.apiService = apiService;
        this.appStateService = appStateService;
        this.ASSET_TYPE_GROUP_QUERY = {
            __filter: {
                __and: [{ __has: 'c8y_IsAssetType' }, { name: 'group' }]
            }
        };
        this.DEFAULT_ASSET_ICON = 'c8y-enterprise';
        this.assetTypesCache = {};
        this.isCacheSet = false;
        this.allowedMethods = ['POST', 'PUT', 'DELETE'];
        this.appStateService.currentUser
            .pipe(map(user => user?.id), distinctUntilChanged(), switchMap(userId => {
            if (userId) {
                this.initAssetTypesCache();
                return this.subscribeForAssetTypeUpdates();
            }
            else {
                this.assetTypesCache = {};
                return NEVER;
            }
        }))
            .subscribe();
    }
    /**
     * Queries available asset types and adds every asset type to the local cache.
     * @returns IManagedObject table of asset types.
     */
    async initAssetTypesCache() {
        const { data } = await this.inventory.list({
            fragmentType: 'c8y_IsAssetType',
            withChildren: false,
            pageSize: 2000
        });
        data.forEach(assetType => this.addAssetType(assetType));
        this.isCacheSet = true;
        return data;
    }
    /**
     * Returns an asset type from the cache based on the unique name property.
     * @param name Name of the asset type.
     * @returns IManagedObject which represents the asset type.
     */
    getAssetTypeByName(name) {
        if (!this.assetTypesCache.hasOwnProperty(name)) {
            return undefined;
        }
        return this.assetTypesCache[name];
    }
    /**
     * Returns an asset type from the cache based on the id.
     * @param assetTypeId Id of the asset type.
     * @returns IManagedObject which represents the asset type.
     */
    getAssetTypeById(assetTypeId) {
        if (!assetTypeId) {
            return;
        }
        return Object.values(this.assetTypesCache).find((assetType) => assetType.id === assetTypeId);
    }
    /**
     * Extracts an icon from an asset type.
     * @param type Type of the asset type.
     * @param open Determines whether the method should return an alternative icon showing the open state.
     * Defaults to false.
     * @returns Returns an icon for a given asset type.
     */
    async getIcon(type) {
        if (!this.isCacheSet) {
            try {
                await this.initAssetTypesCache();
            }
            catch (error) {
                // do nothing
            }
        }
        const assetType = this.getAssetTypeByName(type);
        return assetType?.c8y_IsAssetType?.icon?.name || this.DEFAULT_ASSET_ICON;
    }
    /**
     * Add an asset type to the local cache.
     * @param assetType Asset type which should be added to the cache.
     * @returns void.
     */
    addAssetType(assetType) {
        this.assetTypesCache[assetType.name] = assetType;
    }
    /**
     * Delete an asset type from the local cache based on the given asset type id.
     * @param assetTypeId Id of the asset type which should be deleted.
     * @returns void.
     */
    deleteAssetType(assetTypeId) {
        const assetType = this.getAssetTypeById(assetTypeId);
        if (assetType) {
            delete this.assetTypesCache[assetType.name];
        }
    }
    /**
     * Update an asset type in the local cache.
     * @param assetType Asset type which should be updated in the cache.
     * @returns void.
     */
    updateAssetType(assetType) {
        const cachedAssetType = this.getAssetTypeById(assetType.id);
        if (cachedAssetType) {
            this.assetTypesCache[cachedAssetType.name] = Object.assign(cachedAssetType, assetType);
        }
    }
    /**
     * Subscribes to api PUT, POST and DELETE requests interceptor to update local asset types cache.
     * If a new asset type has been created it will be added to the local cache. If an asset
     * type has been deleted it will be removed from the local cache.
     */
    subscribeForAssetTypeUpdates() {
        return this.apiService
            .hookResponse(c => this.checkIfInventoryMoApiCall(c))
            .pipe(filter((call) => !!call?.method && this.isExpectedMethod(call)), mergeMap((this.apiService.resolveData)), switchMap(({ method, data, url }) => method === 'DELETE' ? this.handleDelete(method, url) : of(data)), filter((mo) => !!mo && this.hasIsAssetTypeFragment(mo)), tap((mo) => this.handlePutOrPost(mo)));
    }
    isExpectedMethod(call) {
        return this.allowedMethods.includes(call?.method);
    }
    handleDelete(method, url) {
        const moId = this.getMoIdFromUrl(url);
        if (method !== 'DELETE' || !moId) {
            return NEVER;
        }
        this.deleteAssetType(moId);
        return NEVER;
    }
    handlePutOrPost(mo) {
        if (this.getAssetTypeById(mo.id)) {
            this.updateAssetType(mo);
        }
        else {
            this.addAssetType(mo);
        }
    }
    hasIsAssetTypeFragment(mo) {
        return mo?.hasOwnProperty('c8y_IsAssetType');
    }
    getMoIdFromUrl(url) {
        const regex = /managedObjects\/(\d+)/;
        const match = url.match(regex);
        if (match) {
            const moId = match[1];
            return moId;
        }
        return;
    }
    /**
     * Managed objects inventory api filter, allowing only PUT, POST and DELETE methods.
     * @param call Api call to filter.
     * @returns Returns true if api call meets the required criteria.
     */
    checkIfInventoryMoApiCall(call) {
        if (!call) {
            return false;
        }
        const hasRequiredMethod = call.method === 'POST' || call.method === 'DELETE' || call.method === 'PUT';
        const hasRequiredUrl = call.url.includes('managedObjects');
        return hasRequiredMethod && hasRequiredUrl;
    }
}
AssetTypesService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: AssetTypesService, deps: [{ token: i1.InventoryService }, { token: i2.ApiService }, { token: i3.AppStateService }], target: i0.ɵɵFactoryTarget.Injectable });
AssetTypesService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: AssetTypesService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: AssetTypesService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i1.InventoryService }, { type: i2.ApiService }, { type: i3.AppStateService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtdHlwZXMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvYXNzZXQtdHlwZXMvYXNzZXQtdHlwZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBa0IsZ0JBQWdCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDL0QsT0FBTyxFQUFXLFVBQVUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzlELE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0YsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDRCQUE0QixDQUFDOzs7OztBQUU3RDs7OztHQUlHO0FBRUgsTUFBTSxPQUFPLGlCQUFpQjtJQVc1QixZQUNVLFNBQTJCLEVBQzNCLFVBQXNCLEVBQ3RCLGVBQWdDO1FBRmhDLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQzNCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBYnpCLDJCQUFzQixHQUFHO1lBQ3hDLFFBQVEsRUFBRTtnQkFDUixLQUFLLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxpQkFBaUIsRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxDQUFDO2FBQ3pEO1NBQ0YsQ0FBQztRQUNlLHVCQUFrQixHQUFHLGdCQUFnQixDQUFDO1FBQy9DLG9CQUFlLEdBQVcsRUFBRSxDQUFDO1FBQzdCLGVBQVUsR0FBRyxLQUFLLENBQUM7UUFDbkIsbUJBQWMsR0FBRyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7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SUFBSSxDQUFDLE1BQU0sS0FBSyxLQUFLLENBQUM7UUFDOUUsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUMzRCxPQUFPLGlCQUFpQixJQUFJLGNBQWMsQ0FBQztJQUM3QyxDQUFDOzs4R0FyTVUsaUJBQWlCO2tIQUFqQixpQkFBaUIsY0FESixNQUFNOzJGQUNuQixpQkFBaUI7a0JBRDdCLFVBQVU7bUJBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSU1hbmFnZWRPYmplY3QsIEludmVudG9yeVNlcnZpY2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBBcGlDYWxsLCBBcGlTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9hcGknO1xuaW1wb3J0IHsgTkVWRVIsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZmlsdGVyLCBtYXAsIG1lcmdlTWFwLCBzd2l0Y2hNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFwcFN0YXRlU2VydmljZSB9IGZyb20gJy4uL2NvbW1vbi91aS1zdGF0ZS5zZXJ2aWNlJztcblxuLyoqXG4gKiBBc3NldFR5cGVzU2VydmljZSBpcyBiZWluZyB1c2VkIHRvIG1hbmFnZSBhIGNhY2hlIG9mIGFsbCBleGlzdGluZyBhc3NldCB0eXBlcy5cbiAqIFRoaXMgc2VydmljZSBpcyBpbmplY3RlZCBpbiB0aGUgQXNzZXRPdmVydmlld05hdmlnYXRpb25GYWN0b3J5IGNsYXNzLCB3aGljaCB3aWxsIHRyaWdnZXJcbiAqIHRoZSBpbml0aWFsaXphdGlvbiBvZiB0aGUgY2FjaGUgYXMgdGhlIGNvbnN0cnVjdG9yIGlzIGNhbGxlZC5cbiAqL1xuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBBc3NldFR5cGVzU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgQVNTRVRfVFlQRV9HUk9VUF9RVUVSWSA9IHtcbiAgICBfX2ZpbHRlcjoge1xuICAgICAgX19hbmQ6IFt7IF9faGFzOiAnYzh5X0lzQXNzZXRUeXBlJyB9LCB7IG5hbWU6ICdncm91cCcgfV1cbiAgICB9XG4gIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgREVGQVVMVF9BU1NFVF9JQ09OID0gJ2M4eS1lbnRlcnByaXNlJztcbiAgcHJpdmF0ZSBhc3NldFR5cGVzQ2FjaGU6IG9iamVjdCA9IHt9O1xuICBwcml2YXRlIGlzQ2FjaGVTZXQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBhbGxvd2VkTWV0aG9kcyA9IFsnUE9TVCcsICdQVVQnLCAnREVMRVRFJ107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnk6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhcGlTZXJ2aWNlOiBBcGlTZXJ2aWNlLFxuICAgIHByaXZhdGUgYXBwU3RhdGVTZXJ2aWNlOiBBcHBTdGF0ZVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5hcHBTdGF0ZVNlcnZpY2UuY3VycmVudFVzZXJcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAodXNlciA9PiB1c2VyPy5pZCksXG4gICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICAgIHN3aXRjaE1hcCh1c2VySWQgPT4ge1xuICAgICAgICAgIGlmICh1c2VySWQpIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdEFzc2V0VHlwZXNDYWNoZSgpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3Vic2NyaWJlRm9yQXNzZXRUeXBlVXBkYXRlcygpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmFzc2V0VHlwZXNDYWNoZSA9IHt9O1xuICAgICAgICAgICAgcmV0dXJuIE5FVkVSO1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBRdWVyaWVzIGF2YWlsYWJsZSBhc3NldCB0eXBlcyBhbmQgYWRkcyBldmVyeSBhc3NldCB0eXBlIHRvIHRoZSBsb2NhbCBjYWNoZS5cbiAgICogQHJldHVybnMgSU1hbmFnZWRPYmplY3QgdGFibGUgb2YgYXNzZXQgdHlwZXMuXG4gICAqL1xuICBhc3luYyBpbml0QXNzZXRUeXBlc0NhY2hlKCk6IFByb21pc2U8SU1hbmFnZWRPYmplY3RbXT4ge1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnkubGlzdCh7XG4gICAgICBmcmFnbWVudFR5cGU6ICdjOHlfSXNBc3NldFR5cGUnLFxuICAgICAgd2l0aENoaWxkcmVuOiBmYWxzZSxcbiAgICAgIHBhZ2VTaXplOiAyMDAwXG4gICAgfSk7XG4gICAgZGF0YS5mb3JFYWNoKGFzc2V0VHlwZSA9PiB0aGlzLmFkZEFzc2V0VHlwZShhc3NldFR5cGUpKTtcblxuICAgIHRoaXMuaXNDYWNoZVNldCA9IHRydWU7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbiBhc3NldCB0eXBlIGZyb20gdGhlIGNhY2hlIGJhc2VkIG9uIHRoZSB1bmlxdWUgbmFtZSBwcm9wZXJ0eS5cbiAgICogQHBhcmFtIG5hbWUgTmFtZSBvZiB0aGUgYXNzZXQgdHlwZS5cbiAgICogQHJldHVybnMgSU1hbmFnZWRPYmplY3Qgd2hpY2ggcmVwcmVzZW50cyB0aGUgYXNzZXQgdHlwZS5cbiAgICovXG4gIGdldEFzc2V0VHlwZUJ5TmFtZShuYW1lOiBzdHJpbmcpOiBJTWFuYWdlZE9iamVjdCB7XG4gICAgaWYgKCF0aGlzLmFzc2V0VHlwZXNDYWNoZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5hc3NldFR5cGVzQ2FjaGVbbmFtZV07XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbiBhc3NldCB0eXBlIGZyb20gdGhlIGNhY2hlIGJhc2VkIG9uIHRoZSBpZC5cbiAgICogQHBhcmFtIGFzc2V0VHlwZUlkIElkIG9mIHRoZSBhc3NldCB0eXBlLlxuICAgKiBAcmV0dXJucyBJTWFuYWdlZE9iamVjdCB3aGljaCByZXByZXNlbnRzIHRoZSBhc3NldCB0eXBlLlxuICAgKi9cbiAgZ2V0QXNzZXRUeXBlQnlJZChhc3NldFR5cGVJZDogc3RyaW5nKTogSU1hbmFnZWRPYmplY3Qge1xuICAgIGlmICghYXNzZXRUeXBlSWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzLmFzc2V0VHlwZXNDYWNoZSkuZmluZChcbiAgICAgIChhc3NldFR5cGU6IElNYW5hZ2VkT2JqZWN0KSA9PiBhc3NldFR5cGUuaWQgPT09IGFzc2V0VHlwZUlkXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHRyYWN0cyBhbiBpY29uIGZyb20gYW4gYXNzZXQgdHlwZS5cbiAgICogQHBhcmFtIHR5cGUgVHlwZSBvZiB0aGUgYXNzZXQgdHlwZS5cbiAgICogQHBhcmFtIG9wZW4gRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBtZXRob2Qgc2hvdWxkIHJldHVybiBhbiBhbHRlcm5hdGl2ZSBpY29uIHNob3dpbmcgdGhlIG9wZW4gc3RhdGUuXG4gICAqIERlZmF1bHRzIHRvIGZhbHNlLlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIGFuIGljb24gZm9yIGEgZ2l2ZW4gYXNzZXQgdHlwZS5cbiAgICovXG4gIGFzeW5jIGdldEljb24odHlwZTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBpZiAoIXRoaXMuaXNDYWNoZVNldCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5pbml0QXNzZXRUeXBlc0NhY2hlKCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAvLyBkbyBub3RoaW5nXG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGFzc2V0VHlwZSA9IHRoaXMuZ2V0QXNzZXRUeXBlQnlOYW1lKHR5cGUpO1xuICAgIHJldHVybiBhc3NldFR5cGU/LmM4eV9Jc0Fzc2V0VHlwZT8uaWNvbj8ubmFtZSB8fCB0aGlzLkRFRkFVTFRfQVNTRVRfSUNPTjtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYW4gYXNzZXQgdHlwZSB0byB0aGUgbG9jYWwgY2FjaGUuXG4gICAqIEBwYXJhbSBhc3NldFR5cGUgQXNzZXQgdHlwZSB3aGljaCBzaG91bGQgYmUgYWRkZWQgdG8gdGhlIGNhY2hlLlxuICAgKiBAcmV0dXJucyB2b2lkLlxuICAgKi9cbiAgcHJpdmF0ZSBhZGRBc3NldFR5cGUoYXNzZXRUeXBlOiBJTWFuYWdlZE9iamVjdCk6IHZvaWQge1xuICAgIHRoaXMuYXNzZXRUeXBlc0NhY2hlW2Fzc2V0VHlwZS5uYW1lXSA9IGFzc2V0VHlwZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGUgYW4gYXNzZXQgdHlwZSBmcm9tIHRoZSBsb2NhbCBjYWNoZSBiYXNlZCBvbiB0aGUgZ2l2ZW4gYXNzZXQgdHlwZSBpZC5cbiAgICogQHBhcmFtIGFzc2V0VHlwZUlkIElkIG9mIHRoZSBhc3NldCB0eXBlIHdoaWNoIHNob3VsZCBiZSBkZWxldGVkLlxuICAgKiBAcmV0dXJucyB2b2lkLlxuICAgKi9cbiAgcHJpdmF0ZSBkZWxldGVBc3NldFR5cGUoYXNzZXRUeXBlSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IGFzc2V0VHlwZSA9IHRoaXMuZ2V0QXNzZXRUeXBlQnlJZChhc3NldFR5cGVJZCk7XG4gICAgaWYgKGFzc2V0VHlwZSkge1xuICAgICAgZGVsZXRlIHRoaXMuYXNzZXRUeXBlc0NhY2hlW2Fzc2V0VHlwZS5uYW1lXTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIFVwZGF0ZSBhbiBhc3NldCB0eXBlIGluIHRoZSBsb2NhbCBjYWNoZS5cbiAgICogQHBhcmFtIGFzc2V0VHlwZSBBc3NldCB0eXBlIHdoaWNoIHNob3VsZCBiZSB1cGRhdGVkIGluIHRoZSBjYWNoZS5cbiAgICogQHJldHVybnMgdm9pZC5cbiAgICovXG4gIHByaXZhdGUgdXBkYXRlQXNzZXRUeXBlKGFzc2V0VHlwZTogSU1hbmFnZWRPYmplY3QpOiB2b2lkIHtcbiAgICBjb25zdCBjYWNoZWRBc3NldFR5cGUgPSB0aGlzLmdldEFzc2V0VHlwZUJ5SWQoYXNzZXRUeXBlLmlkKTtcbiAgICBpZiAoY2FjaGVkQXNzZXRUeXBlKSB7XG4gICAgICB0aGlzLmFzc2V0VHlwZXNDYWNoZVtjYWNoZWRBc3NldFR5cGUubmFtZV0gPSBPYmplY3QuYXNzaWduKGNhY2hlZEFzc2V0VHlwZSwgYXNzZXRUeXBlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU3Vic2NyaWJlcyB0byBhcGkgUFVULCBQT1NUIGFuZCBERUxFVEUgcmVxdWVzdHMgaW50ZXJjZXB0b3IgdG8gdXBkYXRlIGxvY2FsIGFzc2V0IHR5cGVzIGNhY2hlLlxuICAgKiBJZiBhIG5ldyBhc3NldCB0eXBlIGhhcyBiZWVuIGNyZWF0ZWQgaXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgbG9jYWwgY2FjaGUuIElmIGFuIGFzc2V0XG4gICAqIHR5cGUgaGFzIGJlZW4gZGVsZXRlZCBpdCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgbG9jYWwgY2FjaGUuXG4gICAqL1xuICBwcml2YXRlIHN1YnNjcmliZUZvckFzc2V0VHlwZVVwZGF0ZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZVxuICAgICAgLmhvb2tSZXNwb25zZShjID0+IHRoaXMuY2hlY2tJZkludmVudG9yeU1vQXBpQ2FsbChjKSlcbiAgICAgIC5waXBlKFxuICAgICAgICBmaWx0ZXIoKGNhbGw6IEFwaUNhbGwpID0+ICEhY2FsbD8ubWV0aG9kICYmIHRoaXMuaXNFeHBlY3RlZE1ldGhvZChjYWxsKSksXG4gICAgICAgIG1lcmdlTWFwKHRoaXMuYXBpU2VydmljZS5yZXNvbHZlRGF0YTxJTWFuYWdlZE9iamVjdCB8IG51bGw+KSxcbiAgICAgICAgc3dpdGNoTWFwKCh7IG1ldGhvZCwgZGF0YSwgdXJsIH0pID0+XG4gICAgICAgICAgbWV0aG9kID09PSAnREVMRVRFJyA/IHRoaXMuaGFuZGxlRGVsZXRlKG1ldGhvZCwgdXJsKSA6IG9mKGRhdGEpXG4gICAgICAgICksXG4gICAgICAgIGZpbHRlcigobW86IElNYW5hZ2VkT2JqZWN0KSA9PiAhIW1vICYmIHRoaXMuaGFzSXNBc3NldFR5cGVGcmFnbWVudChtbykpLFxuICAgICAgICB0YXAoKG1vOiBJTWFuYWdlZE9iamVjdCkgPT4gdGhpcy5oYW5kbGVQdXRPclBvc3QobW8pKVxuICAgICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgaXNFeHBlY3RlZE1ldGhvZChjYWxsOiBBcGlDYWxsKSB7XG4gICAgcmV0dXJuIHRoaXMuYWxsb3dlZE1ldGhvZHMuaW5jbHVkZXMoY2FsbD8ubWV0aG9kKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRGVsZXRlKG1ldGhvZDogc3RyaW5nLCB1cmw6IHN0cmluZykge1xuICAgIGNvbnN0IG1vSWQ6IHN0cmluZyA9IHRoaXMuZ2V0TW9JZEZyb21VcmwodXJsKTtcbiAgICBpZiAobWV0aG9kICE9PSAnREVMRVRFJyB8fCAhbW9JZCkge1xuICAgICAgcmV0dXJuIE5FVkVSO1xuICAgIH1cbiAgICB0aGlzLmRlbGV0ZUFzc2V0VHlwZShtb0lkKTtcbiAgICByZXR1cm4gTkVWRVI7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZVB1dE9yUG9zdChtbzogSU1hbmFnZWRPYmplY3QpIHtcbiAgICBpZiAodGhpcy5nZXRBc3NldFR5cGVCeUlkKG1vLmlkKSkge1xuICAgICAgdGhpcy51cGRhdGVBc3NldFR5cGUobW8pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmFkZEFzc2V0VHlwZShtbyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYXNJc0Fzc2V0VHlwZUZyYWdtZW50KG1vOiBJTWFuYWdlZE9iamVjdCkge1xuICAgIHJldHVybiBtbz8uaGFzT3duUHJvcGVydHkoJ2M4eV9Jc0Fzc2V0VHlwZScpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRNb0lkRnJvbVVybCh1cmw6IHN0cmluZykge1xuICAgIGNvbnN0IHJlZ2V4ID0gL21hbmFnZWRPYmplY3RzXFwvKFxcZCspLztcbiAgICBjb25zdCBtYXRjaCA9IHVybC5tYXRjaChyZWdleCk7XG5cbiAgICBpZiAobWF0Y2gpIHtcbiAgICAgIGNvbnN0IG1vSWQgPSBtYXRjaFsxXTtcbiAgICAgIHJldHVybiBtb0lkO1xuICAgIH1cbiAgICByZXR1cm47XG4gIH1cblxuICAvKipcbiAgICogTWFuYWdlZCBvYmplY3RzIGludmVudG9yeSBhcGkgZmlsdGVyLCBhbGxvd2luZyBvbmx5IFBVVCwgUE9TVCBhbmQgREVMRVRFIG1ldGhvZHMuXG4gICAqIEBwYXJhbSBjYWxsIEFwaSBjYWxsIHRvIGZpbHRlci5cbiAgICogQHJldHVybnMgUmV0dXJucyB0cnVlIGlmIGFwaSBjYWxsIG1lZXRzIHRoZSByZXF1aXJlZCBjcml0ZXJpYS5cbiAgICovXG4gIHByaXZhdGUgY2hlY2tJZkludmVudG9yeU1vQXBpQ2FsbChjYWxsOiBBcGlDYWxsKTogYm9vbGVhbiB7XG4gICAgaWYgKCFjYWxsKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3QgaGFzUmVxdWlyZWRNZXRob2QgPVxuICAgICAgY2FsbC5tZXRob2QgPT09ICdQT1NUJyB8fCBjYWxsLm1ldGhvZCA9PT0gJ0RFTEVURScgfHwgY2FsbC5tZXRob2QgPT09ICdQVVQnO1xuICAgIGNvbnN0IGhhc1JlcXVpcmVkVXJsID0gY2FsbC51cmwuaW5jbHVkZXMoJ21hbmFnZWRPYmplY3RzJyk7XG4gICAgcmV0dXJuIGhhc1JlcXVpcmVkTWV0aG9kICYmIGhhc1JlcXVpcmVkVXJsO1xuICB9XG59XG4iXX0=