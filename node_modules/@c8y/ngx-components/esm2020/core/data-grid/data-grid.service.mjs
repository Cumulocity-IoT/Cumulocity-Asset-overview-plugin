import { Injectable } from '@angular/core';
import { QueriesUtil } from '@c8y/client';
import { assign, forEach, get, identity, transform } from 'lodash-es';
import { from, isObservable, of } from 'rxjs';
import { map, share, take, withLatestFrom } from 'rxjs/operators';
import { UserPreferencesService } from '../common/user-preferences/user-preferences.service';
import { CustomColumn } from './column/custom.column';
import * as i0 from "@angular/core";
import * as i1 from "../common/user-preferences/user-preferences.service";
export class DataGridService {
    constructor(userPreferencesService) {
        this.userPreferencesService = userPreferencesService;
        this.DEFAULT_PAGE_SIZE = 20;
        this.queriesUtil = new QueriesUtil();
    }
    /**
     * @deprecated Use getConfig$(key: string): Observable<GridConfig> instead.
     */
    getConfig(key) {
        return this.getConfig2(key);
    }
    /**
     * @deprecated Use saveConfig$(config: GridConfig, key: string): Promise<GridConfig> instead.
     */
    saveConfig(config, key) {
        localStorage.setItem(key, JSON.stringify(config));
    }
    clearConfig(key) {
        localStorage.removeItem(key);
    }
    getConfig$(key) {
        return this.userPreferencesService.get(key).pipe(map(config => config || {
            columns: [],
            pagination: { pageSize: this.DEFAULT_PAGE_SIZE, currentPage: 1 }
        }));
    }
    saveConfig$(config, key) {
        return from(this.userPreferencesService.set(key, config));
    }
    /**
     * @deprecated Use getUserConfiguredColumns$(Column[] | Observable<Column[]>, string) instead.
     */
    getUserConfiguredColumns(columns, storageKey) {
        return this.applyConfigToColumns(this.getConfig2(storageKey), columns, storageKey);
    }
    getUserConfiguredColumns$(columns, storageKey) {
        return this.getConfig$(storageKey).pipe(withLatestFrom(isObservable(columns) ? columns : of(columns)), map(([config, cols]) => this.applyConfigToColumns(config, cols, storageKey)), take(1), share());
    }
    getQueryObj(columns, defaultFilter = {}) {
        return transform(columns, (query, column) => this.extendQueryByColumn(query, column), {
            __filter: {},
            __orderby: [],
            ...defaultFilter
        });
    }
    applyConfigToColumns(config, columns, storageKey) {
        if (config?.columns?.length > 0) {
            const reOrderedColumns = [];
            let noConfigColumns = [];
            try {
                const customColumns = config.columns
                    .filter(col => col.custom)
                    .map((col) => new CustomColumn(col));
                const allColumns = [...columns, ...customColumns];
                noConfigColumns = allColumns.filter(col => !config.columns.some(configCol => col.name === configCol.name));
                config.columns.forEach(({ visible, name, sortOrder, filter }) => {
                    const columnToReorder = allColumns.find(col => col.name === name);
                    if (columnToReorder) {
                        columnToReorder.visible = visible;
                        columnToReorder.sortOrder = sortOrder;
                        columnToReorder.externalFilterQuery =
                            columnToReorder.externalFilterQuery ?? filter?.externalFilterQuery;
                        reOrderedColumns.push(columnToReorder);
                    }
                });
            }
            catch (ex) {
                this.clearConfig(storageKey);
            }
            return [...reOrderedColumns, ...noConfigColumns];
        }
        return columns;
    }
    // TODO: REMOVE ME
    // Added because usage of getConfig breaks JSdoc deprecations, otherwise compodoc build fails
    getConfig2(key) {
        const config = JSON.parse(localStorage.getItem(key));
        if (config === null) {
            return { columns: [], pagination: { pageSize: this.DEFAULT_PAGE_SIZE, currentPage: 1 } };
        }
        return config;
    }
    extendQueryByColumn(query, column) {
        if (column.filterable && column.externalFilterQuery) {
            const getFilter = column.filteringConfig.getFilter || identity;
            const queryObj = getFilter(column.externalFilterQuery);
            if (queryObj.__or) {
                query.__filter.__and = query.__filter.__and || [];
                query.__filter.__and.push(queryObj);
            }
            else if (queryObj.__and && get(query, '__filter.__and')) {
                queryObj.__and.map(obj => query.__filter.__and.push(obj));
            }
            else {
                assign(query.__filter, queryObj);
            }
        }
        if (column.sortable && column.sortOrder) {
            const cs = {};
            forEach(column.sortingConfig.pathSortingConfigs, pathSortingConfig => {
                cs[pathSortingConfig.path] =
                    (column.sortOrder === 'asc' ? 1 : -1) * (pathSortingConfig.sortOrderModifier || 1);
            });
            query.__orderby.push(cs);
        }
        return query;
    }
}
DataGridService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: DataGridService, deps: [{ token: i1.UserPreferencesService }], target: i0.ɵɵFactoryTarget.Injectable });
DataGridService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: DataGridService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: DataGridService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.UserPreferencesService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1ncmlkLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9jb3JlL2RhdGEtZ3JpZC9kYXRhLWdyaWQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdEUsT0FBTyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFELE9BQU8sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNsRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxxREFBcUQsQ0FBQztBQUM3RixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7OztBQU10RCxNQUFNLE9BQU8sZUFBZTtJQUsxQixZQUFzQixzQkFBOEM7UUFBOUMsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUF3QjtRQUoxRCxzQkFBaUIsR0FBRyxFQUFFLENBQUM7UUFLL0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7T0FFRztJQUNILFNBQVMsQ0FBQyxHQUFXO1FBQ25CLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUM5QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxVQUFVLENBQUMsTUFBa0IsRUFBRSxHQUFXO1FBQ3hDLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNwRCxD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LENBQUMsaUJBQWlCLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDdkYsQ0FBQyxDQUFDLENBQUM7WUFDSCxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUMxQjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQzs7NEdBdklVLGVBQWU7Z0hBQWYsZUFBZSxjQUZkLE1BQU07MkZBRVAsZUFBZTtrQkFIM0IsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBRdWVyaWVzVXRpbCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IGFzc2lnbiwgZm9yRWFjaCwgZ2V0LCBpZGVudGl0eSwgdHJhbnNmb3JtIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IGZyb20sIGlzT2JzZXJ2YWJsZSwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc2hhcmUsIHRha2UsIHdpdGhMYXRlc3RGcm9tIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgVXNlclByZWZlcmVuY2VzU2VydmljZSB9IGZyb20gJy4uL2NvbW1vbi91c2VyLXByZWZlcmVuY2VzL3VzZXItcHJlZmVyZW5jZXMuc2VydmljZSc7XG5pbXBvcnQgeyBDdXN0b21Db2x1bW4gfSBmcm9tICcuL2NvbHVtbi9jdXN0b20uY29sdW1uJztcbmltcG9ydCB7IENvbHVtbiwgQ3VzdG9tQ29sdW1uQ29uZmlnLCBHcmlkQ29uZmlnIH0gZnJvbSAnLi9kYXRhLWdyaWQubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBEYXRhR3JpZFNlcnZpY2Uge1xuICBwcm90ZWN0ZWQgREVGQVVMVF9QQUdFX1NJWkUgPSAyMDtcblxuICBwcm90ZWN0ZWQgcXVlcmllc1V0aWw6IFF1ZXJpZXNVdGlsO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCB1c2VyUHJlZmVyZW5jZXNTZXJ2aWNlOiBVc2VyUHJlZmVyZW5jZXNTZXJ2aWNlKSB7XG4gICAgdGhpcy5xdWVyaWVzVXRpbCA9IG5ldyBRdWVyaWVzVXRpbCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIFVzZSBnZXRDb25maWckKGtleTogc3RyaW5nKTogT2JzZXJ2YWJsZTxHcmlkQ29uZmlnPiBpbnN0ZWFkLlxuICAgKi9cbiAgZ2V0Q29uZmlnKGtleTogc3RyaW5nKTogR3JpZENvbmZpZyB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlnMihrZXkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIFVzZSBzYXZlQ29uZmlnJChjb25maWc6IEdyaWRDb25maWcsIGtleTogc3RyaW5nKTogUHJvbWlzZTxHcmlkQ29uZmlnPiBpbnN0ZWFkLlxuICAgKi9cbiAgc2F2ZUNvbmZpZyhjb25maWc6IEdyaWRDb25maWcsIGtleTogc3RyaW5nKSB7XG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5LCBKU09OLnN0cmluZ2lmeShjb25maWcpKTtcbiAgfVxuXG4gIGNsZWFyQ29uZmlnKGtleTogc3RyaW5nKSB7XG4gICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTtcbiAgfVxuXG4gIGdldENvbmZpZyQoa2V5OiBzdHJpbmcpOiBPYnNlcnZhYmxlPEdyaWRDb25maWc+IHtcbiAgICByZXR1cm4gdGhpcy51c2VyUHJlZmVyZW5jZXNTZXJ2aWNlLmdldChrZXkpLnBpcGUoXG4gICAgICBtYXAoXG4gICAgICAgIGNvbmZpZyA9PlxuICAgICAgICAgIGNvbmZpZyB8fCB7XG4gICAgICAgICAgICBjb2x1bW5zOiBbXSxcbiAgICAgICAgICAgIHBhZ2luYXRpb246IHsgcGFnZVNpemU6IHRoaXMuREVGQVVMVF9QQUdFX1NJWkUsIGN1cnJlbnRQYWdlOiAxIH1cbiAgICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHNhdmVDb25maWckKGNvbmZpZzogR3JpZENvbmZpZywga2V5OiBzdHJpbmcpOiBPYnNlcnZhYmxlPEdyaWRDb25maWc+IHtcbiAgICByZXR1cm4gZnJvbSh0aGlzLnVzZXJQcmVmZXJlbmNlc1NlcnZpY2Uuc2V0KGtleSwgY29uZmlnKSk7XG4gIH1cblxuICAvKipcbiAgICogQGRlcHJlY2F0ZWQgVXNlIGdldFVzZXJDb25maWd1cmVkQ29sdW1ucyQoQ29sdW1uW10gfCBPYnNlcnZhYmxlPENvbHVtbltdPiwgc3RyaW5nKSBpbnN0ZWFkLlxuICAgKi9cbiAgZ2V0VXNlckNvbmZpZ3VyZWRDb2x1bW5zKGNvbHVtbnM6IENvbHVtbltdLCBzdG9yYWdlS2V5Pzogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuYXBwbHlDb25maWdUb0NvbHVtbnModGhpcy5nZXRDb25maWcyKHN0b3JhZ2VLZXkpLCBjb2x1bW5zLCBzdG9yYWdlS2V5KTtcbiAgfVxuXG4gIGdldFVzZXJDb25maWd1cmVkQ29sdW1ucyQoY29sdW1uczogQ29sdW1uW10gfCBPYnNlcnZhYmxlPENvbHVtbltdPiwgc3RvcmFnZUtleT86IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmdldENvbmZpZyQoc3RvcmFnZUtleSkucGlwZShcbiAgICAgIHdpdGhMYXRlc3RGcm9tKFxuICAgICAgICBpc09ic2VydmFibGUoY29sdW1ucykgPyBjb2x1bW5zIDogKG9mKGNvbHVtbnMpIGFzIHVua25vd24gYXMgT2JzZXJ2YWJsZTxDb2x1bW5bXT4pXG4gICAgICApLFxuICAgICAgbWFwKChbY29uZmlnLCBjb2xzXSkgPT4gdGhpcy5hcHBseUNvbmZpZ1RvQ29sdW1ucyhjb25maWcsIGNvbHMsIHN0b3JhZ2VLZXkpKSxcbiAgICAgIHRha2UoMSksXG4gICAgICBzaGFyZSgpXG4gICAgKTtcbiAgfVxuXG4gIGdldFF1ZXJ5T2JqKGNvbHVtbnM6IENvbHVtbltdLCBkZWZhdWx0RmlsdGVyID0ge30pOiBhbnkge1xuICAgIHJldHVybiB0cmFuc2Zvcm0oY29sdW1ucywgKHF1ZXJ5LCBjb2x1bW4pID0+IHRoaXMuZXh0ZW5kUXVlcnlCeUNvbHVtbihxdWVyeSwgY29sdW1uKSwge1xuICAgICAgX19maWx0ZXI6IHt9LFxuICAgICAgX19vcmRlcmJ5OiBbXSxcbiAgICAgIC4uLmRlZmF1bHRGaWx0ZXJcbiAgICB9KTtcbiAgfVxuXG4gIGFwcGx5Q29uZmlnVG9Db2x1bW5zKGNvbmZpZzogR3JpZENvbmZpZywgY29sdW1uczogQ29sdW1uW10sIHN0b3JhZ2VLZXk/OiBzdHJpbmcpOiBDb2x1bW5bXSB7XG4gICAgaWYgKGNvbmZpZz8uY29sdW1ucz8ubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgcmVPcmRlcmVkQ29sdW1ucyA9IFtdO1xuICAgICAgbGV0IG5vQ29uZmlnQ29sdW1ucyA9IFtdO1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgY3VzdG9tQ29sdW1ucyA9IGNvbmZpZy5jb2x1bW5zXG4gICAgICAgICAgLmZpbHRlcihjb2wgPT4gKGNvbCBhcyBDdXN0b21Db2x1bW5Db25maWcpLmN1c3RvbSlcbiAgICAgICAgICAubWFwKChjb2w6IEN1c3RvbUNvbHVtbkNvbmZpZykgPT4gbmV3IEN1c3RvbUNvbHVtbihjb2wpKTtcblxuICAgICAgICBjb25zdCBhbGxDb2x1bW5zID0gWy4uLmNvbHVtbnMsIC4uLmN1c3RvbUNvbHVtbnNdO1xuXG4gICAgICAgIG5vQ29uZmlnQ29sdW1ucyA9IGFsbENvbHVtbnMuZmlsdGVyKFxuICAgICAgICAgIGNvbCA9PiAhY29uZmlnLmNvbHVtbnMuc29tZShjb25maWdDb2wgPT4gY29sLm5hbWUgPT09IGNvbmZpZ0NvbC5uYW1lKVxuICAgICAgICApO1xuICAgICAgICBjb25maWcuY29sdW1ucy5mb3JFYWNoKCh7IHZpc2libGUsIG5hbWUsIHNvcnRPcmRlciwgZmlsdGVyIH0pID0+IHtcbiAgICAgICAgICBjb25zdCBjb2x1bW5Ub1Jlb3JkZXIgPSBhbGxDb2x1bW5zLmZpbmQoY29sID0+IGNvbC5uYW1lID09PSBuYW1lKTtcbiAgICAgICAgICBpZiAoY29sdW1uVG9SZW9yZGVyKSB7XG4gICAgICAgICAgICBjb2x1bW5Ub1Jlb3JkZXIudmlzaWJsZSA9IHZpc2libGU7XG4gICAgICAgICAgICBjb2x1bW5Ub1Jlb3JkZXIuc29ydE9yZGVyID0gc29ydE9yZGVyO1xuICAgICAgICAgICAgY29sdW1uVG9SZW9yZGVyLmV4dGVybmFsRmlsdGVyUXVlcnkgPVxuICAgICAgICAgICAgICBjb2x1bW5Ub1Jlb3JkZXIuZXh0ZXJuYWxGaWx0ZXJRdWVyeSA/PyBmaWx0ZXI/LmV4dGVybmFsRmlsdGVyUXVlcnk7XG4gICAgICAgICAgICByZU9yZGVyZWRDb2x1bW5zLnB1c2goY29sdW1uVG9SZW9yZGVyKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgICAgdGhpcy5jbGVhckNvbmZpZyhzdG9yYWdlS2V5KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBbLi4ucmVPcmRlcmVkQ29sdW1ucywgLi4ubm9Db25maWdDb2x1bW5zXTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbHVtbnM7XG4gIH1cblxuICAvLyBUT0RPOiBSRU1PVkUgTUVcbiAgLy8gQWRkZWQgYmVjYXVzZSB1c2FnZSBvZiBnZXRDb25maWcgYnJlYWtzIEpTZG9jIGRlcHJlY2F0aW9ucywgb3RoZXJ3aXNlIGNvbXBvZG9jIGJ1aWxkIGZhaWxzXG4gIHByaXZhdGUgZ2V0Q29uZmlnMihrZXk6IHN0cmluZyk6IEdyaWRDb25maWcge1xuICAgIGNvbnN0IGNvbmZpZyA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5KSk7XG4gICAgaWYgKGNvbmZpZyA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIHsgY29sdW1uczogW10sIHBhZ2luYXRpb246IHsgcGFnZVNpemU6IHRoaXMuREVGQVVMVF9QQUdFX1NJWkUsIGN1cnJlbnRQYWdlOiAxIH0gfTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbmZpZyBhcyBHcmlkQ29uZmlnO1xuICB9XG5cbiAgcHJpdmF0ZSBleHRlbmRRdWVyeUJ5Q29sdW1uKHF1ZXJ5OiBhbnksIGNvbHVtbjogQ29sdW1uKTogdm9pZCB7XG4gICAgaWYgKGNvbHVtbi5maWx0ZXJhYmxlICYmIGNvbHVtbi5leHRlcm5hbEZpbHRlclF1ZXJ5KSB7XG4gICAgICBjb25zdCBnZXRGaWx0ZXIgPSBjb2x1bW4uZmlsdGVyaW5nQ29uZmlnLmdldEZpbHRlciB8fCBpZGVudGl0eTtcbiAgICAgIGNvbnN0IHF1ZXJ5T2JqID0gZ2V0RmlsdGVyKGNvbHVtbi5leHRlcm5hbEZpbHRlclF1ZXJ5KTtcblxuICAgICAgaWYgKHF1ZXJ5T2JqLl9fb3IpIHtcbiAgICAgICAgcXVlcnkuX19maWx0ZXIuX19hbmQgPSBxdWVyeS5fX2ZpbHRlci5fX2FuZCB8fCBbXTtcbiAgICAgICAgcXVlcnkuX19maWx0ZXIuX19hbmQucHVzaChxdWVyeU9iaik7XG4gICAgICB9IGVsc2UgaWYgKHF1ZXJ5T2JqLl9fYW5kICYmIGdldChxdWVyeSwgJ19fZmlsdGVyLl9fYW5kJykpIHtcbiAgICAgICAgcXVlcnlPYmouX19hbmQubWFwKG9iaiA9PiBxdWVyeS5fX2ZpbHRlci5fX2FuZC5wdXNoKG9iaikpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXNzaWduKHF1ZXJ5Ll9fZmlsdGVyLCBxdWVyeU9iaik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGNvbHVtbi5zb3J0YWJsZSAmJiBjb2x1bW4uc29ydE9yZGVyKSB7XG4gICAgICBjb25zdCBjcyA9IHt9O1xuICAgICAgZm9yRWFjaChjb2x1bW4uc29ydGluZ0NvbmZpZy5wYXRoU29ydGluZ0NvbmZpZ3MsIHBhdGhTb3J0aW5nQ29uZmlnID0+IHtcbiAgICAgICAgY3NbcGF0aFNvcnRpbmdDb25maWcucGF0aF0gPVxuICAgICAgICAgIChjb2x1bW4uc29ydE9yZGVyID09PSAnYXNjJyA/IDEgOiAtMSkgKiAocGF0aFNvcnRpbmdDb25maWcuc29ydE9yZGVyTW9kaWZpZXIgfHwgMSk7XG4gICAgICB9KTtcbiAgICAgIHF1ZXJ5Ll9fb3JkZXJieS5wdXNoKGNzKTtcbiAgICB9XG4gICAgcmV0dXJuIHF1ZXJ5O1xuICB9XG59XG4iXX0=