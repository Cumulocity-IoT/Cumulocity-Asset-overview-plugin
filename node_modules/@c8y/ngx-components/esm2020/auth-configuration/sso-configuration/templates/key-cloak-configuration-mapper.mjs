import { TemplateType } from '../sso-configuration.model';
import { at, get, head, isUndefined, map, reject } from 'lodash-es';
import { GrantType, TenantLoginOptionType, UserManagementSource } from '@c8y/client';
import { RequestConfiguration } from '../template-parts/request-configuration.model';
import { Injectable } from '@angular/core';
import { ExternalToken } from '../template-parts/external-token-config.model';
import * as i0 from "@angular/core";
export class KeyCloakConfigurationMapper {
    constructor() {
        this.urlPattern = /^(.+)\/auth\/realms\/((.+?))$/;
    }
    mapFrom(templateModel) {
        const ssoConfiguration = {
            template: TemplateType.KEYCLOAK,
            buttonName: templateModel.buttonName,
            userIdConfig: templateModel.userIdConfig,
            userManagementSource: UserManagementSource.REMOTE,
            type: TenantLoginOptionType.OAUTH2,
            onNewUser: templateModel.onNewUser,
            issuer: `${templateModel.keyCloakAddress}/auth/realms/${templateModel.realmName}`,
            redirectToPlatform: templateModel.redirectToPlatform,
            providerName: 'keycloak',
            audience: templateModel.audience,
            clientId: templateModel.clientId,
            logoutRequest: templateModel.logoutRequest.toRequest(),
            visibleOnLoginPage: templateModel.visibleOnLoginPage,
            signatureVerificationConfig: {
                jwks: {
                    jwksUri: `${templateModel.keyCloakAddress}/auth/realms/${templateModel.realmName}/protocol/openid-connect/certs`
                }
            },
            tokenRequest: {
                headers: {},
                method: 'POST',
                requestParams: {},
                operation: 'EXECUTE',
                url: `${templateModel.keyCloakAddress}/auth/realms/${templateModel.realmName}/protocol/openid-connect/token`,
                body: 'grant_type=authorization_code&code=${code}&redirect_uri=${redirectUri}&client_id=${clientId}&client_secret=${client secret}'
            },
            authorizationRequest: {
                headers: {},
                method: 'GET',
                requestParams: {
                    scope: templateModel.scopeId,
                    client_id: '${clientId}',
                    redirect_uri: '${redirectUri}',
                    response_type: 'code'
                },
                operation: 'REDIRECT',
                url: `${templateModel.keyCloakAddress}/auth/realms/${templateModel.realmName}/protocol/openid-connect/auth`,
                body: ''
            },
            refreshRequest: {
                headers: {},
                method: 'POST',
                requestParams: {
                    client_id: '${clientId}',
                    redirect_uri: '${redirectUri}',
                    response_type: 'refresh'
                },
                operation: 'EXECUTE',
                url: `${templateModel.keyCloakAddress}/auth/realms/${templateModel.realmName}/protocol/openid-connect/token`,
                body: 'grant_type=refresh_token&refresh_token=${refreshToken}&client_id=${clientId}&client_secret=' +
                    templateModel.clientSecret
            },
            grantType: GrantType.AUTHORIZATION_CODE,
            accessTokenToUserDataMappings: templateModel.accessTokenToUserDataMappings,
            externalTokenConfig: templateModel.externalTokenConfig.toExternalTokenConfig()
        };
        return ssoConfiguration;
    }
    mapTo(ssoConfiguration) {
        return {
            keyCloakAddress: this.getKeyCloakAddressFromUrl(ssoConfiguration.issuer),
            realmName: this.getRealmName(ssoConfiguration.issuer),
            clientId: ssoConfiguration.clientId,
            clientSecret: this.getClientSecret(ssoConfiguration),
            scopeId: this.getScopeId(ssoConfiguration),
            buttonName: ssoConfiguration.buttonName,
            userIdConfig: ssoConfiguration.userIdConfig,
            onNewUser: ssoConfiguration.onNewUser,
            redirectToPlatform: ssoConfiguration.redirectToPlatform,
            audience: ssoConfiguration.audience,
            logoutRequest: new RequestConfiguration(ssoConfiguration.logoutRequest),
            visibleOnLoginPage: ssoConfiguration.visibleOnLoginPage,
            accessTokenToUserDataMappings: ssoConfiguration.accessTokenToUserDataMappings,
            externalTokenConfig: new ExternalToken(ssoConfiguration.externalTokenConfig)
        };
    }
    getKeyCloakAddressFromUrl(url) {
        const [, keyCloakAddress] = (url || '').match(this.urlPattern) || [];
        return keyCloakAddress;
    }
    getRealmName(url) {
        const [, , realmName] = (url || '').match(this.urlPattern) || [];
        return realmName;
    }
    getClientSecret(ssoConfiguration) {
        const bodies = at(ssoConfiguration, ['tokenRequest.body', 'refreshRequest.body']);
        const clientSecrets = map(bodies, body => this.getClientSecretFromBody(body));
        const clientSecret = this.getFirstDefined(clientSecrets);
        return clientSecret ? decodeURIComponent(clientSecret) : '';
    }
    getClientSecretFromBody(body) {
        const [, clientSecret] = (body || '').match(/client_secret=([^&]+)/) || [];
        return clientSecret;
    }
    getFirstDefined(values) {
        return head(reject(values, isUndefined));
    }
    getScopeId(ssoConfiguration) {
        return get(ssoConfiguration, 'authorizationRequest.requestParams.scope', '');
    }
}
KeyCloakConfigurationMapper.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: KeyCloakConfigurationMapper, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
KeyCloakConfigurationMapper.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: KeyCloakConfigurationMapper, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: KeyCloakConfigurationMapper, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5LWNsb2FrLWNvbmZpZ3VyYXRpb24tbWFwcGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vYXV0aC1jb25maWd1cmF0aW9uL3Nzby1jb25maWd1cmF0aW9uL3RlbXBsYXRlcy9rZXktY2xvYWstY29uZmlndXJhdGlvbi1tYXBwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFvQixZQUFZLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM1RSxPQUFPLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDcEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxxQkFBcUIsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNyRixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwrQ0FBK0MsQ0FBQztBQUNyRixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwrQ0FBK0MsQ0FBQzs7QUFLOUUsTUFBTSxPQUFPLDJCQUEyQjtJQUh4QztRQUlVLGVBQVUsR0FBRywrQkFBK0IsQ0FBQztLQWdIdEQ7SUE5R0MsT0FBTyxDQUFDLGFBQW9DO1FBQzFDLE1BQU0sZ0JBQWdCLEdBQXFCO1lBQ3pDLFFBQVEsRUFBRSxZQUFZLENBQUMsUUFBUTtZQUMvQixVQUFVLEVBQUUsYUFBYSxDQUFDLFVBQVU7WUFDcEMsWUFBWSxFQUFFLGFBQWEsQ0FBQyxZQUFZO1lBQ3hDLG9CQUFvQixFQUFFLG9CQUFvQixDQUFDLE1BQU07WUFDakQsSUFBSSxFQUFFLHFCQUFxQixDQUFDLE1BQU07WUFDbEMsU0FBUyxFQUFFLGFBQWEsQ0FBQyxTQUFTO1lBQ2xDLE1BQU0sRUFBRSxHQUFHLGFBQWEsQ0FBQyxlQUFlLGdCQUFnQixhQUFhLENBQUMsU0FBUyxFQUFFO1lB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Q0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMzRSxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0lBRU8sZUFBZSxDQUFDLE1BQU07UUFDNUIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFFTyxVQUFVLENBQUMsZ0JBQWdCO1FBQ2pDLE9BQU8sR0FBRyxDQUFDLGdCQUFnQixFQUFFLDBDQUEwQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQy9FLENBQUM7O3dIQWhIVSwyQkFBMkI7NEhBQTNCLDJCQUEyQixjQUYxQixNQUFNOzJGQUVQLDJCQUEyQjtrQkFIdkMsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTc29Db25maWd1cmF0aW9uTWFwcGVyIH0gZnJvbSAnLi9zc28tY29uZmlndXJhdGlvbi5tYXBwZXInO1xuaW1wb3J0IHsgS2V5Q2xvYWtDb25maWd1cmF0aW9uIH0gZnJvbSAnLi9rZXktY2xvYWsubW9kZWwnO1xuaW1wb3J0IHsgU3NvQ29uZmlndXJhdGlvbiwgVGVtcGxhdGVUeXBlIH0gZnJvbSAnLi4vc3NvLWNvbmZpZ3VyYXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgYXQsIGdldCwgaGVhZCwgaXNVbmRlZmluZWQsIG1hcCwgcmVqZWN0IH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IEdyYW50VHlwZSwgVGVuYW50TG9naW5PcHRpb25UeXBlLCBVc2VyTWFuYWdlbWVudFNvdXJjZSB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IFJlcXVlc3RDb25maWd1cmF0aW9uIH0gZnJvbSAnLi4vdGVtcGxhdGUtcGFydHMvcmVxdWVzdC1jb25maWd1cmF0aW9uLm1vZGVsJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEV4dGVybmFsVG9rZW4gfSBmcm9tICcuLi90ZW1wbGF0ZS1wYXJ0cy9leHRlcm5hbC10b2tlbi1jb25maWcubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBLZXlDbG9ha0NvbmZpZ3VyYXRpb25NYXBwZXIgaW1wbGVtZW50cyBTc29Db25maWd1cmF0aW9uTWFwcGVyPEtleUNsb2FrQ29uZmlndXJhdGlvbj4ge1xuICBwcml2YXRlIHVybFBhdHRlcm4gPSAvXiguKylcXC9hdXRoXFwvcmVhbG1zXFwvKCguKz8pKSQvO1xuXG4gIG1hcEZyb20odGVtcGxhdGVNb2RlbDogS2V5Q2xvYWtDb25maWd1cmF0aW9uKTogU3NvQ29uZmlndXJhdGlvbiB7XG4gICAgY29uc3Qgc3NvQ29uZmlndXJhdGlvbjogU3NvQ29uZmlndXJhdGlvbiA9IHtcbiAgICAgIHRlbXBsYXRlOiBUZW1wbGF0ZVR5cGUuS0VZQ0xPQUssXG4gICAgICBidXR0b25OYW1lOiB0ZW1wbGF0ZU1vZGVsLmJ1dHRvbk5hbWUsXG4gICAgICB1c2VySWRDb25maWc6IHRlbXBsYXRlTW9kZWwudXNlcklkQ29uZmlnLFxuICAgICAgdXNlck1hbmFnZW1lbnRTb3VyY2U6IFVzZXJNYW5hZ2VtZW50U291cmNlLlJFTU9URSxcbiAgICAgIHR5cGU6IFRlbmFudExvZ2luT3B0aW9uVHlwZS5PQVVUSDIsXG4gICAgICBvbk5ld1VzZXI6IHRlbXBsYXRlTW9kZWwub25OZXdVc2VyLFxuICAgICAgaXNzdWVyOiBgJHt0ZW1wbGF0ZU1vZGVsLmtleUNsb2FrQWRkcmVzc30vYXV0aC9yZWFsbXMvJHt0ZW1wbGF0ZU1vZGVsLnJlYWxtTmFtZX1gLFxuICAgICAgcmVkaXJlY3RUb1BsYXRmb3JtOiB0ZW1wbGF0ZU1vZGVsLnJlZGlyZWN0VG9QbGF0Zm9ybSxcbiAgICAgIHByb3ZpZGVyTmFtZTogJ2tleWNsb2FrJyxcbiAgICAgIGF1ZGllbmNlOiB0ZW1wbGF0ZU1vZGVsLmF1ZGllbmNlLFxuICAgICAgY2xpZW50SWQ6IHRlbXBsYXRlTW9kZWwuY2xpZW50SWQsXG4gICAgICBsb2dvdXRSZXF1ZXN0OiB0ZW1wbGF0ZU1vZGVsLmxvZ291dFJlcXVlc3QudG9SZXF1ZXN0KCksXG4gICAgICB2aXNpYmxlT25Mb2dpblBhZ2U6IHRlbXBsYXRlTW9kZWwudmlzaWJsZU9uTG9naW5QYWdlLFxuICAgICAgc2lnbmF0dXJlVmVyaWZpY2F0aW9uQ29uZmlnOiB7XG4gICAgICAgIGp3a3M6IHtcbiAgICAgICAgICBqd2tzVXJpOiBgJHt0ZW1wbGF0ZU1vZGVsLmtleUNsb2FrQWRkcmVzc30vYXV0aC9yZWFsbXMvJHt0ZW1wbGF0ZU1vZGVsLnJlYWxtTmFtZX0vcHJvdG9jb2wvb3BlbmlkLWNvbm5lY3QvY2VydHNgXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB0b2tlblJlcXVlc3Q6IHtcbiAgICAgICAgaGVhZGVyczoge30sXG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICByZXF1ZXN0UGFyYW1zOiB7fSxcbiAgICAgICAgb3BlcmF0aW9uOiAnRVhFQ1VURScsXG4gICAgICAgIHVybDogYCR7dGVtcGxhdGVNb2RlbC5rZXlDbG9ha0FkZHJlc3N9L2F1dGgvcmVhbG1zLyR7dGVtcGxhdGVNb2RlbC5yZWFsbU5hbWV9L3Byb3RvY29sL29wZW5pZC1jb25uZWN0L3Rva2VuYCxcbiAgICAgICAgYm9keTogJ2dyYW50X3R5cGU9YXV0aG9yaXphdGlvbl9jb2RlJmNvZGU9JHtjb2RlfSZyZWRpcmVjdF91cmk9JHtyZWRpcmVjdFVyaX0mY2xpZW50X2lkPSR7Y2xpZW50SWR9JmNsaWVudF9zZWNyZXQ9JHtjbGllbnQgc2VjcmV0fSdcbiAgICAgIH0sXG4gICAgICBhdXRob3JpemF0aW9uUmVxdWVzdDoge1xuICAgICAgICBoZWFkZXJzOiB7fSxcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgcmVxdWVzdFBhcmFtczoge1xuICAgICAgICAgIHNjb3BlOiB0ZW1wbGF0ZU1vZGVsLnNjb3BlSWQsXG4gICAgICAgICAgY2xpZW50X2lkOiAnJHtjbGllbnRJZH0nLFxuICAgICAgICAgIHJlZGlyZWN0X3VyaTogJyR7cmVkaXJlY3RVcml9JyxcbiAgICAgICAgICByZXNwb25zZV90eXBlOiAnY29kZSdcbiAgICAgICAgfSxcbiAgICAgICAgb3BlcmF0aW9uOiAnUkVESVJFQ1QnLFxuICAgICAgICB1cmw6IGAke3RlbXBsYXRlTW9kZWwua2V5Q2xvYWtBZGRyZXNzfS9hdXRoL3JlYWxtcy8ke3RlbXBsYXRlTW9kZWwucmVhbG1OYW1lfS9wcm90b2NvbC9vcGVuaWQtY29ubmVjdC9hdXRoYCxcbiAgICAgICAgYm9keTogJydcbiAgICAgIH0sXG4gICAgICByZWZyZXNoUmVxdWVzdDoge1xuICAgICAgICBoZWFkZXJzOiB7fSxcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIHJlcXVlc3RQYXJhbXM6IHtcbiAgICAgICAgICBjbGllbnRfaWQ6ICcke2NsaWVudElkfScsXG4gICAgICAgICAgcmVkaXJlY3RfdXJpOiAnJHtyZWRpcmVjdFVyaX0nLFxuICAgICAgICAgIHJlc3BvbnNlX3R5cGU6ICdyZWZyZXNoJ1xuICAgICAgICB9LFxuICAgICAgICBvcGVyYXRpb246ICdFWEVDVVRFJyxcbiAgICAgICAgdXJsOiBgJHt0ZW1wbGF0ZU1vZGVsLmtleUNsb2FrQWRkcmVzc30vYXV0aC9yZWFsbXMvJHt0ZW1wbGF0ZU1vZGVsLnJlYWxtTmFtZX0vcHJvdG9jb2wvb3BlbmlkLWNvbm5lY3QvdG9rZW5gLFxuICAgICAgICBib2R5OlxuICAgICAgICAgICdncmFudF90eXBlPXJlZnJlc2hfdG9rZW4mcmVmcmVzaF90b2tlbj0ke3JlZnJlc2hUb2tlbn0mY2xpZW50X2lkPSR7Y2xpZW50SWR9JmNsaWVudF9zZWNyZXQ9JyArXG4gICAgICAgICAgdGVtcGxhdGVNb2RlbC5jbGllbnRTZWNyZXRcbiAgICAgIH0sXG4gICAgICBncmFudFR5cGU6IEdyYW50VHlwZS5BVVRIT1JJWkFUSU9OX0NPREUsXG4gICAgICBhY2Nlc3NUb2tlblRvVXNlckRhdGFNYXBwaW5nczogdGVtcGxhdGVNb2RlbC5hY2Nlc3NUb2tlblRvVXNlckRhdGFNYXBwaW5ncyxcbiAgICAgIGV4dGVybmFsVG9rZW5Db25maWc6IHRlbXBsYXRlTW9kZWwuZXh0ZXJuYWxUb2tlbkNvbmZpZy50b0V4dGVybmFsVG9rZW5Db25maWcoKVxuICAgIH07XG4gICAgcmV0dXJuIHNzb0NvbmZpZ3VyYXRpb247XG4gIH1cblxuICBtYXBUbyhzc29Db25maWd1cmF0aW9uOiBTc29Db25maWd1cmF0aW9uKTogS2V5Q2xvYWtDb25maWd1cmF0aW9uIHtcbiAgICByZXR1cm4ge1xuICAgICAga2V5Q2xvYWtBZGRyZXNzOiB0aGlzLmdldEtleUNsb2FrQWRkcmVzc0Zyb21Vcmwoc3NvQ29uZmlndXJhdGlvbi5pc3N1ZXIpLFxuICAgICAgcmVhbG1OYW1lOiB0aGlzLmdldFJlYWxtTmFtZShzc29Db25maWd1cmF0aW9uLmlzc3VlciksXG4gICAgICBjbGllbnRJZDogc3NvQ29uZmlndXJhdGlvbi5jbGllbnRJZCxcbiAgICAgIGNsaWVudFNlY3JldDogdGhpcy5nZXRDbGllbnRTZWNyZXQoc3NvQ29uZmlndXJhdGlvbiksXG4gICAgICBzY29wZUlkOiB0aGlzLmdldFNjb3BlSWQoc3NvQ29uZmlndXJhdGlvbiksXG4gICAgICBidXR0b25OYW1lOiBzc29Db25maWd1cmF0aW9uLmJ1dHRvbk5hbWUsXG4gICAgICB1c2VySWRDb25maWc6IHNzb0NvbmZpZ3VyYXRpb24udXNlcklkQ29uZmlnLFxuICAgICAgb25OZXdVc2VyOiBzc29Db25maWd1cmF0aW9uLm9uTmV3VXNlcixcbiAgICAgIHJlZGlyZWN0VG9QbGF0Zm9ybTogc3NvQ29uZmlndXJhdGlvbi5yZWRpcmVjdFRvUGxhdGZvcm0sXG4gICAgICBhdWRpZW5jZTogc3NvQ29uZmlndXJhdGlvbi5hdWRpZW5jZSxcbiAgICAgIGxvZ291dFJlcXVlc3Q6IG5ldyBSZXF1ZXN0Q29uZmlndXJhdGlvbihzc29Db25maWd1cmF0aW9uLmxvZ291dFJlcXVlc3QpLFxuICAgICAgdmlzaWJsZU9uTG9naW5QYWdlOiBzc29Db25maWd1cmF0aW9uLnZpc2libGVPbkxvZ2luUGFnZSxcbiAgICAgIGFjY2Vzc1Rva2VuVG9Vc2VyRGF0YU1hcHBpbmdzOiBzc29Db25maWd1cmF0aW9uLmFjY2Vzc1Rva2VuVG9Vc2VyRGF0YU1hcHBpbmdzLFxuICAgICAgZXh0ZXJuYWxUb2tlbkNvbmZpZzogbmV3IEV4dGVybmFsVG9rZW4oc3NvQ29uZmlndXJhdGlvbi5leHRlcm5hbFRva2VuQ29uZmlnKVxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGdldEtleUNsb2FrQWRkcmVzc0Zyb21VcmwodXJsKSB7XG4gICAgY29uc3QgWywga2V5Q2xvYWtBZGRyZXNzXSA9ICh1cmwgfHwgJycpLm1hdGNoKHRoaXMudXJsUGF0dGVybikgfHwgW107XG4gICAgcmV0dXJuIGtleUNsb2FrQWRkcmVzcztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UmVhbG1OYW1lKHVybCkge1xuICAgIGNvbnN0IFssICwgcmVhbG1OYW1lXSA9ICh1cmwgfHwgJycpLm1hdGNoKHRoaXMudXJsUGF0dGVybikgfHwgW107XG4gICAgcmV0dXJuIHJlYWxtTmFtZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q2xpZW50U2VjcmV0KHNzb0NvbmZpZ3VyYXRpb24pOiBzdHJpbmcge1xuICAgIGNvbnN0IGJvZGllcyA9IGF0KHNzb0NvbmZpZ3VyYXRpb24sIFsndG9rZW5SZXF1ZXN0LmJvZHknLCAncmVmcmVzaFJlcXVlc3QuYm9keSddKTtcbiAgICBjb25zdCBjbGllbnRTZWNyZXRzID0gbWFwKGJvZGllcywgYm9keSA9PiB0aGlzLmdldENsaWVudFNlY3JldEZyb21Cb2R5KGJvZHkpKTtcbiAgICBjb25zdCBjbGllbnRTZWNyZXQgPSB0aGlzLmdldEZpcnN0RGVmaW5lZChjbGllbnRTZWNyZXRzKTtcbiAgICByZXR1cm4gY2xpZW50U2VjcmV0ID8gZGVjb2RlVVJJQ29tcG9uZW50KGNsaWVudFNlY3JldCkgOiAnJztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q2xpZW50U2VjcmV0RnJvbUJvZHkoYm9keSkge1xuICAgIGNvbnN0IFssIGNsaWVudFNlY3JldF0gPSAoYm9keSB8fCAnJykubWF0Y2goL2NsaWVudF9zZWNyZXQ9KFteJl0rKS8pIHx8IFtdO1xuICAgIHJldHVybiBjbGllbnRTZWNyZXQ7XG4gIH1cblxuICBwcml2YXRlIGdldEZpcnN0RGVmaW5lZCh2YWx1ZXMpIHtcbiAgICByZXR1cm4gaGVhZChyZWplY3QodmFsdWVzLCBpc1VuZGVmaW5lZCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRTY29wZUlkKHNzb0NvbmZpZ3VyYXRpb24pIHtcbiAgICByZXR1cm4gZ2V0KHNzb0NvbmZpZ3VyYXRpb24sICdhdXRob3JpemF0aW9uUmVxdWVzdC5yZXF1ZXN0UGFyYW1zLnNjb3BlJywgJycpO1xuICB9XG59XG4iXX0=