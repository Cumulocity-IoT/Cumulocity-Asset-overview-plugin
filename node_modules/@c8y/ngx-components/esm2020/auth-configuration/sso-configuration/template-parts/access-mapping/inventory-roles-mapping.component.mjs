import { Component, Output, Input, EventEmitter } from '@angular/core';
import { ControlContainer, NgForm } from '@angular/forms';
import { BsModalService } from 'ngx-bootstrap/modal';
import { InventoryRolesModalComponent } from './inventory-roles-modal.component';
import { take } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "ngx-bootstrap/modal";
import * as i2 from "@c8y/ngx-components";
import * as i3 from "@angular/common";
import * as i4 from "./child-predicates.component";
export class InventoryRolesMappingComponent {
    constructor(bsModal) {
        this.bsModal = bsModal;
        this.inventoryRoles = [];
        this.selectedInventoryRoles = [];
        this.onRemoveInventoryMapping = new EventEmitter();
    }
    ngOnChanges() {
        this.setSelectedInventoryRoles();
    }
    onRemoveAllChildPredicates() {
        this.onRemoveInventoryMapping.emit(this.inventoryMapping);
    }
    getIds(selectedItems) {
        return selectedItems.map(item => item.id);
    }
    removeInventoryRole(inventoryRole) {
        this.inventoryMapping.thenInventoryRoles = this.inventoryMapping.thenInventoryRoles.filter(value => value.managedObject !== inventoryRole.managedObject);
        delete this.selectedInventoryRoles[inventoryRole.managedObject];
    }
    addInventoryRoles() {
        const currentlySelectedGroups = this.inventoryMapping.thenInventoryRoles.map(inventoryRole => ({ id: inventoryRole.managedObject }));
        const modal = this.bsModal.show(InventoryRolesModalComponent, {
            ignoreBackdropClick: true,
            ariaLabelledBy: 'modal-title',
            initialState: {
                selectedGroups: currentlySelectedGroups
            }
        });
        modal.content.resultEmitter.pipe(take(1)).subscribe(selectedGroups => {
            const newSelectedGroups = selectedGroups.filter(group => !currentlySelectedGroups.some(({ id }) => id === group.id));
            const newInventoryRoles = newSelectedGroups.map(group => ({ managedObject: group.id, roleIds: [] }));
            this.inventoryMapping.thenInventoryRoles =
                this.inventoryMapping.thenInventoryRoles.concat(newInventoryRoles);
        });
    }
    setSelectedInventoryRoles() {
        if (this.inventoryMapping && this.inventoryMapping.thenInventoryRoles && this.inventoryRoles) {
            this.inventoryMapping.thenInventoryRoles.forEach(inventoryRole => {
                this.selectedInventoryRoles[inventoryRole.managedObject] = this.inventoryRoles.filter(item => inventoryRole.roleIds.includes(+item.id));
            });
        }
    }
}
InventoryRolesMappingComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: InventoryRolesMappingComponent, deps: [{ token: i1.BsModalService }], target: i0.ɵɵFactoryTarget.Component });
InventoryRolesMappingComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.0.6", type: InventoryRolesMappingComponent, selector: "c8y-sso-inventory-roles-mapping", inputs: { inventoryMapping: "inventoryMapping", inventoryMappingIndex: "inventoryMappingIndex", inventoryRoles: "inventoryRoles" }, outputs: { onRemoveInventoryMapping: "onRemoveInventoryMapping" }, usesOnChanges: true, ngImport: i0, template: "<div class=\"card\">\n  <div\n    class=\"card-block overflow-visible\"\n    *ngIf=\"inventoryMapping.when.childPredicates.length !== 0\"\n  >\n    <c8y-sso-child-predicates\n      [childPredicates]=\"inventoryMapping.when.childPredicates\"\n      [accessMappingIndex]=\"'irm' + inventoryMappingIndex\"\n      (onRemoveAllChildPredicates)=\"onRemoveAllChildPredicates()\"\n    ></c8y-sso-child-predicates>\n\n    <div class=\"legend form-block\" translate>Provide inventory roles</div>\n    <div *ngIf=\"inventoryMapping.thenInventoryRoles.length !== 0\">\n      <div class=\"tight-grid hidden-sm hidden-xs\">\n        <div class=\"col-md-5\">\n          <label translate>Groups</label>\n        </div>\n        <div class=\"col-md-6\">\n          <label translate>Inventory roles</label>\n        </div>\n      </div>\n      <div\n        class=\"tight-grid\"\n        *ngFor=\"let inventoryRole of inventoryMapping.thenInventoryRoles; index as idx\"\n      >\n        <div class=\"col-md-5\">\n          <i class=\"c8y-icon c8y-icon-group m-r-4\"></i>\n          <span>{{ inventoryRole.managedObject | moName | async }}</span>\n        </div>\n        <div class=\"col-md-6\">\n          <div title=\"{{ 'Inventory roles' | translate }}\" class=\"form-group\">\n            <c8y-select\n              [id]=\"'ir' + idx + accessMappingIndex\"\n              [items]=\"inventoryRoles\"\n              [selected]=\"selectedInventoryRoles[inventoryRole.managedObject]\"\n              [disableApplyOnNoSelection]=\"true\"\n              (onChange)=\"\n                selectedInventoryRoles[inventoryRole.managedObject] = $event;\n                inventoryRole.roleIds = getIds($event)\n              \"\n            ></c8y-select>\n          </div>\n        </div>\n        <div class=\"col-md-1\">\n          <c8y-form-group>\n            <button\n              name=\"removeButton\"\n              class=\"btn btn-link hidden-xs hidden-sm\"\n              (click)=\"removeInventoryRole(inventoryRole)\"\n              title=\"{{ 'Remove' | translate }}\"\n              type=\"button\"\n            >\n              <i c8yIcon=\"minus-circle\" class=\"text-danger\"></i>\n            </button>\n            <button\n              name=\"removeButton\"\n              class=\"btn btn-danger btn-block btn-sm visible-xs visible-sm\"\n              (click)=\"removeInventoryRole(inventoryRole)\"\n              title=\"{{ 'Remove' | translate }}\"\n              type=\"button\"\n            >\n              <i c8yIcon=\"minus-circle\"></i>\n              <span translate>Remove</span>\n            </button>\n          </c8y-form-group>\n        </div>\n      </div>\n    </div>\n    <div class=\"row\">\n      <div class=\"col-sm-6\">\n        <button\n          id=\"add-inventory-roles-button\"\n          class=\"btn btn-default m-b-16\"\n          type=\"button\"\n          title=\"{{ 'Add inventory roles' | translate }}\"\n          (click)=\"addInventoryRoles()\"\n        >\n          <i c8yIcon=\"plus-circle\" class=\"m-r-4\"></i>\n          {{ 'Add inventory roles' | translate }}\n        </button>\n      </div>\n    </div>\n  </div>\n</div>\n", dependencies: [{ kind: "directive", type: i2.IconDirective, selector: "[c8yIcon]", inputs: ["c8yIcon"] }, { kind: "directive", type: i2.C8yTranslateDirective, selector: "[translate],[ngx-translate]" }, { kind: "directive", type: i3.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i3.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i2.SelectComponent, selector: "c8y-select", inputs: ["placeholder", "selectedLabel", "applyLabel", "items", "selected", "updateItems", "disableApplyOnNoSelection"], outputs: ["onChange"] }, { kind: "component", type: i2.FormGroupComponent, selector: "c8y-form-group", inputs: ["hasError", "hasWarning", "hasSuccess", "novalidation", "status"] }, { kind: "component", type: i4.ChildPredicatesComponent, selector: "c8y-sso-child-predicates", inputs: ["childPredicates", "accessMappingIndex"], outputs: ["onRemoveAllChildPredicates"] }, { kind: "pipe", type: i2.C8yTranslatePipe, name: "translate" }, { kind: "pipe", type: i3.AsyncPipe, name: "async" }, { kind: "pipe", type: i2.MoNamePipe, name: "moName" }], viewProviders: [{ provide: ControlContainer, useExisting: NgForm }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: InventoryRolesMappingComponent, decorators: [{
            type: Component,
            args: [{ selector: 'c8y-sso-inventory-roles-mapping', viewProviders: [{ provide: ControlContainer, useExisting: NgForm }], template: "<div class=\"card\">\n  <div\n    class=\"card-block overflow-visible\"\n    *ngIf=\"inventoryMapping.when.childPredicates.length !== 0\"\n  >\n    <c8y-sso-child-predicates\n      [childPredicates]=\"inventoryMapping.when.childPredicates\"\n      [accessMappingIndex]=\"'irm' + inventoryMappingIndex\"\n      (onRemoveAllChildPredicates)=\"onRemoveAllChildPredicates()\"\n    ></c8y-sso-child-predicates>\n\n    <div class=\"legend form-block\" translate>Provide inventory roles</div>\n    <div *ngIf=\"inventoryMapping.thenInventoryRoles.length !== 0\">\n      <div class=\"tight-grid hidden-sm hidden-xs\">\n        <div class=\"col-md-5\">\n          <label translate>Groups</label>\n        </div>\n        <div class=\"col-md-6\">\n          <label translate>Inventory roles</label>\n        </div>\n      </div>\n      <div\n        class=\"tight-grid\"\n        *ngFor=\"let inventoryRole of inventoryMapping.thenInventoryRoles; index as idx\"\n      >\n        <div class=\"col-md-5\">\n          <i class=\"c8y-icon c8y-icon-group m-r-4\"></i>\n          <span>{{ inventoryRole.managedObject | moName | async }}</span>\n        </div>\n        <div class=\"col-md-6\">\n          <div title=\"{{ 'Inventory roles' | translate }}\" class=\"form-group\">\n            <c8y-select\n              [id]=\"'ir' + idx + accessMappingIndex\"\n              [items]=\"inventoryRoles\"\n              [selected]=\"selectedInventoryRoles[inventoryRole.managedObject]\"\n              [disableApplyOnNoSelection]=\"true\"\n              (onChange)=\"\n                selectedInventoryRoles[inventoryRole.managedObject] = $event;\n                inventoryRole.roleIds = getIds($event)\n              \"\n            ></c8y-select>\n          </div>\n        </div>\n        <div class=\"col-md-1\">\n          <c8y-form-group>\n            <button\n              name=\"removeButton\"\n              class=\"btn btn-link hidden-xs hidden-sm\"\n              (click)=\"removeInventoryRole(inventoryRole)\"\n              title=\"{{ 'Remove' | translate }}\"\n              type=\"button\"\n            >\n              <i c8yIcon=\"minus-circle\" class=\"text-danger\"></i>\n            </button>\n            <button\n              name=\"removeButton\"\n              class=\"btn btn-danger btn-block btn-sm visible-xs visible-sm\"\n              (click)=\"removeInventoryRole(inventoryRole)\"\n              title=\"{{ 'Remove' | translate }}\"\n              type=\"button\"\n            >\n              <i c8yIcon=\"minus-circle\"></i>\n              <span translate>Remove</span>\n            </button>\n          </c8y-form-group>\n        </div>\n      </div>\n    </div>\n    <div class=\"row\">\n      <div class=\"col-sm-6\">\n        <button\n          id=\"add-inventory-roles-button\"\n          class=\"btn btn-default m-b-16\"\n          type=\"button\"\n          title=\"{{ 'Add inventory roles' | translate }}\"\n          (click)=\"addInventoryRoles()\"\n        >\n          <i c8yIcon=\"plus-circle\" class=\"m-r-4\"></i>\n          {{ 'Add inventory roles' | translate }}\n        </button>\n      </div>\n    </div>\n  </div>\n</div>\n" }]
        }], ctorParameters: function () { return [{ type: i1.BsModalService }]; }, propDecorators: { inventoryMapping: [{
                type: Input
            }], inventoryMappingIndex: [{
                type: Input
            }], inventoryRoles: [{
                type: Input
            }], onRemoveInventoryMapping: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW52ZW50b3J5LXJvbGVzLW1hcHBpbmcuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vYXV0aC1jb25maWd1cmF0aW9uL3Nzby1jb25maWd1cmF0aW9uL3RlbXBsYXRlLXBhcnRzL2FjY2Vzcy1tYXBwaW5nL2ludmVudG9yeS1yb2xlcy1tYXBwaW5nLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uLy4uL2F1dGgtY29uZmlndXJhdGlvbi9zc28tY29uZmlndXJhdGlvbi90ZW1wbGF0ZS1wYXJ0cy9hY2Nlc3MtbWFwcGluZy9pbnZlbnRvcnktcm9sZXMtbWFwcGluZy5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUxRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDckQsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDakYsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7Ozs7QUFRdEMsTUFBTSxPQUFPLDhCQUE4QjtJQVN6QyxZQUFvQixPQUF1QjtRQUF2QixZQUFPLEdBQVAsT0FBTyxDQUFnQjtRQUxsQyxtQkFBYyxHQUFrQixFQUFFLENBQUM7UUFDNUMsMkJBQXNCLEdBQWtCLEVBQUUsQ0FBQztRQUVqQyw2QkFBd0IsR0FBbUMsSUFBSSxZQUFZLEVBQUUsQ0FBQztJQUUxQyxDQUFDO0lBRS9DLFdBQVc7UUFDVCxJQUFJLENBQUMseUJBQXlCLEVBQUUsQ0FBQztJQUNuQyxDQUFDO0lBRUQsMEJBQTBCO1FBQ3hCLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMs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QkFBZ0IsRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLENBQUM7cUdBRzFELGdCQUFnQjtzQkFBeEIsS0FBSztnQkFDRyxxQkFBcUI7c0JBQTdCLEtBQUs7Z0JBRUcsY0FBYztzQkFBdEIsS0FBSztnQkFHSSx3QkFBd0I7c0JBQWpDLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE91dHB1dCwgSW5wdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29udHJvbENvbnRhaW5lciwgTmdGb3JtIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgSW52ZW50b3J5TWFwcGluZywgSW52ZW50b3J5Um9sZSB9IGZyb20gJy4uLy4uL3Nzby1jb25maWd1cmF0aW9uLm1vZGVsJztcbmltcG9ydCB7IEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSAnbmd4LWJvb3RzdHJhcC9tb2RhbCc7XG5pbXBvcnQgeyBJbnZlbnRvcnlSb2xlc01vZGFsQ29tcG9uZW50IH0gZnJvbSAnLi9pbnZlbnRvcnktcm9sZXMtbW9kYWwuY29tcG9uZW50JztcbmltcG9ydCB7IHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBJSWRlbnRpZmllZCB9IGZyb20gJ0BjOHkvY2xpZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXNzby1pbnZlbnRvcnktcm9sZXMtbWFwcGluZycsXG4gIHRlbXBsYXRlVXJsOiAnLi9pbnZlbnRvcnktcm9sZXMtbWFwcGluZy5jb21wb25lbnQuaHRtbCcsXG4gIHZpZXdQcm92aWRlcnM6IFt7IHByb3ZpZGU6IENvbnRyb2xDb250YWluZXIsIHVzZUV4aXN0aW5nOiBOZ0Zvcm0gfV1cbn0pXG5leHBvcnQgY2xhc3MgSW52ZW50b3J5Um9sZXNNYXBwaW5nQ29tcG9uZW50IHtcbiAgQElucHV0KCkgaW52ZW50b3J5TWFwcGluZzogSW52ZW50b3J5TWFwcGluZztcbiAgQElucHV0KCkgaW52ZW50b3J5TWFwcGluZ0luZGV4OiBudW1iZXI7XG5cbiAgQElucHV0KCkgaW52ZW50b3J5Um9sZXM6IElJZGVudGlmaWVkW10gPSBbXTtcbiAgc2VsZWN0ZWRJbnZlbnRvcnlSb2xlczogSUlkZW50aWZpZWRbXSA9IFtdO1xuXG4gIEBPdXRwdXQoKSBvblJlbW92ZUludmVudG9yeU1hcHBpbmc6IEV2ZW50RW1pdHRlcjxJbnZlbnRvcnlNYXBwaW5nPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGJzTW9kYWw6IEJzTW9kYWxTZXJ2aWNlKSB7fVxuXG4gIG5nT25DaGFuZ2VzKCk6IHZvaWQge1xuICAgIHRoaXMuc2V0U2VsZWN0ZWRJbnZlbnRvcnlSb2xlcygpO1xuICB9XG5cbiAgb25SZW1vdmVBbGxDaGlsZFByZWRpY2F0ZXMoKSB7XG4gICAgdGhpcy5vblJlbW92ZUludmVudG9yeU1hcHBpbmcuZW1pdCh0aGlzLmludmVudG9yeU1hcHBpbmcpO1xuICB9XG5cbiAgZ2V0SWRzKHNlbGVjdGVkSXRlbXM6IElJZGVudGlmaWVkW10pIHtcbiAgICByZXR1cm4gc2VsZWN0ZWRJdGVtcy5tYXAoaXRlbSA9PiBpdGVtLmlkKTtcbiAgfVxuXG4gIHJlbW92ZUludmVudG9yeVJvbGUoaW52ZW50b3J5Um9sZTogSW52ZW50b3J5Um9sZSkge1xuICAgIHRoaXMuaW52ZW50b3J5TWFwcGluZy50aGVuSW52ZW50b3J5Um9sZXMgPSB0aGlzLmludmVudG9yeU1hcHBpbmcudGhlbkludmVudG9yeVJvbGVzLmZpbHRlcihcbiAgICAgIHZhbHVlID0+IHZhbHVlLm1hbmFnZWRPYmplY3QgIT09IGludmVudG9yeVJvbGUubWFuYWdlZE9iamVjdFxuICAgICk7XG4gICAgZGVsZXRlIHRoaXMuc2VsZWN0ZWRJbnZlbnRvcnlSb2xlc1tpbnZlbnRvcnlSb2xlLm1hbmFnZWRPYmplY3RdO1xuICB9XG5cbiAgYWRkSW52ZW50b3J5Um9sZXMoKSB7XG4gICAgY29uc3QgY3VycmVudGx5U2VsZWN0ZWRHcm91cHM6IElJZGVudGlmaWVkW10gPSB0aGlzLmludmVudG9yeU1hcHBpbmcudGhlbkludmVudG9yeVJvbGVzLm1hcChcbiAgICAgIGludmVudG9yeVJvbGUgPT4gKHsgaWQ6IGludmVudG9yeVJvbGUubWFuYWdlZE9iamVjdCB9KVxuICAgICk7XG4gICAgY29uc3QgbW9kYWwgPSB0aGlzLmJzTW9kYWwuc2hvdyhJbnZlbnRvcnlSb2xlc01vZGFsQ29tcG9uZW50LCB7XG4gICAgICBpZ25vcmVCYWNrZHJvcENsaWNrOiB0cnVlLFxuICAgICAgYXJpYUxhYmVsbGVkQnk6ICdtb2RhbC10aXRsZScsXG4gICAgICBpbml0aWFsU3RhdGU6IHtcbiAgICAgICAgc2VsZWN0ZWRHcm91cHM6IGN1cnJlbnRseVNlbGVjdGVkR3JvdXBzXG4gICAgICB9XG4gICAgfSk7XG4gICAgbW9kYWwuY29udGVudC5yZXN1bHRFbWl0dGVyLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKHNlbGVjdGVkR3JvdXBzID0+IHtcbiAgICAgIGNvbnN0IG5ld1NlbGVjdGVkR3JvdXBzID0gc2VsZWN0ZWRHcm91cHMuZmlsdGVyKFxuICAgICAgICBncm91cCA9PiAhY3VycmVudGx5U2VsZWN0ZWRHcm91cHMuc29tZSgoeyBpZCB9KSA9PiBpZCA9PT0gZ3JvdXAuaWQpXG4gICAgICApO1xuICAgICAgY29uc3QgbmV3SW52ZW50b3J5Um9sZXM6IEludmVudG9yeVJvbGVbXSA9IG5ld1NlbGVjdGVkR3JvdXBzLm1hcChcbiAgICAgICAgZ3JvdXAgPT4gKHsgbWFuYWdlZE9iamVjdDogZ3JvdXAuaWQsIHJvbGVJZHM6IFtdIH0gYXMgSW52ZW50b3J5Um9sZSlcbiAgICAgICk7XG4gICAgICB0aGlzLmludmVudG9yeU1hcHBpbmcudGhlbkludmVudG9yeVJvbGVzID1cbiAgICAgICAgdGhpcy5pbnZlbnRvcnlNYXBwaW5nLnRoZW5JbnZlbnRvcnlSb2xlcy5jb25jYXQobmV3SW52ZW50b3J5Um9sZXMpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRTZWxlY3RlZEludmVudG9yeVJvbGVzKCkge1xuICAgIGlmICh0aGlzLmludmVudG9yeU1hcHBpbmcgJiYgdGhpcy5pbnZlbnRvcnlNYXBwaW5nLnRoZW5JbnZlbnRvcnlSb2xlcyAmJiB0aGlzLmludmVudG9yeVJvbGVzKSB7XG4gICAgICB0aGlzLmludmVudG9yeU1hcHBpbmcudGhlbkludmVudG9yeVJvbGVzLmZvckVhY2goaW52ZW50b3J5Um9sZSA9PiB7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRJbnZlbnRvcnlSb2xlc1tpbnZlbnRvcnlSb2xlLm1hbmFnZWRPYmplY3RdID0gdGhpcy5pbnZlbnRvcnlSb2xlcy5maWx0ZXIoXG4gICAgICAgICAgaXRlbSA9PiBpbnZlbnRvcnlSb2xlLnJvbGVJZHMuaW5jbHVkZXMoK2l0ZW0uaWQpXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn1cbiIsIjxkaXYgY2xhc3M9XCJjYXJkXCI+XG4gIDxkaXZcbiAgICBjbGFzcz1cImNhcmQtYmxvY2sgb3ZlcmZsb3ctdmlzaWJsZVwiXG4gICAgKm5nSWY9XCJpbnZlbnRvcnlNYXBwaW5nLndoZW4uY2hpbGRQcmVkaWNhdGVzLmxlbmd0aCAhPT0gMFwiXG4gID5cbiAgICA8Yzh5LXNzby1jaGlsZC1wcmVkaWNhdGVzXG4gICAgICBbY2hpbGRQcmVkaWNhdGVzXT1cImludmVudG9yeU1hcHBpbmcud2hlbi5jaGlsZFByZWRpY2F0ZXNcIlxuICAgICAgW2FjY2Vzc01hcHBpbmdJbmRleF09XCInaXJtJyArIGludmVudG9yeU1hcHBpbmdJbmRleFwiXG4gICAgICAob25SZW1vdmVBbGxDaGlsZFByZWRpY2F0ZXMpPVwib25SZW1vdmVBbGxDaGlsZFByZWRpY2F0ZXMoKVwiXG4gICAgPjwvYzh5LXNzby1jaGlsZC1wcmVkaWNhdGVzPlxuXG4gICAgPGRpdiBjbGFzcz1cImxlZ2VuZCBmb3JtLWJsb2NrXCIgdHJhbnNsYXRlPlByb3ZpZGUgaW52ZW50b3J5IHJvbGVzPC9kaXY+XG4gICAgPGRpdiAqbmdJZj1cImludmVudG9yeU1hcHBpbmcudGhlbkludmVudG9yeVJvbGVzLmxlbmd0aCAhPT0gMFwiPlxuICAgICAgPGRpdiBjbGFzcz1cInRpZ2h0LWdyaWQgaGlkZGVuLXNtIGhpZGRlbi14c1wiPlxuICAgICAgICA8ZGl2IGNsYXNzPVwiY29sLW1kLTVcIj5cbiAgICAgICAgICA8bGFiZWwgdHJhbnNsYXRlPkdyb3VwczwvbGFiZWw+XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8ZGl2IGNsYXNzPVwiY29sLW1kLTZcIj5cbiAgICAgICAgICA8bGFiZWwgdHJhbnNsYXRlPkludmVudG9yeSByb2xlczwvbGFiZWw+XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9kaXY+XG4gICAgICA8ZGl2XG4gICAgICAgIGNsYXNzPVwidGlnaHQtZ3JpZFwiXG4gICAgICAgICpuZ0Zvcj1cImxldCBpbnZlbnRvcnlSb2xlIG9mIGludmVudG9yeU1hcHBpbmcudGhlbkludmVudG9yeVJvbGVzOyBpbmRleCBhcyBpZHhcIlxuICAgICAgPlxuICAgICAgICA8ZGl2IGNsYXNzPVwiY29sLW1kLTVcIj5cbiAgICAgICAgICA8aSBjbGFzcz1cImM4eS1pY29uIGM4eS1pY29uLWdyb3VwIG0tci00XCI+PC9pPlxuICAgICAgICAgIDxzcGFuPnt7IGludmVudG9yeVJvbGUubWFuYWdlZE9iamVjdCB8IG1vTmFtZSB8IGFzeW5jIH19PC9zcGFuPlxuICAgICAgICA8L2Rpdj5cbiAgICAgICAgPGRpdiBjbGFzcz1cImNvbC1tZC02XCI+XG4gICAgICAgICAgPGRpdiB0aXRsZT1cInt7ICdJbnZlbnRvcnkgcm9sZXMnIHwgdHJhbnNsYXRlIH19XCIgY2xhc3M9XCJmb3JtLWdyb3VwXCI+XG4gICAgICAgICAgICA8Yzh5LXNlbGVjdFxuICAgICAgICAgICAgICBbaWRdPVwiJ2lyJyArIGlkeCArIGFjY2Vzc01hcHBpbmdJbmRleFwiXG4gICAgICAgICAgICAgIFtpdGVtc109XCJpbnZlbnRvcnlSb2xlc1wiXG4gICAgICAgICAgICAgIFtzZWxlY3RlZF09XCJzZWxlY3RlZEludmVudG9yeVJvbGVzW2ludmVudG9yeVJvbGUubWFuYWdlZE9iamVjdF1cIlxuICAgICAgICAgICAgICBbZGlzYWJsZUFwcGx5T25Ob1NlbGVjdGlvbl09XCJ0cnVlXCJcbiAgICAgICAgICAgICAgKG9uQ2hhbmdlKT1cIlxuICAgICAgICAgICAgICAgIHNlbGVjdGVkSW52ZW50b3J5Um9sZXNbaW52ZW50b3J5Um9sZS5tYW5hZ2VkT2JqZWN0XSA9ICRldmVudDtcbiAgICAgICAgICAgICAgICBpbnZlbnRvcnlSb2xlLnJvbGVJZHMgPSBnZXRJZHMoJGV2ZW50KVxuICAgICAgICAgICAgICBcIlxuICAgICAgICAgICAgPjwvYzh5LXNlbGVjdD5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJjb2wtbWQtMVwiPlxuICAgICAgICAgIDxjOHktZm9ybS1ncm91cD5cbiAgICAgICAgICAgIDxidXR0b25cbiAgICAgICAgICAgICAgbmFtZT1cInJlbW92ZUJ1dHRvblwiXG4gICAgICAgICAgICAgIGNsYXNzPVwiYnRuIGJ0bi1saW5rIGhpZGRlbi14cyBoaWRkZW4tc21cIlxuICAgICAgICAgICAgICAoY2xpY2spPVwicmVtb3ZlSW52ZW50b3J5Um9sZShpbnZlbnRvcnlSb2xlKVwiXG4gICAgICAgICAgICAgIHRpdGxlPVwie3sgJ1JlbW92ZScgfCB0cmFuc2xhdGUgfX1cIlxuICAgICAgICAgICAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgPGkgYzh5SWNvbj1cIm1pbnVzLWNpcmNsZVwiIGNsYXNzPVwidGV4dC1kYW5nZXJcIj48L2k+XG4gICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICAgIDxidXR0b25cbiAgICAgICAgICAgICAgbmFtZT1cInJlbW92ZUJ1dHRvblwiXG4gICAgICAgICAgICAgIGNsYXNzPVwiYnRuIGJ0bi1kYW5nZXIgYnRuLWJsb2NrIGJ0bi1zbSB2aXNpYmxlLXhzIHZpc2libGUtc21cIlxuICAgICAgICAgICAgICAoY2xpY2spPVwicmVtb3ZlSW52ZW50b3J5Um9sZShpbnZlbnRvcnlSb2xlKVwiXG4gICAgICAgICAgICAgIHRpdGxlPVwie3sgJ1JlbW92ZScgfCB0cmFuc2xhdGUgfX1cIlxuICAgICAgICAgICAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgPGkgYzh5SWNvbj1cIm1pbnVzLWNpcmNsZVwiPjwvaT5cbiAgICAgICAgICAgICAgPHNwYW4gdHJhbnNsYXRlPlJlbW92ZTwvc3Bhbj5cbiAgICAgICAgICAgIDwvYnV0dG9uPlxuICAgICAgICAgIDwvYzh5LWZvcm0tZ3JvdXA+XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG4gICAgPGRpdiBjbGFzcz1cInJvd1wiPlxuICAgICAgPGRpdiBjbGFzcz1cImNvbC1zbS02XCI+XG4gICAgICAgIDxidXR0b25cbiAgICAgICAgICBpZD1cImFkZC1pbnZlbnRvcnktcm9sZXMtYnV0dG9uXCJcbiAgICAgICAgICBjbGFzcz1cImJ0biBidG4tZGVmYXVsdCBtLWItMTZcIlxuICAgICAgICAgIHR5cGU9XCJidXR0b25cIlxuICAgICAgICAgIHRpdGxlPVwie3sgJ0FkZCBpbnZlbnRvcnkgcm9sZXMnIHwgdHJhbnNsYXRlIH19XCJcbiAgICAgICAgICAoY2xpY2spPVwiYWRkSW52ZW50b3J5Um9sZXMoKVwiXG4gICAgICAgID5cbiAgICAgICAgICA8aSBjOHlJY29uPVwicGx1cy1jaXJjbGVcIiBjbGFzcz1cIm0tci00XCI+PC9pPlxuICAgICAgICAgIHt7ICdBZGQgaW52ZW50b3J5IHJvbGVzJyB8IHRyYW5zbGF0ZSB9fVxuICAgICAgICA8L2J1dHRvbj5cbiAgICAgIDwvZGl2PlxuICAgIDwvZGl2PlxuICA8L2Rpdj5cbjwvZGl2PlxuIl19