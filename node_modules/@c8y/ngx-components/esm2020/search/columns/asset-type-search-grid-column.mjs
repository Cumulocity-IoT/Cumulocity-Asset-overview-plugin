import { getBasicInputArrayFormFieldConfig, gettext, SearchFilters } from '@c8y/ngx-components';
import { BaseColumn } from '@c8y/ngx-components';
import { AssetTypeCellRendererComponent } from './asset-type.cell-renderer.component';
export class AssetTypeSearchGridColumn extends BaseColumn {
    constructor(hideExtendedFilters, initialColumnConfig, assetSearchService, customPlaceholder) {
        super(initialColumnConfig);
        this.name = 'type';
        this.header = gettext('Type');
        this.dataType = "icon" /* ColumnDataType.Icon */;
        this.cellRendererComponent = AssetTypeCellRendererComponent;
        this.sortable = true;
        this.sortingConfig = {
            pathSortingConfigs: [{ path: `c8y_IsDeviceGroup` }]
        };
        this.filterable = true;
        this.filteringConfig = this.getFilteringConfig(hideExtendedFilters, assetSearchService, customPlaceholder);
    }
    getFilteringConfig(hideExtendedFilters, assetSearchService, customPlaceholder) {
        return {
            fields: [
                ...getBasicInputArrayFormFieldConfig({
                    key: 'types',
                    label: gettext('Show items with type'),
                    addText: gettext('Add next`type`'),
                    tooltip: gettext('Use * as a wildcard character'),
                    placeholder: customPlaceholder ? customPlaceholder : gettext('building`e.g. house`'),
                    optional: !hideExtendedFilters
                }),
                {
                    key: SearchFilters.ALL_FILTERS,
                    type: 'checkbox',
                    hide: hideExtendedFilters,
                    templateOptions: {
                        indeterminate: false,
                        disabled: false,
                        label: gettext('All'),
                        click: (field, clickEvent) => {
                            const { checked } = clickEvent.target;
                            // Handle checked state
                            if (checked) {
                                field.form.get(SearchFilters.ONLY_DEVICES).setValue(true);
                                field.form.get(SearchFilters.ONLY_GROUPS_AND_ASSETS).setValue(true);
                                // Emit new state
                                assetSearchService.appliedFilters$.next({
                                    [SearchFilters.ALL_FILTERS]: checked,
                                    [SearchFilters.ONLY_DEVICES]: true,
                                    [SearchFilters.ONLY_GROUPS_AND_ASSETS]: true
                                });
                            }
                        }
                    },
                    expressionProperties: {
                        'templateOptions.indeterminate': (model, formState, field) => {
                            // Do nothing
                            if (field.form.get(SearchFilters.ALL_FILTERS).value === true) {
                                return;
                            }
                            // Set indeterminate state
                            if (!field.form.get(SearchFilters.ONLY_DEVICES).value ||
                                !field.form.get(SearchFilters.ONLY_GROUPS_AND_ASSETS).value) {
                                field.form.get(SearchFilters.ALL_FILTERS).setValue(null);
                                return true;
                            }
                            return false;
                        },
                        'templateOptions.disabled': (model, formState, field) => {
                            if (field.form.get(SearchFilters.ALL_FILTERS).value === true) {
                                return true;
                            }
                            return false;
                        }
                    },
                    hooks: {
                        onInit: field => {
                            // Get initial state
                            const { allFilters } = assetSearchService?.appliedFilters$?.value;
                            field.formControl.setValue(allFilters);
                        }
                    }
                },
                {
                    key: SearchFilters.ONLY_DEVICES,
                    type: 'checkbox',
                    hide: hideExtendedFilters,
                    templateOptions: {
                        indeterminate: false,
                        label: gettext('Show only devices'),
                        click: (field, clickEvent) => {
                            const oldFilterValue = assetSearchService.appliedFilters$.value;
                            const { checked } = clickEvent.target;
                            // Handle checked state
                            if (checked) {
                                field.form.get(SearchFilters.ALL_FILTERS).setValue(true);
                                // Emit new state
                                assetSearchService.appliedFilters$.next({
                                    ...oldFilterValue,
                                    [SearchFilters.ALL_FILTERS]: true,
                                    [SearchFilters.ONLY_DEVICES]: checked
                                });
                                return;
                            }
                            // Handle unchecked state
                            field.form.get(SearchFilters.ALL_FILTERS).setValue(null); // Trigger indeterminate state
                            field.form.get(SearchFilters.ONLY_GROUPS_AND_ASSETS).setValue(true);
                            // Emit new state
                            assetSearchService.appliedFilters$.next({
                                [SearchFilters.ALL_FILTERS]: null,
                                [SearchFilters.ONLY_GROUPS_AND_ASSETS]: true,
                                [SearchFilters.ONLY_DEVICES]: checked
                            });
                        }
                    },
                    hooks: {
                        onInit: field => {
                            // Get initial state
                            const { onlyDevices } = assetSearchService?.appliedFilters$?.value;
                            field.formControl.setValue(onlyDevices);
                        }
                    }
                },
                {
                    key: SearchFilters.ONLY_GROUPS_AND_ASSETS,
                    type: 'checkbox',
                    hide: hideExtendedFilters,
                    templateOptions: {
                        indeterminate: false,
                        label: gettext('Show only groups and assets'),
                        click: (field, clickEvent) => {
                            const oldFilterValue = assetSearchService.appliedFilters$.value;
                            const { checked } = clickEvent.target;
                            // Handle checked state
                            if (checked) {
                                field.form.get(SearchFilters.ALL_FILTERS).setValue(true);
                                // Emit new state
                                assetSearchService.appliedFilters$.next({
                                    ...oldFilterValue,
                                    [SearchFilters.ALL_FILTERS]: true,
                                    [SearchFilters.ONLY_GROUPS_AND_ASSETS]: checked
                                });
                                return;
                            }
                            // Handle unchecked state
                            field.form.get(SearchFilters.ALL_FILTERS).setValue(null); // Trigger indeterminate state
                            field.form.get(SearchFilters.ONLY_DEVICES).setValue(true);
                            // Emit new state
                            assetSearchService.appliedFilters$.next({
                                [SearchFilters.ALL_FILTERS]: null,
                                [SearchFilters.ONLY_GROUPS_AND_ASSETS]: checked,
                                [SearchFilters.ONLY_DEVICES]: true
                            });
                        }
                    },
                    hooks: {
                        onInit: field => {
                            // Get initial state
                            const { onlyGroupsAndAssets } = assetSearchService?.appliedFilters$?.value;
                            field.formControl.setValue(onlyGroupsAndAssets);
                        }
                    }
                }
            ],
            /**
             * Adding devices and groups to a filter is already handled in {@link AssetSearchService#buildSearchQuery}
             * */
            getFilter(model) {
                const filter = {};
                const ors = [];
                if (model.types?.length) {
                    ors.push({ type: { __in: model.types } });
                }
                if (ors.length) {
                    filter.__or = ors;
                }
                return filter;
            }
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtdHlwZS1zZWFyY2gtZ3JpZC1jb2x1bW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zZWFyY2gvY29sdW1ucy9hc3NldC10eXBlLXNlYXJjaC1ncmlkLWNvbHVtbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBR0wsaUNBQWlDLEVBQ2pDLE9BQU8sRUFDUCxhQUFhLEVBQ2QsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFakQsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFHdEYsTUFBTSxPQUFPLHlCQUEwQixTQUFRLFVBQVU7SUFDdkQsWUFDRSxtQkFBNEIsRUFDNUIsbUJBQWtDLEVBQ2xDLGtCQUF1QyxFQUN2QyxpQkFBMEI7UUFFMUIsS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDM0IsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUM7UUFDbkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDOUIsSUFBSSxDQUFDLFFBQVEsbUNBQXNCLENBQUM7UUFDcEMsSUFBSSxDQUFDLHFCQUFxQixHQUFHLDhCQUE4QixDQUFDO1FBQzVELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxhQUFhLEdBQUc7WUFDbkIsa0JBQWtCLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxtQkFBbUIsRUFBRSxDQUFDO1NBQ3BELENBQUM7UUFFRixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUN2QixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FDNUMsbUJBQW1CLEVBQ25CLGtCQUFrQixFQUNsQixpQkFBaUIsQ0FDbEIsQ0FBQztJQUNKLENBQUM7SUFFTyxrQkFBa0IsQ0FDeEIsbUJBQTRCLEVBQzVC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QU0sR0FBUSxFQUFFLENBQUM7Z0JBQ3ZCLE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQztnQkFDZixJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFO29CQUN2QixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7aUJBQzNDO2dCQUNELElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRTtvQkFDZCxNQUFNLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQztpQkFDbkI7Z0JBQ0QsT0FBTyxNQUFNLENBQUM7WUFDaEIsQ0FBQztTQUNGLENBQUM7SUFDSixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb2x1bW5Db25maWcsXG4gIENvbHVtbkRhdGFUeXBlLFxuICBnZXRCYXNpY0lucHV0QXJyYXlGb3JtRmllbGRDb25maWcsXG4gIGdldHRleHQsXG4gIFNlYXJjaEZpbHRlcnNcbn0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBCYXNlQ29sdW1uIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBGb3JtbHlGaWVsZENvbmZpZyB9IGZyb20gJ0BuZ3gtZm9ybWx5L2NvcmUnO1xuaW1wb3J0IHsgQXNzZXRUeXBlQ2VsbFJlbmRlcmVyQ29tcG9uZW50IH0gZnJvbSAnLi9hc3NldC10eXBlLmNlbGwtcmVuZGVyZXIuY29tcG9uZW50JztcbmltcG9ydCB7IEFzc2V0U2VhcmNoU2VydmljZSB9IGZyb20gJy4uL3NlYXJjaC5zZXJ2aWNlJztcblxuZXhwb3J0IGNsYXNzIEFzc2V0VHlwZVNlYXJjaEdyaWRDb2x1bW4gZXh0ZW5kcyBCYXNlQ29sdW1uIHtcbiAgY29uc3RydWN0b3IoXG4gICAgaGlkZUV4dGVuZGVkRmlsdGVyczogYm9vbGVhbixcbiAgICBpbml0aWFsQ29sdW1uQ29uZmlnPzogQ29sdW1uQ29uZmlnLFxuICAgIGFzc2V0U2VhcmNoU2VydmljZT86IEFzc2V0U2VhcmNoU2VydmljZSxcbiAgICBjdXN0b21QbGFjZWhvbGRlcj86IHN0cmluZ1xuICApIHtcbiAgICBzdXBlcihpbml0aWFsQ29sdW1uQ29uZmlnKTtcbiAgICB0aGlzLm5hbWUgPSAndHlwZSc7XG4gICAgdGhpcy5oZWFkZXIgPSBnZXR0ZXh0KCdUeXBlJyk7XG4gICAgdGhpcy5kYXRhVHlwZSA9IENvbHVtbkRhdGFUeXBlLkljb247XG4gICAgdGhpcy5jZWxsUmVuZGVyZXJDb21wb25lbnQgPSBBc3NldFR5cGVDZWxsUmVuZGVyZXJDb21wb25lbnQ7XG4gICAgdGhpcy5zb3J0YWJsZSA9IHRydWU7XG4gICAgdGhpcy5zb3J0aW5nQ29uZmlnID0ge1xuICAgICAgcGF0aFNvcnRpbmdDb25maWdzOiBbeyBwYXRoOiBgYzh5X0lzRGV2aWNlR3JvdXBgIH1dXG4gICAgfTtcblxuICAgIHRoaXMuZmlsdGVyYWJsZSA9IHRydWU7XG4gICAgdGhpcy5maWx0ZXJpbmdDb25maWcgPSB0aGlzLmdldEZpbHRlcmluZ0NvbmZpZyhcbiAgICAgIGhpZGVFeHRlbmRlZEZpbHRlcnMsXG4gICAgICBhc3NldFNlYXJjaFNlcnZpY2UsXG4gICAgICBjdXN0b21QbGFjZWhvbGRlclxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldEZpbHRlcmluZ0NvbmZpZyhcbiAgICBoaWRlRXh0ZW5kZWRGaWx0ZXJzOiBib29sZWFuLFxuICAgIGFzc2V0U2VhcmNoU2VydmljZTogQXNzZXRTZWFyY2hTZXJ2aWNlLFxuICAgIGN1c3RvbVBsYWNlaG9sZGVyPzogc3RyaW5nXG4gICkge1xuICAgIHJldHVybiB7XG4gICAgICBmaWVsZHM6IFtcbiAgICAgICAgLi4uZ2V0QmFzaWNJbnB1dEFycmF5Rm9ybUZpZWxkQ29uZmlnKHtcbiAgICAgICAgICBrZXk6ICd0eXBlcycsXG4gICAgICAgICAgbGFiZWw6IGdldHRleHQoJ1Nob3cgaXRlbXMgd2l0aCB0eXBlJyksXG4gICAgICAgICAgYWRkVGV4dDogZ2V0dGV4dCgnQWRkIG5leHRgdHlwZWAnKSxcbiAgICAgICAgICB0b29sdGlwOiBnZXR0ZXh0KCdVc2UgKiBhcyBhIHdpbGRjYXJkIGNoYXJhY3RlcicpLFxuICAgICAgICAgIHBsYWNlaG9sZGVyOiBjdXN0b21QbGFjZWhvbGRlciA/IGN1c3RvbVBsYWNlaG9sZGVyIDogZ2V0dGV4dCgnYnVpbGRpbmdgZS5nLiBob3VzZWAnKSxcbiAgICAgICAgICBvcHRpb25hbDogIWhpZGVFeHRlbmRlZEZpbHRlcnNcbiAgICAgICAgfSksXG4gICAgICAgIHtcbiAgICAgICAgICBrZXk6IFNlYXJjaEZpbHRlcnMuQUxMX0ZJTFRFUlMsXG4gICAgICAgICAgdHlwZTogJ2NoZWNrYm94JyxcbiAgICAgICAgICBoaWRlOiBoaWRlRXh0ZW5kZWRGaWx0ZXJzLFxuICAgICAgICAgIHRlbXBsYXRlT3B0aW9uczoge1xuICAgICAgICAgICAgaW5kZXRlcm1pbmF0ZTogZmFsc2UsXG4gICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXG4gICAgICAgICAgICBsYWJlbDogZ2V0dGV4dCgnQWxsJyksXG4gICAgICAgICAgICBjbGljazogKGZpZWxkLCBjbGlja0V2ZW50KSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IHsgY2hlY2tlZCB9ID0gY2xpY2tFdmVudC50YXJnZXQ7XG5cbiAgICAgICAgICAgICAgLy8gSGFuZGxlIGNoZWNrZWQgc3RhdGVcbiAgICAgICAgICAgICAgaWYgKGNoZWNrZWQpIHtcbiAgICAgICAgICAgICAgICBmaWVsZC5mb3JtLmdldChTZWFyY2hGaWx0ZXJzLk9OTFlfREVWSUNFUykuc2V0VmFsdWUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgZmllbGQuZm9ybS5nZXQoU2VhcmNoRmlsdGVycy5PTkxZX0dST1VQU19BTkRfQVNTRVRTKS5zZXRWYWx1ZSh0cnVlKTtcblxuICAgICAgICAgICAgICAgIC8vIEVtaXQgbmV3IHN0YXRlXG4gICAgICAgICAgICAgICAgYXNzZXRTZWFyY2hTZXJ2aWNlLmFwcGxpZWRGaWx0ZXJzJC5uZXh0KHtcbiAgICAgICAgICAgICAgICAgIFtTZWFyY2hGaWx0ZXJzLkFMTF9GSUxURVJTXTogY2hlY2tlZCxcbiAgICAgICAgICAgICAgICAgIFtTZWFyY2hGaWx0ZXJzLk9OTFlfREVWSUNFU106IHRydWUsXG4gICAgICAgICAgICAgICAgICBbU2VhcmNoRmlsdGVycy5PTkxZX0dST1VQU19BTkRfQVNTRVRTXTogdHJ1ZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSxcbiAgICAgICAgICBleHByZXNzaW9uUHJvcGVydGllczoge1xuICAgICAgICAgICAgJ3RlbXBsYXRlT3B0aW9ucy5pbmRldGVybWluYXRlJzogKFxuICAgICAgICAgICAgICBtb2RlbDogYW55LFxuICAgICAgICAgICAgICBmb3JtU3RhdGU6IGFueSxcbiAgICAgICAgICAgICAgZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnXG4gICAgICAgICAgICApID0+IHtcbiAgICAgICAgICAgICAgLy8gRG8gbm90aGluZ1xuICAgICAgICAgICAgICBpZiAoZmllbGQuZm9ybS5nZXQoU2VhcmNoRmlsdGVycy5BTExfRklMVEVSUykudmFsdWUgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgLy8gU2V0IGluZGV0ZXJtaW5hdGUgc3RhdGVcbiAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICFmaWVsZC5mb3JtLmdldChTZWFyY2hGaWx0ZXJzLk9OTFlfREVWSUNFUykudmFsdWUgfHxcbiAgICAgICAgICAgICAgICAhZmllbGQuZm9ybS5nZXQoU2VhcmNoRmlsdGVycy5PTkxZX0dST1VQU19BTkRfQVNTRVRTKS52YWx1ZVxuICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICBmaWVsZC5mb3JtLmdldChTZWFyY2hGaWx0ZXJzLkFMTF9GSUxURVJTKS5zZXRWYWx1ZShudWxsKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ3RlbXBsYXRlT3B0aW9ucy5kaXNhYmxlZCc6IChtb2RlbDogYW55LCBmb3JtU3RhdGU6IGFueSwgZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChmaWVsZC5mb3JtLmdldChTZWFyY2hGaWx0ZXJzLkFMTF9GSUxURVJTKS52YWx1ZSA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9LFxuICAgICAgICAgIGhvb2tzOiB7XG4gICAgICAgICAgICBvbkluaXQ6IGZpZWxkID0+IHtcbiAgICAgICAgICAgICAgLy8gR2V0IGluaXRpYWwgc3RhdGVcbiAgICAgICAgICAgICAgY29uc3QgeyBhbGxGaWx0ZXJzIH0gPSBhc3NldFNlYXJjaFNlcnZpY2U/LmFwcGxpZWRGaWx0ZXJzJD8udmFsdWU7XG4gICAgICAgICAgICAgIGZpZWxkLmZvcm1Db250cm9sLnNldFZhbHVlKGFsbEZpbHRlcnMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGtleTogU2VhcmNoRmlsdGVycy5PTkxZX0RFVklDRVMsXG4gICAgICAgICAgdHlwZTogJ2NoZWNrYm94JyxcbiAgICAgICAgICBoaWRlOiBoaWRlRXh0ZW5kZWRGaWx0ZXJzLFxuICAgICAgICAgIHRlbXBsYXRlT3B0aW9uczoge1xuICAgICAgICAgICAgaW5kZXRlcm1pbmF0ZTogZmFsc2UsXG4gICAgICAgICAgICBsYWJlbDogZ2V0dGV4dCgnU2hvdyBvbmx5IGRldmljZXMnKSxcbiAgICAgICAgICAgIGNsaWNrOiAoZmllbGQsIGNsaWNrRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgY29uc3Qgb2xkRmlsdGVyVmFsdWUgPSBhc3NldFNlYXJjaFNlcnZpY2UuYXBwbGllZEZpbHRlcnMkLnZhbHVlO1xuICAgICAgICAgICAgICBjb25zdCB7IGNoZWNrZWQgfSA9IGNsaWNrRXZlbnQudGFyZ2V0O1xuXG4gICAgICAgICAgICAgIC8vIEhhbmRsZSBjaGVja2VkIHN0YXRlXG4gICAgICAgICAgICAgIGlmIChjaGVja2VkKSB7XG4gICAgICAgICAgICAgICAgZmllbGQuZm9ybS5nZXQoU2VhcmNoRmlsdGVycy5BTExfRklMVEVSUykuc2V0VmFsdWUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgLy8gRW1pdCBuZXcgc3RhdGVcbiAgICAgICAgICAgICAgICBhc3NldFNlYXJjaFNlcnZpY2UuYXBwbGllZEZpbHRlcnMkLm5leHQoe1xuICAgICAgICAgICAgICAgICAgLi4ub2xkRmlsdGVyVmFsdWUsXG4gICAgICAgICAgICAgICAgICBbU2VhcmNoRmlsdGVycy5BTExfRklMVEVSU106IHRydWUsXG4gICAgICAgICAgICAgICAgICBbU2VhcmNoRmlsdGVycy5PTkxZX0RFVklDRVNdOiBjaGVja2VkXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIC8vIEhhbmRsZSB1bmNoZWNrZWQgc3RhdGVcbiAgICAgICAgICAgICAgZmllbGQuZm9ybS5nZXQoU2VhcmNoRmlsdGVycy5BTExfRklMVEVSUykuc2V0VmFsdWUobnVsbCk7IC8vIFRyaWdnZXIgaW5kZXRlcm1pbmF0ZSBzdGF0ZVxuICAgICAgICAgICAgICBmaWVsZC5mb3JtLmdldChTZWFyY2hGaWx0ZXJzLk9OTFlfR1JPVVBTX0FORF9BU1NFVFMpLnNldFZhbHVlKHRydWUpO1xuXG4gICAgICAgICAgICAgIC8vIEVtaXQgbmV3IHN0YXRlXG4gICAgICAgICAgICAgIGFzc2V0U2VhcmNoU2VydmljZS5hcHBsaWVkRmlsdGVycyQubmV4dCh7XG4gICAgICAgICAgICAgICAgW1NlYXJjaEZpbHRlcnMuQUxMX0ZJTFRFUlNdOiBudWxsLFxuICAgICAgICAgICAgICAgIFtTZWFyY2hGaWx0ZXJzLk9OTFlfR1JPVVBTX0FORF9BU1NFVFNdOiB0cnVlLFxuICAgICAgICAgICAgICAgIFtTZWFyY2hGaWx0ZXJzLk9OTFlfREVWSUNFU106IGNoZWNrZWRcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSxcbiAgICAgICAgICBob29rczoge1xuICAgICAgICAgICAgb25Jbml0OiBmaWVsZCA9PiB7XG4gICAgICAgICAgICAgIC8vIEdldCBpbml0aWFsIHN0YXRlXG4gICAgICAgICAgICAgIGNvbnN0IHsgb25seURldmljZXMgfSA9IGFzc2V0U2VhcmNoU2VydmljZT8uYXBwbGllZEZpbHRlcnMkPy52YWx1ZTtcbiAgICAgICAgICAgICAgZmllbGQuZm9ybUNvbnRyb2wuc2V0VmFsdWUob25seURldmljZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGtleTogU2VhcmNoRmlsdGVycy5PTkxZX0dST1VQU19BTkRfQVNTRVRTLFxuICAgICAgICAgIHR5cGU6ICdjaGVja2JveCcsXG4gICAgICAgICAgaGlkZTogaGlkZUV4dGVuZGVkRmlsdGVycyxcbiAgICAgICAgICB0ZW1wbGF0ZU9wdGlvbnM6IHtcbiAgICAgICAgICAgIGluZGV0ZXJtaW5hdGU6IGZhbHNlLFxuICAgICAgICAgICAgbGFiZWw6IGdldHRleHQoJ1Nob3cgb25seSBncm91cHMgYW5kIGFzc2V0cycpLFxuICAgICAgICAgICAgY2xpY2s6IChmaWVsZCwgY2xpY2tFdmVudCkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBvbGRGaWx0ZXJWYWx1ZSA9IGFzc2V0U2VhcmNoU2VydmljZS5hcHBsaWVkRmlsdGVycyQudmFsdWU7XG4gICAgICAgICAgICAgIGNvbnN0IHsgY2hlY2tlZCB9ID0gY2xpY2tFdmVudC50YXJnZXQ7XG5cbiAgICAgICAgICAgICAgLy8gSGFuZGxlIGNoZWNrZWQgc3RhdGVcbiAgICAgICAgICAgICAgaWYgKGNoZWNrZWQpIHtcbiAgICAgICAgICAgICAgICBmaWVsZC5mb3JtLmdldChTZWFyY2hGaWx0ZXJzLkFMTF9GSUxURVJTKS5zZXRWYWx1ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICAvLyBFbWl0IG5ldyBzdGF0ZVxuICAgICAgICAgICAgICAgIGFzc2V0U2VhcmNoU2VydmljZS5hcHBsaWVkRmlsdGVycyQubmV4dCh7XG4gICAgICAgICAgICAgICAgICAuLi5vbGRGaWx0ZXJWYWx1ZSxcbiAgICAgICAgICAgICAgICAgIFtTZWFyY2hGaWx0ZXJzLkFMTF9GSUxURVJTXTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIFtTZWFyY2hGaWx0ZXJzLk9OTFlfR1JPVVBTX0FORF9BU1NFVFNdOiBjaGVja2VkXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIC8vIEhhbmRsZSB1bmNoZWNrZWQgc3RhdGVcbiAgICAgICAgICAgICAgZmllbGQuZm9ybS5nZXQoU2VhcmNoRmlsdGVycy5BTExfRklMVEVSUykuc2V0VmFsdWUobnVsbCk7IC8vIFRyaWdnZXIgaW5kZXRlcm1pbmF0ZSBzdGF0ZVxuICAgICAgICAgICAgICBmaWVsZC5mb3JtLmdldChTZWFyY2hGaWx0ZXJzLk9OTFlfREVWSUNFUykuc2V0VmFsdWUodHJ1ZSk7XG5cbiAgICAgICAgICAgICAgLy8gRW1pdCBuZXcgc3RhdGVcbiAgICAgICAgICAgICAgYXNzZXRTZWFyY2hTZXJ2aWNlLmFwcGxpZWRGaWx0ZXJzJC5uZXh0KHtcbiAgICAgICAgICAgICAgICBbU2VhcmNoRmlsdGVycy5BTExfRklMVEVSU106IG51bGwsXG4gICAgICAgICAgICAgICAgW1NlYXJjaEZpbHRlcnMuT05MWV9HUk9VUFNfQU5EX0FTU0VUU106IGNoZWNrZWQsXG4gICAgICAgICAgICAgICAgW1NlYXJjaEZpbHRlcnMuT05MWV9ERVZJQ0VTXTogdHJ1ZVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9LFxuICAgICAgICAgIGhvb2tzOiB7XG4gICAgICAgICAgICBvbkluaXQ6IGZpZWxkID0+IHtcbiAgICAgICAgICAgICAgLy8gR2V0IGluaXRpYWwgc3RhdGVcbiAgICAgICAgICAgICAgY29uc3QgeyBvbmx5R3JvdXBzQW5kQXNzZXRzIH0gPSBhc3NldFNlYXJjaFNlcnZpY2U/LmFwcGxpZWRGaWx0ZXJzJD8udmFsdWU7XG4gICAgICAgICAgICAgIGZpZWxkLmZvcm1Db250cm9sLnNldFZhbHVlKG9ubHlHcm91cHNBbmRBc3NldHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgXSxcbiAgICAgIC8qKlxuICAgICAgICogQWRkaW5nIGRldmljZXMgYW5kIGdyb3VwcyB0byBhIGZpbHRlciBpcyBhbHJlYWR5IGhhbmRsZWQgaW4ge0BsaW5rIEFzc2V0U2VhcmNoU2VydmljZSNidWlsZFNlYXJjaFF1ZXJ5fVxuICAgICAgICogKi9cbiAgICAgIGdldEZpbHRlcihtb2RlbDogYW55KTogYW55IHtcbiAgICAgICAgY29uc3QgZmlsdGVyOiBhbnkgPSB7fTtcbiAgICAgICAgY29uc3Qgb3JzID0gW107XG4gICAgICAgIGlmIChtb2RlbC50eXBlcz8ubGVuZ3RoKSB7XG4gICAgICAgICAgb3JzLnB1c2goeyB0eXBlOiB7IF9faW46IG1vZGVsLnR5cGVzIH0gfSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG9ycy5sZW5ndGgpIHtcbiAgICAgICAgICBmaWx0ZXIuX19vciA9IG9ycztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmlsdGVyO1xuICAgICAgfVxuICAgIH07XG4gIH1cbn1cbiJdfQ==